const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-3xGiZjTH.js","./grid-B-dIn7M-.js"])))=>i.map(i=>d[i]);
import{D as p,_ as M,A as O,S as q,F as j,M as B,C as V,E as G,a as W}from"./grid-B-dIn7M-.js";function P(o){try{const e=typeof globalThis<"u"&&globalThis.location?globalThis.location.href:"http://localhost",t=new URL(o,e);if(!["http:","https:"].includes(t.protocol))throw new Error(`Unsupported protocol: ${t.protocol}`);return t}catch(e){const t=new Error(`CDS.fetch: invalid URL '${o}': ${e.message}`);throw t.name="CDSUrlError",t}}const b={async fetch(o,e={}){const t=typeof o=="string"?o:o?.url||String(o),i=P(t),r={"X-CDS-Proxy":"1",Accept:"application/json"},s={method:e.method||(typeof o=="string"?"GET":void 0),...e,headers:{...r,...e.headers||{}},credentials:e.credentials??"same-origin"},n=typeof globalThis<"u"&&globalThis.__NODUS_CDS_TRANSPORT__;return typeof n=="function"?n(i.href,s):(console.warn("[CDS.fetch] No transport available; returning stub for:",i.href),Promise.resolve({ok:!0,status:200,json:async()=>({stub:!0}),text:async()=>"{}"}))},async fetchXHR(o,e={}){const t=P(o),i={...e||{},credentials:e?.credentials??"same-origin"},r=typeof globalThis<"u"&&globalThis.__NODUS_CDS_TRANSPORT__;if(typeof r=="function"){const s=await r(t.href,i),n=typeof s.text=="function"?await s.text():String(s?.responseText??"");return{status:s.status??200,responseText:n,ok:s.ok??!0}}return console.warn("[CDS.fetchXHR] No transport available; returning stub for:",t.href),{status:200,responseText:"{}",ok:!0}}};class J{#t=null;#e=null;#i=null;#r=null;#s;constructor({stateManager:e}){if(!e)throw new Error("[CrossDomainSolution] StateManager is required.");this.#s=e;const t=this.#s.managers;this.#t=t?.idManager??null,this.#e=t?.forensicLogger??null,this.#i=t?.errorHelpers??null,this.#r=t?.securityManager??null}async requestDowngrade({dataId:e,fromLevel:t,toLevel:i,justification:r}){return this.#s?.emit("cdsEvent",{type:"request_downgrade",dataId:e,fromLevel:t,toLevel:i,justification:r,ts:p.now()}),{ticketId:this.#t?.generate("cds_ticket")??`temp_${p.timestamp()}`,status:"pending"}}async requestUpgrade({dataId:e,fromLevel:t,toLevel:i,source:r}){return this.#s?.emit("cdsEvent",{type:"request_upgrade",dataId:e,fromLevel:t,toLevel:i,source:r,ts:p.now()}),{ticketId:this.#t?.generate("cds_ticket")??`temp_${p.timestamp()}`,status:"pending"}}async automatedDowngrade({logicalId:e,toLevel:t,sanitizerRules:i}){return this.#i?.tryAsync(async()=>{const r=await this.#s.loadEntity(e);if(!r)throw new Error(`Entity with logicalId ${e} not found.`);const s=this.#n(r.instance_data,i),n={...r,logical_id:e,classification_level:t,instance_data:s,id:this.#t.generate()},a=await this.#s.saveEntity(n),c=this.#r?.context??{};return this.#e?.logAuditEvent("CDS_AUTOMATED_DOWNGRADE",{logicalId:e,fromLevel:r.classification_level,toLevel:t,rulesApplied:Object.keys(i),newEntityId:a},c),{approved:!0,newEntityId:a}},{component:"CrossDomainSolution",operation:"automatedDowngrade",logicalId:e,toLevel:t})??{approved:!1,newEntityId:null}}#n(e,t){return console.log("[CDS] Applying sanitization rules:",t),{...e,sanitized_at:p.now()}}}class g{#t;#e=null;#i=null;#r=null;#s=null;#n;#a=!1;#o=[];#c=null;#h=null;#l=null;#d=!1;#g=!1;#u(){try{const t=this.#t?.managers?.policies?.getPolicy?.("security","allow_unsigned_audit_in_dev");return typeof t=="boolean"?t:typeof window<"u"&&window.location?.hostname==="localhost"}catch{return typeof window<"u"&&window.location?.hostname==="localhost"}}#y(e){!e||this.#e===e||(this.#e=e,this.#c||(this.#c=setInterval(()=>this.#w(),this.#n.flushInterval)),this.#a=!0,console.log("[ForensicLogger] Initialized and ready for audit events."),this.#w().catch(()=>{}),this.#l&&(this.#l(),this.#l=null))}#m(){this.#l||typeof this.#t?.on!="function"||(this.#l=this.#t.on("storageReady",e=>{const t=e?.instance||this.#t?.storage?.instance;t&&this.#y(t)}))}constructor({stateManager:e}){this.#t=e,this.#i=this.#t.metricsRegistry?.namespace("forensicLogger"),this.#r=this.#t.managers.errorHelpers,this.#s=this.#t.managers?.sanitizer??null;const t=e.config.forensicLoggerConfig||{};this.#n={storeName:t.storeName||"audit_events",bufferSize:t.bufferSize||100,flushInterval:t.flushInterval||5e3,remoteEndpoint:t.remoteEndpoint||null,enableRemoteSync:t.enableRemoteSync||!1,...t}}async initialize(){if(this.#a)return this;this.#s=this.#t.managers?.sanitizer??this.#s;const e=this.#t?.storage?.instance;return e?(this.#y(e),this):(this.#m(),console.warn(`[ForensicLogger] Storage not ready; buffering audit events until storageReady. (buffered=${this.#o.length})`),this)}async logAuditEvent(e,t,i={}){const r=await this.#p(e,t,i);await this.#f(r),console.log(`[ForensicLogger][Audit] ${e}`,r.payload)}async#p(e,t,i={}){const r=this.#t.managers?.securityManager,s=this.#t.signer,n=this.#S();let a=t,c=null;if(n?.cleanse)try{a=n.cleanse(t)}catch(m){this.#r?.handleError?.(m,{component:"ForensicLogger",operation:"sanitizePayload"});try{a=n.cleanse(t)}catch{a=t}}if(n?.getDeterministicHash)try{c=await n.getDeterministicHash(a??t??{})}catch(m){this.#r?.handleError?.(m,{component:"ForensicLogger",operation:"hashPayload"})}(!r||!s)&&(this.#u()?this.#d||(console.debug("[ForensicLogger] Security services not ready; proceeding with unsigned audit."),this.#d=!0):this.#g||(console.warn("[ForensicLogger] Unsigned audit blocked by policy (security.allow_unsigned_audit_in_dev = false)."),this.#g=!0));const l=i.securitySubject||r?.getSubject()||{},h=await this.#v(),d={id:crypto.randomUUID(),type:e,timestamp:p.now(),previousHash:h,userContext:{userId:l.userId,role:l.role,clearance:{level:l.level,compartments:Array.from(l.compartments||[])}},payload:a,payloadDigest:c},u={signature:null,algorithm:"unsigned",publicKey:null};if(s){const{signature:m,algorithm:H,publicKey:U}=await s.sign(d);u.signature=m,u.algorithm=H,u.publicKey=U}const y={...d,signature:u,hash:await this.#E(d,u)};return this.#h=y.hash,y}async#f(e){if(!e||!e.id||!e.type||!e.timestamp){console.warn("[ForensicLogger] Invalid event format, skipping:",e),this.#i?.increment("errors.invalidFormat");return}try{if(!e?.signature?.signature&&e?.signature?.algorithm==="unsigned"&&!this.#u()){this.#g||(console.warn("[ForensicLogger] Dropping unsigned audit event due to policy."),this.#g=!0),this.#i?.increment?.("unsignedDropped");return}}catch{}this.#o.push(e),this.#i?.increment("eventsLogged"),this.#o.length>=this.#n.bufferSize&&await this.#w(),this.#n.enableRemoteSync&&this.#n.remoteEndpoint&&this.#_(e),this.#t?.emit?.("auditEventLogged",e)}async#w(){if(this.#o.length===0||!this.#e)return;const e=[...this.#o];this.#o=[];try{await this.#e.putBulk(this.#n.storeName,e),this.#i?.increment("eventsFlushedToDB",e.length),this.#i?.set("lastFlush",new Date().toISOString()),this.#t?.emit?.("forensicLogFlushed",{count:e.length}),console.log(`[ForensicLogger] Flushed ${e.length} buffered audit events to storage.`)}catch(t){this.#r?.handleError(t,{component:"ForensicLogger",operation:"flushBuffer",userFriendlyMessage:"Failed to save audit log to local storage."}),this.#t?.emit?.("forensicLogError",{type:"flush_failed",message:t.message,error:t,events:e.map(i=>i.id)}),this.#o.unshift(...e),this.#i?.increment("errors.flushFailed")}}async#_(e){try{const t=await b.fetch(this.#n.remoteEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Remote logging failed: ${t.status} ${t.statusText}`);this.#i?.increment("eventsForwarded"),this.#t?.emit?.("forensicLogForwarded",{eventId:e.id})}catch(t){this.#r?.handleError(t,{component:"ForensicLogger",operation:"forwardToRemote",context:{eventId:e.id}}),this.#t?.emit?.("forensicLogError",{type:"remote_forward_failed",message:t.message,error:t,eventId:e.id}),this.#i?.increment("errors.remoteForwardFailed")}}async getAuditTrail(e={}){if(!this.#a||!this.#e)return console.warn("[ForensicLogger] Database not ready, returning in-memory buffer."),this.#b([...this.#o],e);try{if(e.type){const i=await this.#e.queryByIndex(this.#n.storeName,"type",e.type);return this.#b(i,e)}const t=await this.#e.getAll(this.#n.storeName,e);return this.#b(t,e)}catch(t){return this.#r?.handleError(t,{component:"ForensicLogger",operation:"getAuditTrail"}),this.#t?.emit?.("forensicLogError",{type:"retrieve_failed",message:t.message,error:t}),[]}}async createEnvelope(e,t,i={}){return this.#p(e,t,i)}async commitEnvelope(e){return!e||typeof e!="object"?null:(await this.#f(e),e)}static registerGlobal(e){g._globalInstance=e}static async createEnvelope(e,t,i={}){if(g._globalInstance&&typeof g._globalInstance.createEnvelope=="function")return g._globalInstance.createEnvelope(e,t,i);try{return{...{id:typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`fallback-${Date.now()}`,type:e,timestamp:p.now?p.now():new Date().toISOString(),previousHash:null,userContext:{},payload:t},signature:{signature:null,algorithm:"unsigned",publicKey:null},hash:null}}catch{return Promise.resolve({type:e,payload:t})}}static async commitEnvelope(e){if(g._globalInstance&&typeof g._globalInstance.commitEnvelope=="function")return g._globalInstance.commitEnvelope(e)}#b(e,t){let i=e;if(t.type&&(i=i.filter(r=>r.type===t.type)),t.userId&&(i=i.filter(r=>r.userId===t.userId)),t.startDate){const r=new Date(t.startDate).getTime();i=i.filter(s=>new Date(s.timestamp).getTime()>=r)}if(t.endDate){const r=new Date(t.endDate).getTime();i=i.filter(s=>new Date(s.timestamp).getTime()<=r)}return t.limit&&(i=i.slice(0,t.limit)),i}async#v(){if(this.#h)return this.#h;if(!this.#e||!this.#a)return"0".repeat(64);try{const e=await this.#e.getLast(this.#n.storeName);return this.#h=e?.hash||"0".repeat(64),this.#h}catch(e){return this.#r?.handleError(e,{component:"ForensicLogger",operation:"getPreviousLogHash"}),"0".repeat(64)}}async#E(e,t){const i=this.#t?.signer,r={...e,signature:t};if(i&&typeof i.hash=="function")return i.hash(r);const s=new TextEncoder().encode(JSON.stringify(r)),n=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(n)).map(a=>a.toString(16).padStart(2,"0")).join("")}getMetrics(){return{...this.#i?.getAllAsObject(),inMemoryBufferSize:this.#o.length,dbReady:this.#a}}async cleanup(){this.#c&&(clearInterval(this.#c),this.#c=null),this.#l&&(this.#l(),this.#l=null),await this.#w(),this.#e&&(this.#e=null),this.#a=!1,this.#o=[],console.log("[ForensicLogger] Cleaned up.")}#S(){const e=this.#t?.managers;return e?.sanitizer&&e.sanitizer!==this.#s&&(this.#s=e.sanitizer),this.#s}}class _{#t;#e=[];#i=0;#r;#s;#n;constructor(e=50,{stateManager:t,...i}={}){if(typeof e!="number"||!Number.isInteger(e)||e<=0)throw new Error("BoundedStack maxSize must be a positive integer.");this.#t=e,this.#r=t,this.#n=i.name||"unnamed",this.#r?.metricsRegistry&&(this.#s=this.#r.metricsRegistry.namespace(`stack.${this.#n}`))}push(e){const t={data:e,timestamp:p.timestamp(),id:this.#a()};for(this.#e.push(t),this.#s?.increment("pushes");this.#e.length>this.#t;){const i=this.#e.shift();this.#i++,this.#s?.increment("evictions"),this.#o(i,"capacity")}return t.id}pop(){if(this.#e.length===0)return;const e=this.#e.pop();return this.#s?.increment("pops"),e.data}peek(){if(this.#e.length!==0)return this.#e[this.#e.length-1].data}peekAt(e){if(e<0||e>=this.#e.length)return;const t=this.#e.length-1-e;return this.#e[t].data}isEmpty(){return this.#e.length===0}isFull(){return this.#e.length>=this.#t}get size(){return this.#e.length}get remainingCapacity(){return this.#t-this.#e.length}clear(){const e=this.#e.length;return this.#e=[],this.#s?.increment("clears",e),e}toArray(){return this.#e.slice().reverse().map(e=>e.data)}find(e){for(let t=this.#e.length-1;t>=0;t--){const i=this.#e[t];if(e(i.data,this.#e.length-1-t))return i.data}}filter(e){return this.#e.slice().reverse().map((t,i)=>({data:t.data,index:i})).filter(({data:t,index:i})=>e(t,i)).map(({data:t})=>t)}getMetrics(){return{size:this.#e.length,maxSize:this.#t,utilizationPercent:Math.round(this.#e.length/this.#t*100),evictionCount:this.#i,oldestItemAge:this.#e.length>0?p.timestamp()-this.#e[0].timestamp:0,newestItemAge:this.#e.length>0?p.timestamp()-this.#e[this.#e.length-1].timestamp:0}}#a(){return`stk_${crypto.randomUUID()}`}pushMultiple(e){const t=[];for(const i of e)t.push(this.push(i));return t}popMultiple(e){const t=[];for(let i=0;i<e&&!this.isEmpty();i++)t.push(this.pop());return t}trimTo(e){if(e>=this.#e.length)return 0;const t=this.#e.length-e,i=this.#e.splice(0,t);return this.#i+=i.length,i.forEach(r=>this.#o(r,"trim")),this.#s?.increment("evictions",i.length),i.length}getItemsInTimeRange(e,t){return this.#e.filter(i=>i.timestamp>=e&&i.timestamp<=t).map(i=>i.data).reverse()}removeItemsOlderThan(e){const t=p.timestamp()-e;let i=0;for(;this.#e.length>0&&this.#e[0].timestamp<t;){const r=this.#e.shift();i++,this.#i++,this.#o(r,"age"),this.#s?.increment("evictions",i)}return i}#o(e,t){const i={timestamp:p.now(),source:`stack:${this.#n}`,reason:t,item:e};if(this.#r){this.#r.emit("stack_eviction",i);const r=this.#r.managers?.forensicLogger;r&&r.logAuditEvent("STACK_ITEM_EVICTED",i)}}}function K(o,e,t){const i=o&&String(o.proxyEndpoint||"");if(!i)throw new Error("proxyEndpoint is required");if(typeof e!="function")throw new Error("createProxyTransport requires a nativeFetch function to contact the server proxy");return g.createEnvelope("PROXY_TRANSPORT_CREATED",{proxyEndpoint:i}).catch(()=>{}),t?.logAuditEvent("PROXY_TRANSPORT_CREATED",{proxyEndpoint:i}).catch(()=>{}),async function(s,n={}){const a=JSON.stringify({url:String(s),init:n});return await e(i,{method:"POST",headers:{"Content-Type":"application/json","X-CDS-Proxy":"1"},body:a,credentials:"same-origin"})}}function L(o){if(typeof o!="function")throw new Error("createDefaultTransport requires a nativeFetch function");return g.createEnvelope("CDS_TRANSPORT_CREATED",{hasNativeFetch:typeof o=="function"}).catch(()=>{}),async function(t,i={}){try{new URL(String(t),typeof globalThis<"u"&&globalThis.location?globalThis.location.href:"http://localhost")}catch(s){const n=new Error(`CDS transport: invalid URL '${t}': ${s.message}`);throw n.name="CDSTransportUrlError",n}const r={...i||{},headers:{...i&&i.headers||{},"X-CDS-Proxy":"1"}};return o(t,r)}}class Y{#t;#e;#i;#r={};#s=!1;constructor({stateManager:e}){this.#t=e.managers.policies,this.#i=e.managers.tenantPolicyService,this.#e=e.managers.cacheManager.getCache("gridPolicies",{max:10,ttl:3e4})}async registerGridPolicies(e={}){if(!this.#t){console.warn("[GridPolicyService] Cannot register policies, SystemPolicies manager not found.");return}try{const t=await M(()=>import("./grid-policies-core-OTun7-dw.js"),[],import.meta.url);if(this.#t.registerPolicyDefinitions({...t.CORE_GRID_POLICY_DEFINITIONS}),this.#t.registerPolicyValidators({...t.CORE_GRID_POLICY_VALIDATORS}),typeof this.#t.registerPolicyPresets=="function"&&t.CORE_GRID_POLICY_PRESETS)try{this.#t.registerPolicyPresets(t.CORE_GRID_POLICY_PRESETS)}catch{}if(e.includeNesting){const i=await M(()=>import("./grid-policies-nesting-D_4fmw-Y.js"),[],import.meta.url);this.#t.registerPolicyDefinitions({...i.NESTING_POLICY_DEFINITIONS}),this.#t.registerPolicyValidators({...i.NESTING_POLICY_VALIDATORS}),this.#s=!0}await this.#n(e)}catch(t){console.warn("[GridPolicyService] Failed to load policy modules:",t)}}async ensureNestingPoliciesLoaded(){this.#s||await this.registerGridPolicies({includeNesting:!0})}async#n(e){try{if(!this.#i?.getPolicy)return;const t=[["system","grid_performance_mode"],["system","grid_auto_save_layouts"],["system","grid_save_feedback"],["system","grid_ai_suggestions"],["grid","default_columns"],["grid","default_min_w"],["grid","default_min_h"],["grid","default_max_w"],["grid","default_max_h"],["grid","allowed_component_types"],["grid","nudging_enabled"],["grid","nudging_max_radius"],["grid","nudging_prefer"],["grid","nudging_tooltip_enabled"],["grid","nudging_tooltip_duration"],["grid","nudging_power_mode"],["grid","nudging_power_max_radius"]];e.includeNesting&&t.push(["grid","nesting_enabled"],["grid","nesting_max_depth"],["grid","nesting_max_blocks_per_grid"],["grid","nesting_max_total_blocks"]);for(const[i,r]of t)try{const s=await this.#i.getPolicy(i,r);s!==void 0&&(this.#r[`${i}.${r}`]=s)}catch{}}catch{}}#a(e,t,i){const r=this.#r?.[`${e}.${t}`];return r!==void 0?r:i}getPerformanceMode(){try{const e=this.#t.getPolicy("system","grid_performance_mode");return this.#a("system","grid_performance_mode",e)}catch(e){return console.warn("Could not get grid performance policy:",e),null}}isAutoSaveEnabled(){try{const e=this.#t.getPolicy("system","grid_auto_save_layouts");return this.#a("system","grid_auto_save_layouts",e)??!0}catch(e){return console.warn("Could not get grid auto-save policy:",e),!0}}shouldShowSaveFeedback(){try{const e=this.#t.getPolicy("system","grid_save_feedback");return this.#a("system","grid_save_feedback",e)??!0}catch(e){return console.warn("Could not get grid save feedback policy:",e),!0}}isAiSuggestionsEnabled(){try{const e=this.#t.getPolicy("system","grid_ai_suggestions");return this.#a("system","grid_ai_suggestions",e)??!1}catch(e){return console.warn("Could not get grid AI suggestions policy:",e),!1}}async setPerformanceMode(e){try{return await this.#t.setPolicy("system","grid_performance_mode",e),this.clearCache(),!0}catch(t){return console.error("Failed to set grid performance mode:",t),!1}}getGridPolicies(){const e="grid_policies",t=this.#e.get(e);if(t)return t;try{const i={performanceMode:this.getPerformanceMode(),autoSave:this.isAutoSaveEnabled(),saveFeedback:this.shouldShowSaveFeedback(),aiSuggestions:this.isAiSuggestionsEnabled(),nudging:this.getNudgingConfig()};return this.#e.set(e,i),i}catch(i){return console.warn("Could not get grid policies:",i),{performanceMode:null,autoSave:!0,saveFeedback:!0,aiSuggestions:!1,nudging:{enabled:!0,maxRadius:3,prefer:["right","down","left","up"],tooltipEnabled:!0,tooltipDuration:1200,powerMode:!1,powerMaxRadius:8}}}}getNudgingConfig(){try{const e=this.#t.getPolicy("grid","nudging_enabled"),t=this.#a("grid","nudging_enabled",e),i=this.#t.getPolicy("grid","nudging_max_radius"),r=Number.isFinite(Number(i))?Math.max(0,Number(i)):3,s=this.#a("grid","nudging_max_radius",r),n=this.#a("grid","nudging_prefer",this.#t.getPolicy("grid","nudging_prefer")||["right","down","left","up"]),a=this.#a("grid","nudging_tooltip_enabled",this.#t.getPolicy("grid","nudging_tooltip_enabled")),c=this.#t.getPolicy("grid","nudging_tooltip_duration"),l=Number.isFinite(Number(c))?Math.max(200,Number(c)):1200,h=this.#a("grid","nudging_tooltip_duration",l),d=this.#a("grid","nudging_power_mode",this.#t.getPolicy("grid","nudging_power_mode")),u=this.#t.getPolicy("grid","nudging_power_max_radius"),y=Number.isFinite(Number(u))?Math.max(s,Number(u)):8,m=this.#a("grid","nudging_power_max_radius",y);return{enabled:t!==!1,maxRadius:Number(s),prefer:Array.isArray(n)?n:["right","down","left","up"],tooltipEnabled:a!==!1,tooltipDuration:Number(h),powerMode:d===!0,powerMaxRadius:Number(m)}}catch(e){return console.warn("[GridPolicyService] could not read nudging config",e),{enabled:!0,maxRadius:3,prefer:["right","down","left","up"],tooltipEnabled:!0,tooltipDuration:1200,powerMode:!1,powerMaxRadius:8}}}clearCache(){this.#e.clear()}async setTenantPolicy(e,t,i){if(!this.#i?.setPolicy)throw new Error("Tenant policy service unavailable");const r=await this.#i.setPolicy(e,t,i);return r&&(this.#r[`${e}.${t}`]=i,this.clearCache()),r}}class f{#t=null;#e=null;#i;#r;#s;#n;#a;#o;#c;#h;#l;#d;#g;#u;#y;#m;#p;#f;#w;#_;#b;#v;#E;#S;#R;#M;constructor({stateManager:e,...t}={}){this.#t=e||null;const r=this.#t?.managers?.securityManager?.getSubject()||{};this.#e=this.#t?.managers.policies||null,this.#i=t.viewport||this.#A(),this.#r=t.theme||"dark",this.#s=t.locale||"en",this.#n=t.inputMethod||this.#x(),this.#a=r.userId||null,this.#o=r.role||"guest",this.#c=r.permissions||[],this.#h=t.device||this.#C(),this.#l=t.networkLatency||null,this.#d=t.componentId||null,this.#g=t.data||{},this.#u=t.config||{},this.#y=t.containerWidth||window.innerWidth,this.#m=t.containerHeight||window.innerHeight,this.#p=this.#y*this.#m,this.#f=t.intent||null,this.#w=t.purpose||null,this.#_=t.entityType||null,this.#b=t.entityId||null,this.#v=t.entity||null,this.#E=t.uiContext||{},this.#S=t.adaptationName||null,this.#R=Date.now(),this.#M=t.priority||0}get viewport(){return this.#i}get theme(){return this.#r}get locale(){return this.#s}get inputMethod(){return this.#n}get userId(){return this.#a}get userRole(){return this.#o}get userPermissions(){return this.#c}get device(){return this.#h}get networkLatency(){return this.#l}get componentId(){return this.#d}get data(){return this.#g}get config(){return this.#u}get containerWidth(){return this.#y}get containerHeight(){return this.#m}get containerArea(){return this.#p}get intent(){return this.#f}get purpose(){return this.#w}get entityType(){return this.#_}get entityId(){return this.#b}get entity(){return this.#v}get uiContext(){return this.#E}get adaptationName(){return this.#S}get timestamp(){return this.#R}get priority(){return this.#M}getEntity(e){return this.#t?.clientState.entities.get(e)||this.#E.entities?.find?.(t=>t.id===e)||null}extend(e={}){return new f({...this.toObject(),stateManager:this.#t,...e})}toObject(){return{viewport:this.#i,theme:this.#r,locale:this.#s,inputMethod:this.#n,userId:this.#a,userRole:this.#o,userPermissions:this.#c,device:this.#h,networkLatency:this.#l,componentId:this.#d,data:this.#g,config:this.#u,containerWidth:this.#y,containerHeight:this.#m,containerArea:this.#p,intent:this.#f,purpose:this.#w,entityType:this.#_,entityId:this.#b,entity:this.#v,adaptationName:this.#S,timestamp:this.#R,uiContext:this.#E,priority:this.#M}}#A(){return{width:window.innerWidth,height:window.innerHeight,pixelRatio:window.devicePixelRatio||1,orientation:window.screen?.orientation?.type||"unknown"}}#x(){return"ontouchstart"in window||navigator.maxTouchPoints>0?"touch":"mouse"}#C(){return{hasTouch:"ontouchstart"in window,hasHover:window.matchMedia("(hover: hover)").matches,reducedMotion:window.matchMedia("(prefers-reduced-motion: reduce)").matches,highContrast:window.matchMedia("(prefers-contrast: high)").matches,darkMode:window.matchMedia("(prefers-color-scheme: dark)").matches,connectionType:navigator.connection?.effectiveType||"unknown",memoryLimit:navigator.deviceMemory||null,concurrency:navigator.hardwareConcurrency||1}}validate(e=[]){const t=[];for(const i of e)(this[i]===void 0||this[i]===null)&&t.push(i);return{valid:t.length===0,missing:t}}hasPermission(e){return this.#c.includes(e)||this.#o==="super_admin"}canAccessDomain(e){if(!this.#e)return!1;if(this.#e.getPolicy("access_control",`domain.${e}`)===!0)return!0;const i=this.#e.getPolicy("roles",`${this.#o}.domains`);return Array.isArray(i)&&i.includes(e)}evaluatePolicy(e){return this.#e?this.#e.getPolicy("access_control",e,this)===!0:(console.warn("[RenderContext] SystemPolicies manager not available. Defaulting to deny."),!1)}getThemeVariables(){const e={dark:{"--surface":"#1e1e1e","--surface-elevated":"#2d2d2d","--text":"#f5f5f5","--text-muted":"#b0b0b0","--primary":"#007acc","--secondary":"#6c757d","--success":"#28a745","--warning":"#ffc107","--error":"#dc3545","--border":"#404040"},light:{"--surface":"#ffffff","--surface-elevated":"#f8f9fa","--text":"#212529","--text-muted":"#6c757d","--primary":"#007acc","--secondary":"#6c757d","--success":"#28a745","--warning":"#ffc107","--error":"#dc3545","--border":"#dee2e6"}};return e[this.theme]||e.dark}applyTheme(){const e=this.getThemeVariables(),t=document.documentElement;Object.entries(e).forEach(([i,r])=>{t?.style.setProperty(i,r)})}getBreakpoints(){return{xs:0,sm:576,md:768,lg:992,xl:1200,xxl:1400}}getCurrentBreakpoint(){const e=this.getBreakpoints(),t=this.#y;return t>=e.xxl?"xxl":t>=e.xl?"xl":t>=e.lg?"lg":t>=e.md?"md":t>=e.sm?"sm":"xs"}matches(e){return T.matches(e,this)}}class T{static matches(e,t){if(!e)return!0;const i=t instanceof f?t:new f({stateManager:null,...t});if(e.containerWidth&&(e.containerWidth.min&&i.containerWidth<e.containerWidth.min||e.containerWidth.max&&i.containerWidth>e.containerWidth.max)||e.containerHeight&&(e.containerHeight.min&&i.containerHeight<e.containerHeight.min||e.containerHeight.max&&i.containerHeight>e.containerHeight.max)||e.containerArea&&(e.containerArea.min&&i.containerArea<e.containerArea.min||e.containerArea.max&&i.containerArea>e.containerArea.max)||e.purpose&&i.purpose!==e.purpose||e.intent&&i.intent!==e.intent||e.hasTouch!==void 0&&i.device.hasTouch!==e.hasTouch||e.hasHover!==void 0&&i.device.hasHover!==e.hasHover||e.theme&&i.theme!==e.theme||e.userRole&&i.userRole!==e.userRole||e.permission&&!i.hasPermission(e.permission))return!1;if(e.breakpoint){const r=i.getCurrentBreakpoint();if(Array.isArray(e.breakpoint)){if(!e.breakpoint.includes(r))return!1}else if(r!==e.breakpoint)return!1}return!(e.entityType&&i.entityType!==e.entityType)}static findBestMatch(e,t){if(!e||typeof e!="object")return null;let i=null,r=-1;for(const[s,n]of Object.entries(e))if(this.matches(n.trigger,t)){const a=this.calculateMatchScore(n.trigger,t);a>r&&(r=a,i={name:s,...n})}return i}static calculateMatchScore(e,t){if(!e)return 1;let i=0;return e.containerWidth&&(i+=10),e.containerHeight&&(i+=10),e.containerArea&&(i+=15),e.purpose&&(i+=20),e.intent&&(i+=20),e.entityType&&(i+=25),e.userRole&&(i+=15),e.permission&&(i+=30),e.breakpoint&&(i+=10),e.theme&&(i+=5),i}}class X{#t;#e;#i;constructor({stateManager:e}){this.#t=e.managers.componentRegistry,this.#e=e.metricsRegistry?.namespace("buildingBlockRenderer"),this.#i=e.managers.errorHelpers}render(e,t={}){return this.#i.tryOr(()=>(this.#e?.increment("compositionsRendered"),typeof e=="string"?this.#r(e,t):Array.isArray(e)?this.#s(e,t):e?.layout?this.#n(e,t):this.#a(e,t)),i=>(this.#e?.increment("renderErrors"),this.#p(`Composition failed: ${i.message}`)))}#r(e,t={}){const i=this.#t?.get(e);return i?this.#i.tryOr(()=>{const r=new f({stateManager:this.#t?.stateManager,...t,blockId:e,config:{...i.config,...t.config}});return typeof i.render=="function"?i.render(r):typeof i.render=="string"?this.#y(i.render,r):this.#p(`Invalid render method for ${e}`)},r=>(console.error(`Error rendering block ${e}:`,r),this.#p(`Render error: ${r.message}`))):this.#p(`Block not found: ${e}`)}#s(e,t={}){const i=document.createElement("div");return i.className="block-sequence",e.forEach((r,s)=>{const n={...t,sequenceIndex:s,sequenceLength:e.length};let a;typeof r=="string"?a=this.#r(r,n):a=this.render(r,n),a&&i.appendChild(a)}),i}#n(e,t={}){const{layout:i,blocks:r=[],config:s={}}=e,n=document.createElement("div");return n.className=`layout-${i}`,this.#o(n,i,s),r.forEach((a,c)=>{const l=this.render(a,{...t,layoutIndex:c,layoutType:i});l&&(a.position&&this.#u(l,a.position),n.appendChild(l))}),n}#a(e,t={}){const{type:i="div",className:r="",style:s={},children:n=[],events:a={},...c}=e;if(i==="button"){const h=this.#c(c,t);return Object.entries(a).forEach(([d,u])=>{typeof u=="function"&&h.addEventListener(d,u)}),n.forEach(d=>{const u=this.render(d,t);u&&h.appendChild(u)}),h}if(i==="input"||i==="text-field"){const h=this.#h(c,t);return Object.entries(a).forEach(([d,u])=>{typeof u=="function"&&h.addEventListener(d,u)}),h}if(i==="textarea"||i==="text-area"){const h=this.#l(c,t);return Object.entries(a).forEach(([d,u])=>{typeof u=="function"&&h.addEventListener(d,u)}),h}if(i==="label"||i==="span"){const h=this.#d(c,t);return Object.entries(a).forEach(([d,u])=>{typeof u=="function"&&h.addEventListener(d,u)}),h}if(i==="container"){const h=this.#g(c,t);return Object.entries(a).forEach(([d,u])=>{typeof u=="function"&&h.addEventListener(d,u)}),h}const l=document.createElement(i);r&&(l.className=r),Object.assign(l.style,s);try{c.bindingPath&&(l.dataset.bind=c.bindingPath),c.actionName&&(l.dataset.action=c.actionName),c.entityId&&(l.dataset.entity=c.entityId)}catch{}Object.entries(c).forEach(([h,d])=>{h!=="type"&&h!=="children"&&(l[h]=d)}),Object.entries(a).forEach(([h,d])=>{l.addEventListener(h,d)}),n.forEach(h=>{const d=this.render(h,t);d&&l.appendChild(d)});try{this.#t?.stateManager?.managers?.bindEngine?.register?.(l)}catch{}return l}#o(e,t,i){const s={grid:{display:"grid",gridTemplateColumns:`repeat(${i.columns||12}, 1fr)`,gap:`${i.gap||16}px`},flex:{display:"flex",flexDirection:i.direction||"row",gap:`${i.gap||16}px`},stack:{display:"flex",flexDirection:"column",gap:`${i.gap||8}px`},absolute:{position:"relative"}}[t]||{};Object.assign(e.style,s,i.style||{})}#c(e={},t={}){const i=document.createElement("button");i.type=e.type||"button",i.className=e.className||e.props?.className||"btn",i.textContent=e.textContent||e.props?.label||e.props?.text||"",Object.assign(i.style,e.style||e.props?.style||{});try{e.actionName&&(i.dataset.action=e.actionName),e.entityId&&(i.dataset.entity=e.entityId),e.props?.actionName&&(i.dataset.action=e.props.actionName),e.props?.entityId&&(i.dataset.entity=e.props.entityId)}catch{}try{this.#t?.stateManager?.managers?.bindEngine?.register?.(i)}catch{}return i}#h(e={},t={}){const i=document.createElement("input");i.type=e.inputType||e.type||"text",i.className=e.className||e.props?.className||"text-field",i.placeholder=e.placeholder||e.props?.placeholder||"",Object.assign(i.style,e.style||e.props?.style||{});try{const r=e.bindingPath||e.props?.bindingPath||e["data-bind"];r&&(i.dataset.bind=r),this.#t?.stateManager?.managers?.bindEngine?.register?.(i)}catch{}return i}#l(e={},t={}){const i=document.createElement("textarea");i.rows=e.rows||e.props?.rows||4,i.className=e.className||e.props?.className||"text-area",i.placeholder=e.placeholder||e.props?.placeholder||"",Object.assign(i.style,e.style||e.props?.style||{});try{const r=e.bindingPath||e.props?.bindingPath||e["data-bind"];r&&(i.dataset.bind=r),this.#t?.stateManager?.managers?.bindEngine?.register?.(i)}catch{}return i}#d(e={},t={}){const i=document.createElement("span");i.className=e.className||e.props?.className||"label",Object.assign(i.style,e.style||e.props?.style||{}),e.textContent?i.textContent=e.textContent:e.props?.text&&(i.textContent=e.props.text);try{const r=e.bindingPath||e.props?.bindingPath||e["data-bind"];r&&(i.dataset.bind=r),this.#t?.stateManager?.managers?.bindEngine?.register?.(i)}catch{}return i}#g(e={},t={}){const i=document.createElement("div");i.className=e.className||e.props?.className||"container";const r=e.layoutDirection||e.props?.layoutDirection||"column";return Object.assign(i.style,e.style||e.props?.style||{}),i.style.display="flex",i.style.flexDirection=r==="row"?"row":"column",Array.isArray(e.children)&&e.children.forEach(s=>{const n=this.render(s,t);n&&i.appendChild(n)}),i}#u(e,t){t.grid&&(e.style.gridColumn=`${t.grid.column} / span ${t.grid.width||1}`,e.style.gridRow=`${t.grid.row} / span ${t.grid.height||1}`),t.absolute&&(e.style.position="absolute",t.absolute.top!==void 0&&(e.style.top=`${t.absolute.top}px`),t.absolute.left!==void 0&&(e.style.left=`${t.absolute.left}px`),t.absolute.right!==void 0&&(e.style.right=`${t.absolute.right}px`),t.absolute.bottom!==void 0&&(e.style.bottom=`${t.absolute.bottom}px`)),t.flex&&(e.style.flex=t.flex.grow||"1",t.flex.order!==void 0&&(e.style.order=t.flex.order))}#y(e,t){let i=e;if(i=i.replace(/\{\{(\w+(?:\.\w+)*)\}\}/g,(r,s)=>{const n=this.#m(t,s);return n!==void 0?n:""}),typeof DOMParser<"u"){const s=new DOMParser().parseFromString(i,"text/html"),n=s.body.firstChild;return s.body.children.length===1?n:s.body}else throw new Error("DOMParser is not available. Cannot render HTML template securely.")}#m(e,t){return t.split(".").reduce((i,r)=>i&&i[r]!==void 0?i[r]:void 0,e)}#p(e){g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"}).catch(()=>{});const t=document.createElement("div");return t.className="render-error",t.style.cssText=`
      padding: 8px;
      background: #fee;
      border: 1px solid #fcc;
      border-radius: 4px;
      color: #c33;
      font-size: 12px;
    `,t.textContent=e,t}getAvailableBlocks(){return this.#t?.getByCategory("building-block").map(e=>e.id)||[]}getBlockDefinition(e){return this.#t?.get(e)}}class Q{#t;#e=null;#i=null;#r=null;#s=null;#n=null;#a=null;constructor({stateManager:e}){this.#t=e,this.#e=this.#t.managers.componentRegistry,this.#i=this.#t.managers.buildingBlockRenderer,this.#r=this.#t.managers.cacheManager?.getCache("adaptations"),this.#s=this.#t.metricsRegistry?.namespace("adaptiveRenderer"),this.#n=this.#t.managers.forensicLogger,this.#a=this.#t.managers.errorHelpers,this.#n?.logAuditEvent("SYSTEM_INITIALIZATION",{component:"AdaptiveRenderer",status:"initialized"});const t=this.#s?.measure?this.#s.measure.bind(this.#s):()=>i=>i;this.render=t("render",{component:"AdaptiveRenderer"})(this.render.bind(this))}render(e,t,i={}){return this.#a?.tryOr(()=>{const r=this.#o(e);if(!r)return this.#n?.logAuditEvent("RENDER_FAILURE",{reason:"Component not found",componentId:e}),this.#l(e,t);const s=(t instanceof f?t:new f({stateManager:this.#t,...t})).extend({componentId:e,data:i}),n=this.#c(r,s);return this.#h(r,n,s)},r=>this.#d(e,r,t))}#o(e){return this.#e?.get(e)}#c(e,t){const i=`${e.id}:${t.purpose}:${t.intent}:${t.getCurrentBreakpoint()}:${t.userRole}`;if(this.#r?.has(i))return this.#s?.increment("cacheHits"),{...this.#r.get(i),cached:!0};const r=T.findBestMatch(e.adaptations,t);if(r){const n={name:r.name,...r,cached:!1};return this.#r?.set(i,n),n}const s={name:e.defaultAdaptation,...e.adaptations[e.defaultAdaptation],cached:!1};return this.#r?.set(i,s),s}#h(e,t,i){if(!this.#i)return this.#n?.logAuditEvent("RENDER_FAILURE",{reason:"BuildingBlockRenderer not available",componentId:e.id}),this.#l(e.id,i,"Renderer not available");const r=i.extend({adaptationName:t.name,config:{...e.defaultConfig,...t.render||{}}}),s=e.render[t.name]||e.render.default;return s?this.#i.render(s,r):(this.#n?.logAuditEvent("RENDER_FAILURE",{reason:`No render definition for adaptation '${t.name}'`,componentId:e.id}),this.#l(e.id,i))}#l(e,t,i="Component not found"){const r=document.createElement("div");r.className="adaptive-renderer-fallback",r.style.cssText="padding: 8px; background: #fffbe6; border: 1px solid #ffe58f; border-radius: 4px; color: #d46b08; font-size: 12px;";const s=document.createElement("div");s.className="fallback-content";const n=document.createElement("strong");n.textContent=i;const a=document.createElement("p");return a.textContent=`Component: ${e}`,s.append(n,a),r.appendChild(s),r}#d(e,t,i){const r=document.createElement("div");r.className="adaptive-renderer-error",r.style.cssText="padding: 8px; background: #fff1f0; border: 1px solid #ffccc7; border-radius: 4px; color: #cf1322; font-size: 12px;";const s=document.createElement("div");s.className="error-content";const n=document.createElement("strong");n.textContent="Render Error";const a=document.createElement("p");a.textContent=`Component: ${e}`;const c=document.createElement("p");return c.textContent=`Error: ${t.message}`,s.append(n,a,c),r.appendChild(s),r}getMetrics(){return{...this.#s?.getAllAsObject()||{},registeredComponents:this.#e?.definitions.size||0,cacheSize:this.#r?.size||0}}clearCache(){this.#r?.clear()}}class w{#t=null;constructor(e,t={}){this.#t=t.stateManager||null,this.id=e,this.name=t.name||e,this.description=t.description||"",this.category=t.category||"general",this.version=t.version||"1.0.0",this.adaptations=t.adaptations||{},this.defaultAdaptation=t.defaultAdaptation||"standard",this.render=t.render||{},this.supportedEntityTypes=t.supportedEntityTypes||[],this.requiredPermissions=t.requiredPermissions||[],this.dependencies=t.dependencies||[],this.configSchema=t.configSchema||{},this.defaultConfig=t.defaultConfig||{},this.hooks=t.hooks||{},this.metadata=t.metadata||{}}canRender(e){return this.supportedEntityTypes.length===0?!0:(Array.isArray(e)?e:[e]).some(i=>this.supportedEntityTypes.includes(i)||this.supportedEntityTypes.includes("*"))}hasPermissions(e=[]){if(this.requiredPermissions.length===0)return!0;const t=this.#t?.managers?.securityManager;if(t){const i=t.getSubject();return this.requiredPermissions.every(r=>i.permissions.includes(r))}return this.requiredPermissions.every(i=>e.includes(i))}getAdaptation(e){this.#t||console.warn(`[ComponentDefinition] stateManager not available for component '${this.id}'. Adaptation selection may be inaccurate.`);const t=e instanceof f?e:new f({stateManager:this.#t,...e}),i=T.findBestMatch(this.adaptations,t);return i||{name:this.defaultAdaptation,...this.adaptations[this.defaultAdaptation]}}validateConfig(e){const t=[];for(const[i,r]of Object.entries(this.configSchema))if(r.required&&!(i in e)&&t.push(`Missing required config: ${i}`),i in e){const s=e[i];r.type&&typeof s!==r.type&&t.push(`Config ${i} must be of type ${r.type}`),r.enum&&!r.enum.includes(s)&&t.push(`Config ${i} must be one of: ${r.enum.join(", ")}`)}return{valid:t.length===0,errors:t}}mergeConfig(e={}){return{...this.defaultConfig,...e}}toEntity(){return{domain:"ui",type:"component_definition",data:{id:this.id,name:this.name,description:this.description,category:this.category,version:this.version,adaptations:this.adaptations,defaultAdaptation:this.defaultAdaptation,supportedEntityTypes:this.supportedEntityTypes,requiredPermissions:this.requiredPermissions,dependencies:this.dependencies,configSchema:this.configSchema,defaultConfig:this.defaultConfig,metadata:this.metadata}}}static fromEntity(e){if(e.domain!=="ui"||e.type!=="component_definition")throw new Error("Invalid entity for ComponentDefinition");return new w(e.data.id,e.data)}clone(e={}){const t={name:this.name,description:this.description,category:this.category,version:this.version,adaptations:{...this.adaptations},defaultAdaptation:this.defaultAdaptation,render:{...this.render},supportedEntityTypes:[...this.supportedEntityTypes],requiredPermissions:[...this.requiredPermissions],dependencies:[...this.dependencies],configSchema:{...this.configSchema},defaultConfig:{...this.defaultConfig},hooks:{...this.hooks},metadata:{...this.metadata},...e};return new w(`${this.id}_clone`,t)}}class Z{#t;#e=null;#i=new Map;#r=new Set;constructor({stateManager:e}){this.#t=e,this.#e=this.#t.metricsRegistry?.namespace("componentRegistry")}register(e){if(!(e instanceof w)){const t={...e,stateManager:this.#t};e=new w(e.id,t)}return this.#t?.emit?.("component:beforeRegister",{definition:e}),this.#i.set(e.id,e),this.#r.add(e.category),this.#e?.increment("registered"),this.#t?.emit?.("component:afterRegister",{definition:e}),e}get(e){return this.#i.get(e)}getByCategory(e){return Array.from(this.#i.values()).filter(t=>t.category===e)}getForEntityTypes(e){return Array.from(this.#i.values()).filter(t=>t.canRender(e))}getForUser(e=[]){const t=this.#t?.managers?.securityManager?.getSubject();return Array.from(this.#i.values()).filter(i=>i.hasPermissions(t?.permissions||e))}search(e){const t=e.toLowerCase();return Array.from(this.#i.values()).filter(i=>i.name.toLowerCase().includes(t)||i.description.toLowerCase().includes(t)||i.category.toLowerCase().includes(t))}unregister(e){const t=this.#i.get(e);return t?(this.#t?.emit?.("component:beforeUnregister",{definition:t}),this.#i.delete(e),this.#t?.emit?.("component:afterUnregister",{id:e,definition:t}),!0):!1}getCategories(){return Array.from(this.#r)}exportAsEntities(){return Array.from(this.#i.values()).map(e=>e.toEntity())}importFromEntities(e){const t=[];for(const i of e)try{const r=w.fromEntity(i);this.register(r),t.push(r)}catch(r){console.error("Failed to import component definition:",r)}return t}getStats(){const e=Array.from(this.#i.values());return{...this.#e.getAllAsObject(),totalDefinitions:e.length,categoryCounts:Object.fromEntries(this.getCategories().map(i=>[i,e.filter(r=>r.category===i).length])),entityTypeSupport:this.getEntityTypeSupport(e),permissionRequirements:this.getPermissionRequirements(e)}}getEntityTypeSupport(e){const t={};return e.forEach(i=>{i.supportedEntityTypes.forEach(r=>{t[r]=(t[r]||0)+1})}),t}getPermissionRequirements(e){const t={};return e.forEach(i=>{i.requiredPermissions.forEach(r=>{t[r]=(t[r]||0)+1})}),t}}class ee{#t;#e=new Map;#i=null;#r=null;constructor({stateManager:e}){this.#t=e,this.#i=this.#t.metricsRegistry?.namespace("actionHandler"),this.#r=this.#t.managers.errorHelpers}initialize(){this.#s(),console.log(`[ActionHandlerRegistry] Initialized with ${this.#e.size} built-in handlers.`)}register(e,t){this.#e.has(e)&&console.warn(`[ActionHandlerRegistry] Overwriting existing handler for action type: ${e}`),this.#e.set(e,t),this.#i?.increment("handlers.registered")}get(e){return this.#e.get(e)}#s(){this.register("log_event",async(e,t,i,r)=>{await this.#r?.tryOr(async()=>{const s=e.level||"info",n=e.message||`Event: ${t.type}`;if(({log:console.log,warn:console.warn,error:console.error,info:console.info,debug:console.debug}[s]||console.log)(`[EventFlow:${i.id}] ${n}`,t.data||""),e.audit){const l=r.managers.forensicLogger;l&&await l.logAuditEvent(`EVENT_FLOW_LOG_${s.toUpperCase()}`,{flowId:i.id,message:n,eventData:t.data})}this.#i?.increment("actions.executed.log_event")},null,{component:"ActionHandlerRegistry",operation:"log_event"})}),this.register("show_notification",async(e,t,i,r)=>{await this.#r?.tryOr(()=>{const s={type:e.template||"info",message:e.message||`Event: ${t.type}`,duration:e.duration||3e3,data:t.data};r?.emit("show_notification",s),this.#i?.increment("actions.executed.show_notification")},null,{component:"ActionHandlerRegistry",operation:"show_notification"})}),this.register("track_metric",async(e,t,i,r)=>{await this.#r?.tryOr(()=>{const s={name:e.metric,value:e.value||1};r?.metricsRegistry?.increment(s.name,s.value),this.#i?.increment("actions.executed.track_metric")},null,{component:"ActionHandlerRegistry",operation:"track_metric"})}),this.register("invalidate_cache",async(e,t,i,r)=>{await this.#r?.tryOr(()=>{const s=r?.managers?.cacheManager;if(!s)return;let n=e.pattern||"*";n=n.replace(/\{\{data\.entity\.id\}\}/g,t.data?.entity?.id??t.data?.id??""),n==="*"?(s.clearAll(),console.log(`[ActionHandlerRegistry] Cleared all caches via flow: ${i.id}`)):(s.invalidate(n),console.log(`[ActionHandlerRegistry] Invalidated cache '${n}' via flow: ${i.id}`)),this.#i?.increment("actions.executed.invalidate_cache")},null,{component:"ActionHandlerRegistry",operation:"invalidate_cache"})}),this.register("broadcast_event",async(e,t,i,r)=>{await this.#r?.tryOr(()=>{r?.emit(e.event,{...t.data,originalEvent:t.type,flow:i.id}),this.#i?.increment("actions.executed.broadcast_event")},null,{component:"ActionHandlerRegistry",operation:"broadcast_event"})}),this.register("save_entity",async(e,t,i,r)=>{await this.#r?.tryOr(async()=>{const s=e.entity||t.data?.entity;if(!s){console.warn(`[ActionHandlerRegistry] 'save_entity' action in flow ${i.id} is missing entity data.`);return}await r.saveEntity(s),this.#i?.increment("actions.executed.save_entity")},s=>{r.emit("action_execution_error",{action:e,event:t,flow:i,error:s})},{component:"ActionHandlerRegistry",operation:"save_entity"})})}cleanup(){this.#e.clear(),console.log("[ActionHandlerRegistry] Cleaned up.")}}class te{#t;#e=new Map;#i=null;#r=null;constructor({stateManager:e}){this.#t=e,this.#i=this.#t.metricsRegistry?.namespace("extensionManager"),this.#r=this.#t.managers.errorHelpers}async initialize(){await this.#r?.tryOr(()=>{console.log("[ExtensionManager] Initialized (stub)")},null,{component:"ExtensionManager",operation:"initialize"})}async discover(){return this.#r?.tryOr(()=>(console.log("[ExtensionManager] Discovery placeholder"),[]),()=>[],{component:"ExtensionManager",operation:"discover"})}registerExtension(e,t){this.#e.set(e,t),this.#i?.increment("registered"),console.log(`[ExtensionManager] Registered extension: ${e}`)}getExtension(e){return this.#e.get(e)}cleanup(){this.#e.clear(),console.log("[ExtensionManager] Cleaned up (stub).")}}class ie{#t=new Map([[/(?<!\/\/\s*)\b(eval)\s*\(/g,{message:"Use of eval() is forbidden.",severity:"critical"}],[/(?<!\/\/\s*)\bnew\s+Function\s*\(/g,{message:"Use of new Function() is forbidden.",severity:"critical"}],[/(?<!\/\/\s*)\bsetTimeout\s*\(\s*(["'`])/g,{message:"Use of setTimeout with a string argument is forbidden.",severity:"critical"}],[/\.innerHTML\s*=\s*(?![`"'])/g,{message:"Direct assignment to innerHTML with a variable is forbidden. Use textContent or a sanitization library.",severity:"warning"}]]);scan(e){const t=[],i=e.split(`
`);for(const[r,s]of this.#t.entries())for(let n=0;n<i.length;n++){const a=i[n];let c;for(;(c=r.exec(a))!==null;)t.push({...s,line:n+1,column:c.index+1,pattern:r.toString()})}return t}validate(e,t={}){const r=this.scan(e).filter(s=>s.severity==="critical");if(r.length>0){const s=r[0],n=`Security validation failed: ${s.message} (at line ${s.line}:${s.column})`,a=t.errorHelpers?.SecurityError||t.errorHelpers?.AppError||Error;throw new a(n,{category:"security_violation",severity:"critical",showToUser:!1,violations:r})}}}function re(o){return new ie().scan(o)}class v extends Error{constructor(e,{category:t="system_error",severity:i="medium",recoverable:r=!0,showToUser:s=!0,stateManager:n,...a}={}){super(e),this.name=this.constructor.name,this.id=n?.managers?.idManager?n.managers.idManager.generateSimpleId("err"):`err_${p.timestamp()}`,this.timestamp=p.now(),this.category=t,this.severity=i,this.recoverable=r,this.showToUser=s,this.context=a}}class R extends v{constructor(e,t){super(e,{category:"plugin_error",...t})}}class se{#t;#e;#i;#r;#s;#n;constructor(e){this.#t=e,this.#e=this.#t?.metricsRegistry,this.#i=this.#t?.managers?.forensicLogger,this.#r=this.#t?.managers?.securityManager,this.#s=this.#t?.managers?.cacheManager,this.#n=this.#t?.managers?.embedding}#a(e,t={}){if(e instanceof v){const r={...e,...e.context,...t};return r.userFriendlyMessage=this.#o(r),r}const i=new v("Unknown error occurred",{category:"unknown",stateManager:this.#t,...t});return e instanceof Error?(i.message=e.message,i.stack=e.stack||"No stack available",i.name=e.name,i.category=this.#m(e),i.severity=this.#p(e)):typeof e=="string"?(i.message=e,i.stack="No stack available"):typeof e=="object"&&e!==null&&(Object.assign(i,e),i.message=e.message||i.message,i.stack=e.stack||"No stack available"),i.userFriendlyMessage=this.#o(i),i}#o(e){const t=e.category,i=e.severity;return{ui_error:{high:"The interface encountered a serious problem. Please refresh the page.",medium:"There was an issue with the interface. Some features may not work properly.",low:"A minor interface issue occurred. You can continue working normally."},network_error:{high:"Unable to connect to the server. Please check your internet connection.",medium:"Connection issues detected. Some data may not be up to date.",low:"Network request failed. Please try again."},storage_error:{high:"Unable to save your data. Please ensure you have sufficient storage space.",medium:"There was an issue saving your changes. Please try again.",low:"A storage issue occurred. Your recent changes may not be saved."},policy_error:{high:"You do not have permission to perform this action.",medium:"Access restricted. Please contact an administrator.",low:"This feature is not available with your current permissions."},plugin_error:{high:"A plugin has stopped working. Some features may be unavailable.",medium:"Plugin issue detected. Functionality may be limited.",low:"A plugin encountered a minor issue."},javascript_error:{high:"A serious application error occurred. Please refresh the page.",medium:"An application error occurred. Some features may not work properly.",low:"A minor application issue occurred."},system_error:{high:"A system error occurred. Please contact support if this persists.",medium:"System issue detected. Some features may be affected.",low:"A minor system issue occurred."}}[t]?.[i]||"An unexpected error occurred. Please try again."}#c(e){const{id:t,message:i,category:r,severity:s,stack:n,component:a}=e;console.group(`âŒ [${s.toUpperCase()}] ${r} in ${a}`),console.error(`ID: ${t}`),console.error(`Message: ${i}`),console.error("Stack trace:"),console.error(n),console.groupEnd()}#h(e){if(!this.#t?.emit){console.warn("[ErrorHelpers] EventFlow not available, cannot emit error");return}try{this.#t.emit("error",e)}catch(t){console.error("[ErrorHelpers] Failed to emit error to EventFlow:",t),this.#c(e)}}async tryAsync(e,t={}){try{return await e()}catch(i){return this.handleError(i,t),null}}async captureAsync(e,t={},i=void 0){let r={};i!==void 0?r=i||{}:r=t||{};try{return await Promise.resolve(e())}catch(s){return this.handleError(s,r),null}}try(e,t={}){try{return e()}catch(i){return this.handleError(i,t),null}}handleError(e,t={}){const i=this.#a(e,t),{category:r,severity:s,component:n}=i;if(this.#c(i),this.#e&&(this.#e.increment("errors.total"),r&&this.#e.increment(`errors.by_category.${r}`),s&&this.#e.increment(`errors.by_severity.${s}`),n&&this.#e.increment(`errors.by_component.${n}`)),s==="high"&&this.#i){const a=this.#r?.getSubject()||{};this.#i.logAuditEvent("SYSTEM_ERROR_CRITICAL",this.sanitizeError(i),a)}if(r==="storage_error"&&this.#s&&(i.context.cacheMetrics=this.#s.getMetrics()),s==="high"&&this.#n){const a=`Error: ${i.message}. Category: ${r}. Component: ${n}. Stack: ${i.stack}`;this.#n.generateEmbedding(a,{errorId:i.id,type:"error_context"}).catch(c=>console.warn("Failed to generate error embedding:",c))}return this.#h(i),i.recoverable&&this.#l(i,t),i}#l(e,t={}){switch(e.category){case"ui_error":this.#d(e,t);break;case"network_error":this.#g(e,t);break;case"storage_error":this.#u(e,t);break;case"policy_error":this.#y(e,t);break;default:console.warn(`[ErrorHelpers] No recovery strategy for ${e.category}`)}}#d(e,t){if(t.component&&t.refreshComponent)try{t.refreshComponent(t.component),console.info(`[ErrorHelpers] Attempted to refresh component: ${t.component}`)}catch(i){console.warn("[ErrorHelpers] Component refresh failed:",i)}}#g(e,t){if(t.enableOfflineMode)try{t.enableOfflineMode(),console.info("[ErrorHelpers] Enabled offline mode due to network error")}catch(i){console.warn("[ErrorHelpers] Failed to enable offline mode:",i)}}#u(e,t){if(t.clearCache)try{t.clearCache(),console.info("[ErrorHelpers] Cleared cache due to storage error")}catch(i){console.warn("[ErrorHelpers] Failed to clear cache:",i)}}#y(e,t){console.info("[ErrorHelpers] Policy error - user may need different permissions")}createErrorBoundary(e="unknown",t={}){return g.createEnvelope({actorId:this.#r?.getSubject?.()?.userId||"system",action:"createErrorBoundary",target:`component:${e}`,label:"error_handling_setup",payload:{component:e,extraContext:t}}).catch(()=>{}),{try:i=>this.try(i,{component:e,...t}),tryAsync:i=>this.tryAsync(i,{component:e,...t})}}setupGlobalHandlers(){window.addEventListener("error",e=>{this.handleError(e.error||e.message,{component:"global",filename:e.filename,lineno:e.lineno,colno:e.colno})}),window.addEventListener("unhandledrejection",e=>{this.handleError(e.reason,{component:"global",type:"unhandled_promise_rejection"})}),console.log("[ErrorHelpers] Global error handlers set up")}trace(e,t,i={}){const r=performance.now();try{const s=t();if(s&&typeof s.then=="function")return s.finally(()=>this.#e?.timer(e,performance.now()-r));const n=performance.now()-r;return this.#e?.timer(e,n),s}catch(s){const n=performance.now()-r;throw this.handleError(s,{...i,operation:e,duration:n}),s}}withPerformanceTracking(e,t="operation",i={}){return async(...r)=>this.trace(t,()=>e(...r),i)}sanitizeError(e){if(!e)return null;const t={...e};return t.message&&(t.message=t.message.replace(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,"[EMAIL]").replace(/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}\b/g,"[CARD]").replace(/\b\d{3}-\d{2}-\d{4}\b/g,"[SSN]")),t.stack&&t.stack.length>2e3&&(t.stack=t.stack.substring(0,2e3)+"... [truncated]"),t}async tryOr(e,t=null,i={},r=null){try{return await Promise.resolve(e())}catch(s){return this.handleError(s,i),typeof t=="function"?t(s):t}finally{if(typeof r=="function")try{r()}catch(s){this.handleError(s,{...i,component:i.component?`${i.component}.finally`:"finally_block",originalError:i.error})}}}#m(e){const t=e.message.toLowerCase();return t.includes("network")||t.includes("failed to fetch")?"network_error":t.includes("storage")||t.includes("indexeddb")?"storage_error":t.includes("permission")||t.includes("access denied")?"policy_error":e instanceof TypeError||e instanceof ReferenceError?"javascript_error":"system_error"}#p(e){const t=e.name;return t==="TypeError"||t==="ReferenceError"||t==="InternalError"?"high":t==="RangeError"||t==="URIError"?"medium":"low"}}class ne{#t;#e=null;#i=null;#r=null;#s=null;#n=null;#a=null;#o=new Map;#c=new Map;#h=new Map;#l=new Map;#d={beforeLoad:[],afterLoad:[],beforeUnload:[],afterUnload:[],onError:[]};constructor({stateManager:e}){this.#t=e,this.#e=this.#t.metricsRegistry?.namespace("pluginSystem"),this.#i=this.#t.managers.errorHelpers,this.#r=this.#t.managers.forensicLogger,this.#s=this.#t.managers.componentRegistry,this.#n=this.#t.managers.actionHandler}async initialize(){return this.#i.tryOr(async()=>{this.#a=await this.#t.serviceRegistry.get("queryService"),!(typeof this.#a?.query=="function"||!!this.#t?.storage?.instance&&(typeof this.#t.storage.instance.query=="function"||typeof this.#t.storage.instance.getAll=="function"))&&this.#t?.on&&await new Promise(t=>{const i=this.#t.on("storageReady",()=>{try{i()}catch{}t()})}),await this.#g(),await this.#M(),console.log(`ManifestPluginSystem initialized with ${this.#o.size} plugins`)},e=>{this.#r?.logAuditEvent("PLUGIN_SYSTEM_FAILURE",{operation:"initialize",error:e.message,severity:"critical"})},{component:"ManifestPluginSystem",operation:"initialize"})}async#g(){return this.#i.tryOr(async()=>{if(!this.#a)throw new Error("QueryService is not available.");let e=[];if(typeof this.#a.query=="function")e=await this.#a.query("objects",{where:{entity_type:"plugin_manifest"}});else if(this.#t?.storage?.instance&&typeof this.#t.storage.instance.query=="function")e=(await this.#t.storage.instance.query("objects","entity_type","plugin_manifest")||[]).map(i=>({data:i}));else if(this.#t?.storage?.instance&&typeof this.#t.storage.instance.getAll=="function")e=(await this.#t.storage.instance.getAll("objects")||[]).filter(i=>i?.entity_type==="plugin_manifest").map(i=>({data:i}));else throw new Error("No storage/query API available to load plugin manifests.");for(const t of e)this.registerManifest(t.data)},e=>{this.#r?.logAuditEvent("PLUGIN_SYSTEM_FAILURE",{operation:"loadPluginManifests",error:e.message})})}registerManifest(e){const t={id:e.id||e.name,name:e.name,version:e.version||"1.0.0",description:e.description||"",author:e.author||"",components:e.components||{},dependencies:e.dependencies||{},runtime:e.runtime||{},enabled:e.enabled!==!1,autoload:e.autoload!==!1,priority:e.priority||"normal",permissions:e.permissions||[],sandbox:e.sandbox!==!1,rawManifest:e};return this.#c.set(t.id,t),this.#x(t),t}async loadPlugin(e,t={}){return this.#i.tryOr(async()=>{const i=performance.now();if(this.#o.has(e))return this.#o.get(e);if(this.#h.has(e))return await this.#h.get(e);const r=this.#c.get(e);if(!r)throw new R(`Plugin manifest not found: ${e}`);const s=this.#u(r,t);this.#h.set(e,s);const n=await s,a=performance.now()-i;return this.#k(a),this.#h.delete(e),n},i=>{throw this.#e?.increment("failedLoads"),this.#T("onError",{pluginId:e,error:i}),this.#r?.logAuditEvent("PLUGIN_LOAD_FAILURE",{pluginId:e,error:i.message}),this.#h.delete(e),i})}async#u(e,t){const i=e.id;this.#T("beforeLoad",{manifest:e,options:t}),await this.#y(e);const r=this.#m(e),s=await this.#p(e,r);await this.#_(e,s,r);const n={id:i,manifest:e,runtime:s,context:r,loadedAt:Date.now(),status:"loaded"};return this.#o.set(i,n),this.#e?.increment("pluginsLoaded"),this.#T("afterLoad",{plugin:n}),this.#r?.logAuditEvent("PLUGIN_LOAD_SUCCESS",{pluginId:i}),this.#t.emit("pluginLoaded",{pluginId:i,plugin:n}),n}async#y(e){const t=e.dependencies.plugins||[];for(const i of t)this.#o.has(i)||await this.loadPlugin(i)}#m(e){return g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"}),{pluginId:e.id,manifest:e,stateManager:this.#t,managers:this.#t.managers,registerComponent:(i,r)=>this.#b(e.id,i,r),registerAction:(i,r)=>this.#v(e.id,i,r),registerWidget:(i,r)=>this.#E(e.id,i,r),registerFieldRenderer:(i,r)=>this.#S(e.id,i,r),registerCommandHandler:(i,r)=>this.#R(e.id,i,r),emit:(i,r)=>this.#t.emit?.(`plugin:${e.id}:${i}`,r),log:(i,r,s)=>{({log:console.log,warn:console.warn,error:console.error,info:console.info,debug:console.debug}[i]||console.log)(`[Plugin:${e.id}] ${r}`,s||"")},getPlugin:i=>this.#L(e.id,i),getConfig:i=>e.rawManifest.config?.[i],setConfig:(i,r)=>this.#$(e.id,i,r)}}async#p(e,t){const i=e.runtime;return i.entrypoint?await this.#f(i.entrypoint,e):i.inline?(console.warn(`[ManifestPluginSystem] Inline runtime for plugin '${e.id}' is deprecated and will not be executed.`),this.#w(t)):this.#w(t)}async#f(e,t){const i=await b.fetch(e);if(!i.ok)throw new R(`Failed to fetch plugin runtime: ${i.statusText}`,{pluginId:t.id});const r=await i.text();if(this.#t.config.environment!=="production"){const c=re(r);if(c.length>0){this.#r?.logAuditEvent("PLUGIN_SECURITY_VIOLATION",{pluginId:t.id,violations:c.map(h=>h.message),severity:"critical"});const l=c.map(h=>`- ${h.message} (severity: ${h.severity})`).join(`
`);throw new R(`Plugin '${t.id}' contains forbidden code patterns and was not loaded:
${l}`,{pluginId:t.id,severity:"critical",showToUser:!0})}}const s=new Blob([r],{type:"application/javascript"}),n=URL.createObjectURL(s),a=await import(n);return URL.revokeObjectURL(n),a}#w(e){return g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"}),{initialize:async()=>{}}}async#_(e,t,i){const r=e.components;if(t.initialize&&typeof t.initialize=="function"&&await t.initialize(i),r.widgets)for(const s of r.widgets)i.registerWidget(s.id,{...s,pluginId:e.id});if(r.actions)for(const s of r.actions)i.registerAction(s.id,{...s,pluginId:e.id});if(r.field_renderers)for(const s of r.field_renderers)i.registerFieldRenderer(s.field,{...s,pluginId:e.id});if(r.command_handlers)for(const s of r.command_handlers)i.registerCommandHandler(s.command,{...s,pluginId:e.id})}#b(e,t,i){this.#s&&this.#s.register({id:`${e}.${t}`,...i,pluginId:e})}#v(e,t,i){this.#n&&this.#n.register(`${e}.${t}`,r=>{console.log(`Executing plugin action: ${e}.${t}`)})}#E(e,t,i){this.#s&&this.#s.register({id:`${e}.${t}`,...i,pluginId:e})}#S(e,t,i){this.#s&&this.#s.register({id:`field-renderer.${e}.${t}`,...i})}#R(e,t,i){console.log(`[ManifestPluginSystem] Registering command handler '${t}' from plugin '${e}'`)}getWidgetsForEntityType(e){return this.#s?this.#s.getForEntityTypes(e).filter(t=>t.category==="widget"):[]}getActionsForEntityType(e){return this.#n?[]:[]}async render(e){const t=e.component||e.widget,i=this.#s?.get(t);if(!i)return console.warn(`Widget not found: ${t}`),this.#I(t);try{const r={config:e.config||{},data:e.data||{},pluginContext:this.#P(i.pluginId)};return await i.render(r)}catch(r){return console.error(`Error rendering widget ${t}:`,r),this.#O(t,r)}}async executeAction(e,t){const i=this.#n?.get(e);if(!i)throw new Error(`Action not found: ${e}`);try{const r={...t};return await i(r)}catch(r){throw console.error(`Error executing action ${e}:`,r),r}}async#M(){const e=Array.from(this.#c.values()).filter(i=>i.enabled&&i.autoload),t=this.#A(e);for(const i of t)try{await this.loadPlugin(i.id)}catch(r){console.error(`Failed to load enabled plugin ${i.id}:`,r)}}#A(e){const t=[],i=new Set,r=new Set,s=n=>{if(r.has(n.id))throw new Error(`Circular dependency detected: ${n.id}`);if(i.has(n.id))return;r.add(n.id);const a=n.dependencies.plugins||[];for(const c of a){const l=this.#c.get(c);l&&e.includes(l)&&s(l)}r.delete(n.id),i.add(n.id),t.push(n)};for(const n of e)s(n);return t}#x(e){g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});const t=e.dependencies.plugins||[];this.#l.set(e.id,t)}async unloadPlugin(e){const t=this.#o.get(e);if(!t)return!1;try{return this.#T("beforeUnload",{plugin:t}),this.#C(e),t.runtime.cleanup&&await t.runtime.cleanup(),this.#o.delete(e),this.#T("afterUnload",{pluginId:e}),this.#t.emit("pluginUnloaded",{pluginId:e}),!0}catch(i){throw console.error(`Error unloading plugin ${e}:`,i),i}}#C(e){if(this.#s)for(const[t,i]of this.#s.getAll())i.pluginId===e&&this.#s.unregister(t)}#I(e){const t=document.createElement("div");t.className="plugin-widget-missing";const i=document.createElement("p");return i.textContent=`Widget not found: ${e}`,t.appendChild(i),t}#O(e,t){const i=document.createElement("div");i.className="plugin-widget-error";const r=document.createElement("p"),s=document.createElement("strong");s.textContent=`Widget Error: ${e}`,r.appendChild(s);const n=document.createElement("p");return n.textContent=t.message,i.append(r,n),i}#P(e){return this.#o.get(e)?.context}#L(e,t){return this.#o.get(t)?.context}#$(e,t,i){const r=this.#c.get(e);r&&(r.rawManifest.config||(r.rawManifest.config={}),r.rawManifest.config[t]=i)}#k(e){this.#e?.updateAverage("averageLoadTime",e)}#T(e,t){(this.#d[e]||[]).forEach(r=>{try{r(t)}catch(s){console.error(`Hook error for ${e}:`,s)}})}getStatistics(){return{...this.#e?.getAllAsObject()||{},pluginsLoaded:this.#o.size,availableManifests:this.#c.size,registeredComponents:this.#s?.definitions.size||0}}exportState(){return{manifests:Array.from(this.#c.values()),loadedPlugins:Array.from(this.#o.keys()),components:Array.from(this.#s?.definitions.keys()||[])}}}class ae{#t;#e;#i;#r;#s;#n={slowQueryMs:50,hotQueryCount:100,criticalLatencyMs:100,materializedViewRows:1e4,partitionRows:1e6};#a={queryAnalysis:300*1e3,optimization:3600*1e3,viewRefresh:1800*1e3};#o=null;#c=null;#h=null;#l=!0;#d=!0;get monitoring(){return this.#l}set monitoring(e){this.#l=!!e}get autoSuggestions(){return this.#d}set autoSuggestions(e){this.#d=!!e}constructor(e){this.#t=e.stateManager,this.#e=e.dbClient,this.#i=this.#t.metricsRegistry?.namespace("databaseOptimizer"),this.#r=this.#t.managers.forensicLogger,this.#s=this.#t.managers.errorHelpers}async initialize(){return this.#s.tryOr(async()=>{if(console.log("ðŸ”§ Initializing DatabaseOptimizer..."),!this.#e||typeof this.#e.query!="function")throw new Error("DatabaseOptimizer requires a compatible SQL database client with a `query()` method.");return await this.#g(),this.#l&&this.#u(),this.#d&&this.#y(),console.log("âœ… DatabaseOptimizer initialized"),!0},e=>{throw console.error("Failed to initialize DatabaseOptimizer:",e),e},{component:"DatabaseOptimizer",operation:"initialize"})}async#g(){const e=["database_optimizations","query_performance_log","index_suggestions"];for(const t of e)if(!(await this.#e.query(` 
        SELECT EXISTS (
          SELECT FROM information_schema.tables 
          WHERE table_name = $1
        )
      `,[t])).rows[0].exists)throw new Error(`Required table ${t} not found. Please apply the complete database schema.`)}#u(){this.#o=setInterval(()=>{this.#p()},this.#a.queryAnalysis),this.#e.client.refresh_performance_views&&(this.#c=setInterval(()=>{this.#b()},this.#a.viewRefresh)),console.log("ðŸ“ˆ Performance monitoring started")}#y(){this.#h=setInterval(()=>{this.#_()},this.#a.optimization),console.log("ðŸ’¡ Auto-suggestions enabled")}async logQuery(e,t,i,r,s=null,n="unknown",a=null){try{if(!this.#l)return;this.#i?.increment("queriesLogged"),await this.#e.query(`
        INSERT INTO query_performance_log 
        (table_name, query_pattern, jsonb_path, execution_time_ms, row_count, scan_type, index_used)
        VALUES ($1, $2, $3, $4, $5, $6, $7)
      `,[e,t,i,r,s,n,a]),r>this.#n.criticalLatencyMs&&await this.#m(e,i,r)}catch(c){this.#s?.handleError(c,{component:"DatabaseOptimizer",operation:"logQuery",context:{tableName:e,jsonbPath:i}})}}async#m(e,t,i){try{if((await this.#e.query(`
        SELECT id FROM index_suggestions 
        WHERE table_name = $1 AND jsonb_path = $2 
        AND status IN ('pending', 'approved')
      `,[e,t])).rows.length>0)return;await this.#w(e,t,"urgent_index",{executionTime:i,urgency:"critical"});const s=`Critical slow query detected: ${e}.${t} (${i}ms)`;console.warn(`ðŸš¨ ${s}`),this.#r?.logAuditEvent("DB_CRITICAL_PERFORMANCE",{message:s,tableName:e,jsonbPath:t,executionTime:i})}catch(r){this.#s?.handleError(r,{component:"DatabaseOptimizer",operation:"handleCriticalSlowQuery"})}}async#p(){this.#i?.increment("analysisCycles");try{const e=await this.#e.query(`
        SELECT 
          table_name,
          jsonb_path,
          COUNT(*) as query_count,
          AVG(execution_time_ms) as avg_latency,
          MAX(execution_time_ms) as max_latency,
          ARRAY_AGG(DISTINCT scan_type) as scan_types
        FROM query_performance_log 
        WHERE logged_at > now() - interval '1 hour'
        AND execution_time_ms > $1
        GROUP BY table_name, jsonb_path
        HAVING COUNT(*) > $2
        ORDER BY AVG(execution_time_ms) DESC
        LIMIT 20
      `,[this.#n.slowQueryMs,this.#n.hotQueryCount]);for(const t of e.rows)await this.#f(t);e.rows.length>0&&console.log(`ðŸ” Analyzed ${e.rows.length} slow query patterns`)}catch(e){this.#i?.increment("analysisErrors"),this.#s?.handleError(e,{component:"DatabaseOptimizer",operation:"analyzeQueryPatterns"})}}async#f(e){const{table_name:t,jsonb_path:i,query_count:r,avg_latency:s,max_latency:n,scan_types:a}=e;try{let c,l;r>this.#n.materializedViewRows?(c="materialized_view",l=Math.min(s*.8,90)):r>1e3&&a.includes("sequential_scan")?(c="partial_index",l=Math.min(s*.6,70)):(c="gin_index",l=Math.min(s*.4,50)),l>10&&await this.#w(t,i,c,{queryCount:r,avgLatency:s,maxLatency:n,estimatedBenefit:l,scanTypes:a})}catch(c){this.#s?.handleError(c,{component:"DatabaseOptimizer",operation:"evaluateOptimizationOpportunity",context:{pattern:e}})}}async#w(e,t,i,r={}){g.createEnvelope({component:"DatabaseOptimizer",operation:"createIndexSuggestion",context:{tableName:e,jsonbPath:t,suggestionType:i}}).catch(()=>{});try{if(this.#r?.logAuditEvent("DB_OPTIMIZATION_SUGGESTION_CREATED",{tableName:e,jsonbPath:t,suggestionType:i,...r}),!/^[a-zA-Z0-9_]+$/.test(e))throw new Error(`Invalid table name: ${e}`);if(!/^[a-zA-Z0-9_.\->>']+$/.test(t))throw new Error(`Invalid JSONB path: ${t}`);let s,n;const a=`idx_${e}_${t.replace(/[^a-z0-9_]/g,"_")}`;switch(i){case"gin_index":s=`CREATE INDEX CONCURRENTLY ${a} ON ${e} USING gin ((data->>'${t}'));`,n=`DROP INDEX IF EXISTS ${a};`;break;case"partial_index":const h=(await this.#e.query(`
            SELECT type, COUNT(*) as count
            FROM ${e}
            WHERE data->>'${t}' IS NOT NULL
            GROUP BY type
            ORDER BY count DESC
            LIMIT 1
          `)).rows[0]?.type||"unknown";s=`CREATE INDEX CONCURRENTLY ${a}_partial ON ${e} USING gin ((data->>'${t}')) WHERE type = '${h}';`,n=`DROP INDEX IF EXISTS ${a}_partial;`;break;case"materialized_view":const d=`${e}_${t}_view`;s=`
            CREATE MATERIALIZED VIEW ${d} AS
            SELECT 
              id,
              type,
              domain,
              data->>'${t}' AS ${t},
              data,
              created_at,
              updated_at
            FROM ${e}
            WHERE data->>'${t}' IS NOT NULL
            WITH DATA;
            
            CREATE UNIQUE INDEX ${d}_id ON ${d} (id);
            CREATE INDEX ${d}_${t} ON ${d} (${t});
          `,n=`DROP MATERIALIZED VIEW IF EXISTS ${d};`;break;case"urgent_index":s=`CREATE INDEX CONCURRENTLY ${a}_urgent ON ${e} USING gin ((data->>'${t}'));`,n=`DROP INDEX IF EXISTS ${a}_urgent;`;break;default:throw new Error(`Unknown suggestion type: ${i}`)}const c=await this.#e.query(`
        INSERT INTO index_suggestions 
        (table_name, jsonb_path, suggestion_type, estimated_benefit, query_frequency, 
         avg_query_time, suggested_sql, rollback_sql, status)
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, 'pending')
        ON CONFLICT (table_name, jsonb_path, suggestion_type) 
        DO UPDATE SET
          estimated_benefit = EXCLUDED.estimated_benefit,
          query_frequency = EXCLUDED.query_frequency,
          avg_query_time = EXCLUDED.avg_query_time,
          created_at = now()
        RETURNING id
      `,[e,t,i,r.estimatedBenefit||0,r.queryCount||0,r.avgLatency||0,s,n]);return this.#i?.increment("suggestionsGenerated"),console.log(`ðŸ’¡ Created ${i} suggestion for ${e}.${t}`),c.rows[0].id}catch(s){return this.#i?.increment("suggestionErrors"),this.#s?.handleError(s,{component:"DatabaseOptimizer",operation:"createIndexSuggestion"}),null}}async applyOptimization(e,t="system"){return this.#s.tryOr(async()=>{const i=await this.#e.query(`
        SELECT * FROM index_suggestions WHERE id = $1
      `,[e]);if(i.rows.length===0)throw new Error(`Suggestion ${e} not found`);const r=i.rows[0];if(r.status!=="pending"&&r.status!=="approved")throw new Error(`Cannot apply suggestion in status: ${r.status}`);console.log(`ðŸ”§ Applying ${r.suggestion_type} optimization...`);const s=performance.now();await this.#e.query(r.suggested_sql);const n=Date.now()-s;return await this.#e.query(`
        UPDATE index_suggestions 
        SET status = 'applied', applied_at = now()
        WHERE id = $1
      `,[e]),await this.#e.query(`
        INSERT INTO database_optimizations 
        (optimization_type, table_name, target_field, sql_definition, rollback_sql, 
         query_count, avg_latency_before, status, approved_at, applied_at, metadata)
        VALUES ($1, $2, $3, $4, $5, $6, $7, 'applied', now(), now(), $8)
      `,[r.suggestion_type,r.table_name,r.jsonb_path,r.suggested_sql,r.rollback_sql,r.query_frequency,r.avg_query_time,JSON.stringify({suggestionId:e,approvedBy:t,executionTimeMs:n,estimatedBenefit:r.estimated_benefit})]),this.#i?.increment("optimizationsApplied"),console.log(`âœ… Applied ${r.suggestion_type} optimization in ${n.toFixed(2)}ms`),this.#t?.emit("optimization_applied",{id:e,type:r.suggestion_type,table:r.table_name,field:r.jsonb_path,executionTime:n,approvedBy:t}),!0},async i=>{throw this.#i?.increment("optimizationErrors"),await this.#e.query(`
        UPDATE index_suggestions 
        SET status = 'failed'
        WHERE id = $1
      `,[e]).catch(r=>console.error("Failed to mark suggestion as failed:",r)),i},{component:"DatabaseOptimizer",operation:"applyOptimization",context:{suggestionId:e,approvedBy:t}})}async rollbackOptimization(e){return this.#s.tryOr(async()=>{const t=await this.#e.query(`
        SELECT * FROM database_optimizations WHERE id = $1
      `,[e]);if(t.rows.length===0)throw new Error(`Optimization ${e} not found`);const i=t.rows[0];if(i.status!=="applied")throw new Error(`Cannot rollback optimization in status: ${i.status}`);if(!i.rollback_sql)throw new Error("No rollback SQL available");return console.log(`ðŸ”™ Rolling back ${i.optimization_type}...`),await this.#e.query(i.rollback_sql),await this.#e.query(`
        UPDATE database_optimizations 
        SET status = 'rolled_back'
        WHERE id = $1
      `,[e]),console.log(`âœ… Rolled back ${i.optimization_type}`),!0},null,{component:"DatabaseOptimizer",operation:"rollbackOptimization",context:{optimizationId:e}})}async#_(){if(!this.#e.client.suggest_jsonb_indexes){console.warn("[DatabaseOptimizer] `suggest_jsonb_indexes` function not found on DB client. Skipping auto-suggestions.");return}try{console.log("ðŸ” Generating optimization suggestions...");const e=await this.#e.query(`
        SELECT * FROM suggest_jsonb_indexes()
        WHERE query_count > $1 AND avg_time > $2
        ORDER BY avg_time DESC, query_count DESC
        LIMIT 10
      `,[this.#n.hotQueryCount,this.#n.slowQueryMs]);for(const t of e.rows)await this.#w(t.table_name,t.jsonb_path,"gin_index",{queryCount:t.query_count,avgLatency:t.avg_time,estimatedBenefit:Math.min(t.avg_time*.4,50)});e.rows.length>0&&console.log(`ðŸ’¡ Generated ${e.rows.length} optimization suggestions`)}catch(e){this.#s?.handleError(e,{component:"DatabaseOptimizer",operation:"generateOptimizationSuggestions"})}}async#b(){if(this.#e.client.refresh_performance_views)try{console.log("ðŸ”„ Refreshing materialized views...");const e=performance.now();await this.#e.query("SELECT refresh_performance_views()");const t=performance.now()-e;console.log(`âœ… Materialized views refreshed in ${t.toFixed(2)}ms`),await this.logQuery("materialized_views","refresh_performance_views","system",t,null,"refresh")}catch(e){this.#i?.increment("viewRefreshErrors"),this.#s?.handleError(e,{component:"DatabaseOptimizer",operation:"refreshMaterializedViews"})}}async getPendingSuggestions(){try{return(await this.#e.query(`
        SELECT 
          id,
          table_name,
          jsonb_path,
          suggestion_type,
          estimated_benefit,
          query_frequency,
          avg_query_time,
          created_at
        FROM index_suggestions 
        WHERE status = 'pending'
        ORDER BY estimated_benefit DESC, query_frequency DESC
      `)).rows}catch(e){return this.#s?.handleError(e,{component:"DatabaseOptimizer",operation:"getPendingSuggestions"}),[]}}async getAppliedOptimizations(){try{return(await this.#e.query(`
        SELECT 
          o.*,
          COALESCE(
            (SELECT avg(execution_time_ms) 
             FROM query_performance_log q 
             WHERE q.table_name = o.table_name 
             AND q.jsonb_path = o.target_field 
             AND q.logged_at > o.applied_at
             LIMIT 100), 
            o.avg_latency_before
          ) as avg_latency_after
        FROM database_optimizations o
        WHERE status = 'applied'
        ORDER BY applied_at DESC
      `)).rows.map(t=>({...t,performance_gain:t.avg_latency_before&&t.avg_latency_after?(t.avg_latency_before-t.avg_latency_after)/t.avg_latency_before*100:null}))}catch(e){return this.#s?.handleError(e,{component:"DatabaseOptimizer",operation:"getAppliedOptimizations"}),[]}}async getPerformanceMetrics(){try{const[e,t,i]=await Promise.all([this.#e.query("SELECT * FROM slow_query_analysis LIMIT 10"),this.#e.query("SELECT * FROM database_performance_overview LIMIT 10"),this.#e.query(`
          SELECT 
            schemaname, tablename, indexname, idx_scan, idx_tup_read,
            pg_size_pretty(pg_relation_size(indexrelid)) as index_size
          FROM pg_stat_user_indexes 
          WHERE schemaname = 'public'
          ORDER BY idx_scan DESC 
          LIMIT 10
        `)]);return{slowQueries:e.rows,tableStats:t.rows,indexStats:i.rows,systemMetrics:this.#i?.getAllAsObject()}}catch(e){return this.#s?.handleError(e,{component:"DatabaseOptimizer",operation:"getPerformanceMetrics"}),null}}async getOptimizationOpportunities(){try{return(await this.#e.query("SELECT * FROM optimization_opportunities LIMIT 20")).rows}catch(e){return this.#s?.handleError(e,{component:"DatabaseOptimizer",operation:"getOptimizationOpportunities"}),[]}}updateConfig(e){g.createEnvelope({component:"DatabaseOptimizer",operation:"updateConfig",context:{providedKeys:e?Object.keys(e):[]}}).catch(()=>{}),this.#r?.logAuditEvent("DB_OPTIMIZER_CONFIG_UPDATED",{updatedKeys:Object.keys(e)}),e.thresholds&&(this.#n={...this.#n,...e.thresholds}),e.intervals&&(this.#a={...this.#a,...e.intervals}),typeof e.monitoring=="boolean"&&(this.#l=e.monitoring),typeof e.autoSuggestions=="boolean"&&(this.#d=e.autoSuggestions),console.log("ðŸ“ DatabaseOptimizer configuration updated")}getMetrics(){return{...this.#i?.getAllAsObject()||{},thresholds:this.#n,monitoring:this.#l,autoSuggestions:this.#d}}async cleanup(){console.log("[DatabaseOptimizer] Shutting down..."),clearInterval(this.#o),clearInterval(this.#c),clearInterval(this.#h),this.#o=null,this.#c=null,this.#h=null,console.log("[DatabaseOptimizer] Cleanup complete.")}}class oe{#t;#e={};#i=null;#r=null;#s;#n;#a;constructor({stateManager:e}){this.#t=e,this.#s=this.#t.managers.cacheManager,this.#n=this.#t.managers.forensicLogger,this.#a=this.#t.managers.errorHelpers,this.#e={super_admin:{permissions:["optimization:view","optimization:apply","optimization:rollback","optimization:configure","system:view_sensitive","system:configure","audit:view","audit:export","metrics:view","metrics:export"],description:"Full system access including sensitive operations"},db_admin:{permissions:["optimization:view","optimization:apply","optimization:rollback","metrics:view","audit:view"],description:"Database optimization and monitoring access"},developer:{permissions:["optimization:view","metrics:view"],description:"Read-only access to optimization data"},monitor:{permissions:["metrics:view","health:view"],description:"System monitoring and metrics access"},analyst:{permissions:["optimization:view","metrics:view","metrics:export","audit:view","audit:export"],description:"Analytics and reporting access"}}}initialize(){if(!this.#s)throw new Error("CacheManager is not available. OptimizationAccessControl cannot initialize.");this.#r=this.#s.getCache("authSessions",{max:this.#t.config?.optimization?.maxSessions||1e3}),this.#i=this.#s.getCache("userRoles",{max:5e3})}async hasPermission(e,t){return this.#a.tryOr(async()=>(await this.getUserPermissions(e)).includes(t),()=>!1,{component:"OptimizationAccessControl",operation:"hasPermission",context:{userId:e,permission:t}})}async getUserPermissions(e){const t=await this.getUserRoles(e),i=new Set;for(const r of t){const s=this.#e[r];s&&s.permissions.forEach(n=>i.add(n))}return Array.from(i)}async getUserRoles(e){return this.#a.tryOr(async()=>{const t=this.#i.get(e);if(t)return t;const r=(await this.#t.storage.instance.query("relationships","source_id",e)).filter(s=>s.type==="user_has_role").map(s=>s.target_id);return this.#i.set(e,r),r},()=>[],{component:"OptimizationAccessControl",operation:"getUserRoles",context:{userId:e}})}async assignRole(e,t){return this.#a.tryOr(async()=>{if(!this.#e[t])throw new Error(`Role '${t}' does not exist`);const i={id:this.#t.managers.idManager.generate(),source_id:e,target_id:t,type:"user_has_role",created_at:new Date().toISOString()};await this.#t.storage.instance.put("relationships",i),await this.#n?.logAuditEvent("RBAC_ROLE_ASSIGNED",{userId:e,roleName:t}),console.log(`ðŸ‘¤ Assigned role '${t}' to user ${e}`)},null,{component:"OptimizationAccessControl",operation:"assignRole",context:{userId:e,roleName:t}})}async removeRole(e,t){console.warn("[OptimizationAccessControl] 'removeRole' is a complex operation and is not fully implemented in this example.")}async createSession(e,t){g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});const i=await this.getUserPermissions(e),r=await this.getUserRoles(e),s={userId:e,permissions:i,roles:r,created:new Date,expires:new Date(Date.now()+480*60*1e3),lastActivity:new Date};return this.#r?.set(t,s),s}checkSessionPermission(e,t){const i=this.#r?.get(e);return i?i.expires<new Date?(this.#r?.delete(e),{valid:!1,reason:"Session expired"}):(i.lastActivity=new Date,i.permissions.includes(t)?{valid:!0,session:i}:{valid:!1,reason:`Permission '${t}' denied`,requiredRoles:this.getRolesWithPermission(t)}):{valid:!1,reason:"Session not found"}}getRolesWithPermission(e){const t=[];for(const[i,r]of Object.entries(this.#e))r.permissions.includes(e)&&t.push(i);return t}cleanExpiredSessions(){const e=new Date;let t=0;return this.#r?.forEach((i,r)=>{i.expires<e&&(this.#r?.delete(r),t++)}),t>0&&console.log(`ðŸ§¹ Cleaned ${t} expired sessions`),t}getSessionInfo(e){const t=this.#r?.get(e);return t?{userId:t.userId,roles:t.roles,permissions:t.permissions,created:t.created,expires:t.expires,lastActivity:t.lastActivity,timeRemaining:Math.max(0,t.expires.getTime()-Date.now())}:null}extendSession(e,t=8){const i=this.#r?.get(e);return i?(i.expires=new Date(Date.now()+t*60*60*1e3),i.lastActivity=new Date,!0):!1}revokeSession(e){return this.#r?.delete(e)}getActiveSessions(){const e=new Date,t=[];return this.#r?.forEach((i,r)=>{i.expires>e&&t.push({sessionId:r,userId:i.userId,roles:i.roles,created:i.created,expires:i.expires,lastActivity:i.lastActivity})}),t}}const ce="http://json-schema.org/draft-07/schema#",le="Nodus Condition Definition",he="A schema for declarative, serializable condition objects used in event flows and UI logic.",de="object",ue={type:{description:"The type of the condition to evaluate.",type:"string"}},ge=["type"],pe=[{if:{properties:{type:{const:"property_equals"}}},then:{properties:{property:{type:"string",description:"Dot-notation path to the property."},value:{description:"The value to compare against."}},required:["property","value"]}},{if:{properties:{type:{const:"numeric_comparison"}}},then:{properties:{property:{type:"string"},operator:{enum:[">","<",">=","<=","==","!="]},value:{type:"number"}},required:["property","operator","value"]}},{if:{properties:{type:{const:"in_array"}}},then:{properties:{property:{type:"string"},array:{type:"array"}},required:["property","array"]}},{if:{properties:{type:{const:"regex_match"}}},then:{properties:{property:{type:"string"},pattern:{type:"string"},flags:{type:"string"}},required:["property","pattern"]}},{if:{properties:{type:{const:"time_range"}}},then:{properties:{after:{type:"number",description:"Unix timestamp"},before:{type:"number",description:"Unix timestamp"}}}},{if:{properties:{type:{const:"time_of_day"}}},then:{properties:{after:{type:"string",pattern:"^\\d{2}:\\d{2}$"},before:{type:"string",pattern:"^\\d{2}:\\d{2}$"}}}},{if:{properties:{type:{const:"time_of_day_preparsed"}}},then:{properties:{afterMinutes:{type:"number"},beforeMinutes:{type:"number"}}}},{if:{properties:{type:{const:"user_has_permission"}}},then:{properties:{permissions:{type:"array",items:{type:"string"}},requireAll:{type:"boolean"}},required:["permissions"]}},{if:{properties:{type:{const:"user_has_role"}}},then:{properties:{roles:{type:"array",items:{type:"string"}}},required:["roles"]}},{if:{properties:{type:{const:"entity_type"}}},then:{properties:{types:{type:"array",items:{type:"string"}}},required:["types"]}},{if:{properties:{type:{const:"evaluate_logical"}}},then:{properties:{operator:{enum:["AND","OR","NOT"]},conditions:{type:"array",items:{$ref:"#"}}},required:["operator","conditions"]}},{if:{properties:{type:{const:"is_rate_limited"}}},then:{properties:{key:{type:"string"},limit:{type:"number"},window:{type:"number"}},required:["limit"]}}],ye={$schema:ce,title:le,description:he,type:de,properties:ue,required:ge,allOf:pe};class me{#t;#e=new Map;#i=null;#r=null;#s=null;#n=new Map;#a=null;constructor({stateManager:e}){this.#t=e}initialize(){this.#s=this.#t.managers.errorHelpers,this.#r=this.#t.metricsRegistry?.namespace("conditionRegistry");const e=this.#t.managers.cacheManager;e&&(this.#i=e.getCache("conditionResults",{ttl:3e5})),this.#a=this.#d(ye),this.#h(),console.log(`[ConditionRegistry] Initialized with ${this.#e.size} built-in conditions.`)}register(e,t,i={}){this.#e.has(e)&&console.warn(`[ConditionRegistry] Overwriting existing condition handler for type: '${e}'.`),this.#o(e,i);const r={type:e,evaluator:t,description:i.description||"",cacheable:i.cacheable!==!1,async:i.async||!1,schema:i.schema||{},examples:i.examples||[]};return this.#e.set(e,r),this.#r?.increment("registered"),r}#o(e,t){if(t.schema&&typeof t.schema!="object")throw new Error(`Schema for condition '${e}' must be an object.`);if(!t.examples||t.examples.length===0){console.warn(`[ConditionRegistry] No examples provided for condition '${e}'.`);return}for(const i of t.examples){const{valid:r,errors:s}=this.validate(i);if(!r)throw new Error(`Invalid example for condition '${e}': ${s.join(", ")}. Example: ${JSON.stringify(i)}`)}}async evaluate(e,t,i=null){return this.#r?.increment("evaluations"),this.#s?.tryOr(async()=>{const{valid:r,errors:s}=this.validate(e);if(!r)throw new Error(`Invalid condition definition: ${s.join("; ")}`);const n=this.#c(e,t,i);if(n&&this.#i?.has(n))return this.#r?.increment("cacheHits"),this.#i.get(n);const a=this.#e.get(e.type);if(!a)throw new Error(`Unknown condition type: ${e.type}`);const c=[e,t,i,this.#t],l=await Promise.resolve(a.evaluator(...c));return n&&(this.#i?.set(n,l),this.#r?.increment("cacheMisses")),l},()=>!1,{component:"ConditionRegistry",operation:"evaluate",conditionType:e.type})}#c(e,t,i){const r=this.#e.get(e.type);if(!r||!r.cacheable)return null;try{const s={def:e,subjectHash:i?`${i.userId}:${i.role}:${i.level}`:"anonymous"};return`cond:${JSON.stringify(s)}`}catch(s){return console.warn(`[ConditionRegistry] Failed to generate cache key for condition type ${e.type}:`,s),null}}#h(){this.register("property_equals",(e,t)=>{const i=e.property,r=e.value;return this.#l(t,i)===r},{description:"Compare a property value for equality",schema:{property:{type:"string",required:!0},value:{required:!0}},examples:[{type:"property_equals",property:"data.user.role",value:"admin"},{type:"property_equals",property:"data.entity.status",value:"active"}]}),this.register("numeric_comparison",(e,t)=>{const i=e.property,r=e.operator,s=e.value,n=this.#l(t,i);if(typeof n!="number"||typeof s!="number")return!1;switch(r){case">":return n>s;case"<":return n<s;case">=":return n>=s;case"<=":return n<=s;case"==":return n===s;case"!=":return n!==s;default:return!1}},{description:"Compare numeric values",schema:{property:{type:"string",required:!0},operator:{type:"string",enum:[">","<",">=","<=","==","!="],required:!0},value:{type:"number",required:!0}},examples:[{type:"numeric_comparison",property:"data.task.priority",operator:">",value:5},{type:"numeric_comparison",property:"metrics.fps",operator:">=",value:60}]}),this.register("in_array",(e,t)=>{const i=e.property,r=e.array,s=this.#l(t,i);return Array.isArray(r)&&r.includes(s)},{description:"Check if property value is in array",schema:{property:{type:"string",required:!0},array:{type:"array",required:!0}},examples:[{type:"in_array",property:"data.entity.type",array:["task","note"]}]}),this.register("regex_match",(e,t)=>{const i=e.property,r=e.pattern,s=e.flags||"",n=this.#l(t,i);if(typeof n!="string")return!1;if(r.length>100||/[*+]\?/.test(r))return console.warn(`[ConditionRegistry] Potentially complex regex pattern blocked: ${r}`),!1;try{return new RegExp(r,s).test(n)}catch(a){return console.error(`[ConditionRegistry] Invalid regex pattern: ${r}`,a),!1}},{description:"Match property against regular expression",schema:{property:{type:"string",required:!0},pattern:{type:"string",required:!0},flags:{type:"string"}},examples:[{type:"regex_match",property:"data.entity.name",pattern:"^TASK-"}]}),this.register("time_range",(e,t)=>{const i=Date.now(),r=t.timestamp||i;return!(e.after&&r<e.after||e.before&&r>e.before)},{description:"Check if context timestamp is within time range",schema:{after:{type:"number"},before:{type:"number"}},examples:[{type:"time_range",after:17145216e5,before:17172e8}]}),this.register("time_of_day",(e,t)=>{const i=new Date(t.timestamp||Date.now()),r=i.getHours()*60+i.getMinutes();if(e.after){const s=p.parseTimeString(e.after);if(r<s)return!1}if(e.before){const s=p.parseTimeString(e.before);if(r>s)return!1}return!0},{description:"Check if current time is within specified hours",schema:{after:{type:"string",pattern:"^\\d{2}:\\d{2}$"},before:{type:"string",pattern:"^\\d{2}:\\d{2}$"}},examples:[{type:"time_of_day",after:"09:00",before:"17:00"},{type:"time_of_day",after:"22:00"}]}),this.register("time_of_day_preparsed",(e,t)=>{const i=new Date(t.timestamp||Date.now()),r=i.getHours()*60+i.getMinutes();return!(e.afterMinutes!==void 0&&r<e.afterMinutes||e.beforeMinutes!==void 0&&r>e.beforeMinutes)},{description:"Check if current time is within a pre-parsed time range (for performance).",schema:{afterMinutes:{type:"number"},beforeMinutes:{type:"number"}},examples:[{type:"time_of_day_preparsed",afterMinutes:540,beforeMinutes:1020}]}),this.register("user_has_permission",(e,t,i)=>{const r=i?.permissions||[],s=e.permissions||[];return e.requireAll!==!1?s.every(a=>r.includes(a)):s.some(a=>r.includes(a))},{description:"Check if user has required permissions",schema:{permissions:{type:"array",required:!0},requireAll:{type:"boolean"}},examples:[{type:"user_has_permission",permissions:["entity:edit","entity:delete"],requireAll:!0}]}),this.register("user_has_role",(e,t,i)=>{const r=i?.role;return(e.roles||[]).includes(r)},{description:"Check if user has allowed role",schema:{roles:{type:"array",required:!0}},examples:[{type:"user_has_role",roles:["admin","editor"]}]}),this.register("entity_type",(e,t)=>{const i=t.entityType||t.entity?.type;return(e.types||[]).includes(i)},{description:"Check if entity is of allowed type",schema:{types:{type:"array",required:!0}},examples:[{type:"entity_type",types:["user","group"]}]}),this.register("is_rate_limited",(e,t)=>{const i=e.key||t.userId||"global",r=e.limit||10,s=e.window||6e4,n=Date.now(),a=this.#n.get(i)||{count:0,windowStart:n};return n-a.windowStart>s&&(a.count=0,a.windowStart=n),a.count++,this.#n.set(i,a),a.count<=r},{description:"Check if action is within rate limit",cacheable:!1,schema:{key:{type:"string"},limit:{type:"number",required:!0},window:{type:"number"}},examples:[{type:"is_rate_limited",limit:5,window:6e4}]}),this.register("evaluate_logical",async(e,t,i)=>{const r=e.operator||"AND",s=e.conditions||[];if(r==="AND"){for(const n of s)if(!await this.evaluate(n,t,i))return!1;return!0}else if(r==="OR"){for(const n of s)if(await this.evaluate(n,t,i))return!0;return!1}else if(r==="NOT"){const n=s[0];return n?!await this.evaluate(n,t,i):!0}return!1},{description:"Combine multiple conditions with logical operators",async:!0,schema:{operator:{type:"string",enum:["AND","OR","NOT"],required:!0},conditions:{type:"array",required:!0}},examples:[{type:"evaluate_logical",operator:"AND",conditions:[{type:"property_equals",property:"data.entity.status",value:"active"},{type:"user_has_role",roles:["editor"]}]}]})}#l(e,t){return t.split(".").reduce((i,r)=>i&&i[r]!==void 0?i[r]:void 0,e)}#d(e){return g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"}),t=>{const i=[];if(typeof t!="object"||t===null)return{valid:!1,errors:["Condition must be an object."]};for(const s of e.required||[])t[s]===void 0&&i.push(`Missing required property: '${s}'.`);const r=e.allOf?.find(s=>s.if?.properties?.type?.const===t.type);if(r){const{then:s}=r;if(s){for(const n of s.required||[])t[n]===void 0&&i.push(`Missing required property for type '${t.type}': '${n}'.`);for(const n in s.properties||{})if(t[n]!==void 0){const a=s.properties[n],c=t[n];a.type&&typeof c!==a.type&&!(a.type==="array"&&Array.isArray(c))&&i.push(`Property '${n}' must be of type '${a.type}', but received '${typeof c}'.`),a.enum&&!a.enum.includes(c)&&i.push(`Property '${n}' must be one of [${a.enum.join(", ")}], but received '${c}'.`),a.pattern&&!new RegExp(a.pattern).test(c)&&i.push(`Property '${n}' must match pattern: /${a.pattern}/.`)}}}else t.type&&i.push(`Unknown or un-schematized condition type: '${t.type}'.`);return{valid:i.length===0,errors:i}}}validate(e){return!e||!e.type?{valid:!1,errors:["Condition must be an object and have a 'type' property."]}:this.#a?this.#a(e):{valid:!0,errors:[]}}getAvailableConditions(){return Array.from(this.#e.values()).map(e=>({type:e.type,description:e.description,schema:e.schema,examples:e.examples,async:e.async,cacheable:e.cacheable}))}getStatistics(){return{...this.#r?.getAllAsObject()||{},totalConditions:this.#e.size,cacheSize:this.#i?.size??0}}clearCache(){this.#i?.clear(),this.#n.clear(),this.#r?.increment("cacheClears")}unregister(e){return this.#e.delete(e)}}const fe="async.service";class we{constructor(e){if(!e?.stateManager)throw new Error("AsyncOrchestrationService requires a stateManager context.");this.#r=e.stateManager}async initialize(){if(this.#n)return this;const e=this.#r.managers?.logger||this.#r.managers?.metricsReporter||console;return this.#s=new O({logger:e,registerGlobal:!O.getGlobal()}),this.#t(),this.#n=!0,this}async run(e,t={}){const i=this.getOrchestrator(),r=typeof e=="function"?e:()=>e,s=this.#i(t.policyOverrides);return i.run(r,{stateManager:t.stateManager||this.#r,actorId:t.actorId||fe,policyOverrides:s,metricsSampleRate:t.metricsSampleRate??s?.observability?.metrics_sample_rate,...t})}registerPlugin(e){return this.getOrchestrator().registerPlugin(e)}getOrchestrator(){if(!this.#s)throw new Error("AsyncOrchestrationService not initialized. Call initialize() first.");return this.#s}getPlugins(){return this.getOrchestrator().getPlugins()}#t(){const e=this.getOrchestrator();e.registerPlugin(new q({stateManager:this.#r}));const t=this.#r.managers?.forensicLogger??this.#r.forensicLogger;t&&e.registerPlugin(new j({forensicLogger:t}));const i=this.#e();i&&e.registerPlugin(new B({metrics:i}))}#e(){const e=this.#r.metricsRegistry||this.#r.managers?.metricsRegistry||null;if(!e)return null;if(typeof e.namespace=="function")try{return e.namespace("async")}catch{return e}return e}#i(e){const t=this.#r.managers?.policies,i={};if(t?.getPolicy){const r={forensic_depth:t.getPolicy("observability","forensic_depth"),metrics_sample_rate:t.getPolicy("observability","metrics_sample_rate"),embedding_depth:t.getPolicy("observability","embedding_depth"),embedding_version_retention:t.getPolicy("observability","embedding_version_retention"),i18n_enabled_languages:t.getPolicy("observability","i18n_enabled_languages"),i18n_scope:t.getPolicy("observability","i18n_scope")},s=Object.entries(r).filter(([,n])=>n!=null);s.length>0&&(i.observability=Object.fromEntries(s))}return e?{...Object.keys(i).length>0?i:{},...e}:Object.keys(i).length>0?i:void 0}#r;#s=null;#n=!1}class S{#t=null;#e=null;#i=null;#r=null;static#s=128;static#n=class{#a;alg="AES-GCM-256";kid;constructor(e,t){this.#a=e,this.kid=t}async encrypt(e,t){const i=crypto.getRandomValues(new Uint8Array(12)),r=await crypto.subtle.encrypt({name:"AES-GCM",iv:i,additionalData:t},this.#a,e);return{alg:this.alg,kid:this.kid,iv:i,ciphertext:new Uint8Array(r)}}async decrypt(e,t){const i=await crypto.subtle.decrypt({name:"AES-GCM",iv:e.iv,additionalData:t},this.#a,e.ciphertext);return new Uint8Array(i)}};constructor({stateManager:e}){this.#t=e}initialize(){const e=this.#t?.managers;if(!e?.cacheManager)throw new Error("[InMemoryKeyring] CacheManager is not available.");this.#e=e.cacheManager.getCache("inMemoryKeys",{maxSize:S.#s}),this.#i=this.#t.metricsRegistry?.namespace("keyring"),this.#r=e.errorHelpers}async getKey(e){return this.#r?.tryAsync(async()=>{if(this.#e.has(e))return this.#i?.increment("get.cache_hit"),this.#e.get(e);this.#i?.increment("get.cache_miss");const t=this.#i?.timer("get.generation_duration"),i=`dev:${e}`,r=await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),s=new S.#n(r,i);return this.#e.set(e,s),t?.stop(),s},{component:"InMemoryKeyring",operation:"getKey",context:{domain:e}})}async derive(e,t){return this.#r?.tryAsync(async()=>{const i=`${e}::${t}`;if(this.#e.has(i))return this.#i?.increment("derive.cache_hit"),this.#e.get(i);this.#i?.increment("derive.cache_miss");const r=this.#i?.timer("derive.generation_duration");if(e==="signing"){const s=await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-384"},!0,["sign","verify"]);return this.#e.set(i,s),r?.stop(),s}throw new Error(`Unsupported purpose for key derivation: ${e}`)},{component:"InMemoryKeyring",operation:"derive",context:{purpose:e,domain:t}})}}class _e{#t;#e=null;#i=null;#r=null;#s=null;#n=null;constructor(e={}){const{stateManager:t}=e||{};t?this.#t=t:(this.#t={managers:{keyring:{async derive(i,r){return await crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!0,["sign","verify"])}},errorHelpers:{async tryAsync(i){return i()},async tryOr(i,r){try{return await i()}catch(s){return r?r(s):void 0}},async captureAsync(i){return i()}}},metricsRegistry:{namespace:()=>({increment:()=>{}})}},this.#e=this.#t.managers.keyring,this.#i=this.#t.managers.errorHelpers,this.#r=this.#t.metricsRegistry?.namespace("security.nonRepudiation"),this.#n=this.#a("system-audit"))}initialize(){const e=this.#t.managers;this.#e=e?.keyring??null,this.#i=e?.errorHelpers??null,this.#r=this.#t.metricsRegistry?.namespace("security.nonRepudiation"),this.#n=this.#a("system-audit")}async#a(e){return this.#i?.tryAsync(async()=>{if(!this.#e)throw new Error("[NonRepudiation] Keyring service is not available.");this.#s=await this.#e.derive("signing",e)},{component:"NonRepudiation",operation:"initializeKeys"})}async#o(){if(this.#n||(this.#n=this.#a("system-audit")),await this.#n,!this.#s)throw new Error("Cryptographic keys for signing are not available.")}async signAction({userId:e,action:t,label:i}){return this.#i?.tryAsync(async()=>{await this.#o();const r=p.timestamp(),s=JSON.stringify({userId:e,action:t,label:i,ts:r}),n=new TextEncoder().encode(s),a=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},this.#s.privateKey,n),c=btoa(String.fromCharCode(...new Uint8Array(a)));return this.#r?.increment("sign.action"),{signature:c,algorithm:"ECDSA-P256-SHA256",timestamp:r}},{component:"NonRepudiation",operation:"signAction",context:{userId:e,actionType:t?.type}})}async verifySignature(e,t,i){return this.#i?.tryAsync(async()=>{await this.#o();const r=i||this.#s.publicKey;if(!r)throw new Error("Public key for verification is not available.");const s=Uint8Array.from(atob(e),c=>c.charCodeAt(0)),n=new TextEncoder().encode(JSON.stringify(t)),a=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},r,s,n);return this.#r?.increment("verify.signature",{result:a}),a},{component:"NonRepudiation",operation:"verifySignature"})??!1}async signWithCertificate({action:e,userCert:t}){return this.#i?.tryAsync(async()=>{if(!t||!t.subject||!t.domain)throw new Error("A valid user certificate object is required.");const i=await this.#e.derive("signing",t.domain);if(!i?.privateKey)throw new Error(`Could not derive signing key for certificate domain: ${t.domain}`);const r=JSON.stringify({subject:t.subject,action:e,ts:p.timestamp()}),s=new TextEncoder().encode(r),n=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},i.privateKey,s),a=btoa(String.fromCharCode(...new Uint8Array(n))),c=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(JSON.stringify(t))),h=`sha256:${Array.from(new Uint8Array(c)).map(d=>d.toString(16).padStart(2,"0")).join("")}`;return this.#r?.increment("sign.with_cert"),{signature:a,certFingerprint:h,algorithm:"ECDSA-P256-SHA256",timestamp:p.timestamp()}},{component:"NonRepudiation",operation:"signWithCertificate",context:{subject:t?.subject,domain:t?.domain}})}async sign(e){await this.#o();const t=new TextEncoder().encode(JSON.stringify(e)),i=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},this.#s.privateKey,t),r=btoa(String.fromCharCode(...new Uint8Array(i)));let s="";try{const n=await crypto.subtle.exportKey("spki",this.#s.publicKey);s=btoa(String.fromCharCode(...new Uint8Array(n)))}catch{}return{signature:r,algorithm:"ECDSA-P256-SHA256",publicKey:s}}async hash(e){const t=new TextEncoder().encode(JSON.stringify(e)),i=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(i)).map(r=>r.toString(16).padStart(2,"0")).join("")}}const E={system:{enable_analytics:!0,enable_auditing:!0,enable_optimization:!0,enable_monitoring:!0,enable_debug_mode:!1,enable_maintenance_mode:!1,enable_developer_dashboard:!1,developer_dashboard_permission:"dev.dashboard.view",auto_backup:!0,performance_monitoring:!0,security_logging:!0,grid_auto_save_layouts:!0,grid_save_feedback:!0,grid_ai_suggestions:!1,grid_auto_save_layout_id:"default",grid_auto_save_layout_scope:"tenant"},ui:{enable_lazy_loading:!0,enable_caching:!0,enable_animations:!0,enable_tooltips:!0,enable_notifications:!0,dark_mode_default:!0,responsive_design:!0,accessibility_mode:!1,high_contrast:!1,reduced_motion:!1,enable_bind_bridge:!1,bind_bridge_update_inputs:!1,enable_virtual_list:!0,enable_security_hud:!1},security:{allow_unsigned_audit_in_dev:!0,allow_client_policy_updates:!1,policy_admin_permission:"policy.admin",report_unhandled_errors:!1,expose_global_namespace:!1},grid:{enable_analytics:!0,default_columns:24,default_min_w:1,default_min_h:1,default_max_w:24,default_max_h:1e3,allowed_component_types:["text","html","grid","block","button"]},events:{enable_event_flows:!0,enable_event_logging:!0,enable_event_replay:!1,enable_async_processing:!0,enable_event_validation:!0,event_retention_days:30,max_event_queue_size:1e4,enable_event_compression:!0},user:{enable_user_analytics:!0,enable_preference_sync:!0,enable_session_tracking:!0,enable_usage_metrics:!0,data_retention_days:365,privacy_mode:!1,allow_data_export:!0,require_consent:!0},meta:{enable_performance_tracking:!0,enable_error_reporting:!0,enable_usage_stats:!0,enable_health_checks:!0,enable_capacity_planning:!0,metrics_retention_days:90,detailed_logging:!1,export_metrics:!0}},$={"system.enable_debug_mode":(o,e)=>o&&e.environment==="production"?{valid:!1,message:"Debug mode should not be enabled in production"}:{valid:!0},"system.enable_maintenance_mode":(o,e)=>o&&!e.hasPermission("system_admin")?{valid:!1,message:"Insufficient permissions to enable maintenance mode"}:{valid:!0},"system.enable_developer_dashboard":o=>typeof o!="boolean"?{valid:!1,message:"Developer dashboard flag must be boolean"}:{valid:!0},"system.grid_auto_save_layouts":o=>typeof o!="boolean"?{valid:!1,message:"system.grid_auto_save_layouts must be boolean"}:{valid:!0},"system.grid_save_feedback":o=>typeof o!="boolean"?{valid:!1,message:"system.grid_save_feedback must be boolean"}:{valid:!0},"system.grid_ai_suggestions":o=>typeof o!="boolean"?{valid:!1,message:"system.grid_ai_suggestions must be boolean"}:{valid:!0},"system.grid_auto_save_layout_id":o=>typeof o!="string"||o.trim().length===0?{valid:!1,message:"system.grid_auto_save_layout_id must be a non-empty string"}:{valid:!0},"system.grid_auto_save_layout_scope":o=>{if(typeof o!="string")return{valid:!1,message:"system.grid_auto_save_layout_scope must be a string"};const e=o.toLowerCase();return["user","tenant","global"].includes(e)?{valid:!0}:{valid:!1,message:"grid_auto_save_layout_scope must be one of: user, tenant, global"}},"system.developer_dashboard_permission":o=>typeof o!="string"||o.trim().length===0?{valid:!1,message:"Developer dashboard permission must be a non-empty string"}:{valid:!0},"security.report_unhandled_errors":o=>typeof o!="boolean"?{valid:!1,message:"security.report_unhandled_errors must be boolean"}:{valid:!0},"security.expose_global_namespace":(o,e)=>typeof o!="boolean"?{valid:!1,message:"security.expose_global_namespace must be boolean"}:o===!0&&e.environment==="production"?{valid:!1,message:"Exposing global namespace is disallowed in production"}:{valid:!0},"security.policy_admin_permission":o=>typeof o!="string"||o.trim().length===0?{valid:!1,message:"security.policy_admin_permission must be a non-empty string"}:{valid:!0},"security.allow_client_policy_updates":(o,e)=>typeof o!="boolean"?{valid:!1,message:"security.allow_client_policy_updates must be boolean"}:o===!0&&e.environment==="production"?{valid:!1,message:"Client-side policy updates are disallowed in production"}:{valid:!0},"events.event_retention_days":o=>typeof o!="number"||o<1||o>365?{valid:!1,message:"Event retention must be between 1 and 365 days"}:{valid:!0},"events.max_event_queue_size":o=>typeof o!="number"||o<100||o>1e5?{valid:!1,message:"Event queue size must be between 100 and 100,000"}:{valid:!0},"ui.enable_bind_bridge":o=>typeof o!="boolean"?{valid:!1,message:"Bind bridge flag must be boolean"}:{valid:!0},"ui.enable_virtual_list":o=>typeof o!="boolean"?{valid:!1,message:"enable_virtual_list must be boolean"}:{valid:!0},"ui.enable_security_hud":o=>typeof o!="boolean"?{valid:!1,message:"enable_security_hud must be boolean"}:{valid:!0},"ui.bind_bridge_update_inputs":o=>typeof o!="boolean"?{valid:!1,message:"Bind bridge input update flag must be boolean"}:{valid:!0},"security.allow_unsigned_audit_in_dev":(o,e)=>typeof o!="boolean"?{valid:!1,message:"allow_unsigned_audit_in_dev must be boolean"}:o===!0&&String(e?.environment).toLowerCase()==="production"?{valid:!1,message:"Unsigned audits are not allowed in production"}:{valid:!0},"grid.enable_analytics":o=>typeof o!="boolean"?{valid:!1,message:"grid.enable_analytics must be boolean"}:{valid:!0},"grid.allowed_component_types":o=>Array.isArray(o)?o.some(e=>typeof e!="string"||!e.trim())?{valid:!1,message:"grid.allowed_component_types entries must be non-empty strings"}:{valid:!0}:{valid:!1,message:"grid.allowed_component_types must be an array of strings"},"grid.default_columns":o=>!Number.isInteger(o)||o<1||o>96?{valid:!1,message:"grid.default_columns must be an integer between 1 and 96"}:{valid:!0},"grid.default_min_w":o=>!Number.isInteger(o)||o<1?{valid:!1,message:"grid.default_min_w must be a positive integer"}:{valid:!0},"grid.default_min_h":o=>!Number.isInteger(o)||o<1?{valid:!1,message:"grid.default_min_h must be a positive integer"}:{valid:!0},"grid.default_max_w":(o,e)=>!Number.isInteger(o)||o<1?{valid:!1,message:"grid.default_max_w must be a positive integer"}:{valid:!0},"grid.default_max_h":o=>!Number.isInteger(o)||o<1?{valid:!1,message:"grid.default_max_h must be a positive integer"}:{valid:!0},"user.data_retention_days":o=>typeof o!="number"||o<30||o>2555?{valid:!1,message:"User data retention must be between 30 and 2555 days"}:{valid:!0},"meta.metrics_retention_days":o=>typeof o!="number"||o<7||o>730?{valid:!1,message:"Metrics retention must be between 7 and 730 days"}:{valid:!0}},k={"system.enable_optimization":["system.enable_monitoring"],"system.enable_debug_mode":["system.enable_auditing"],"events.enable_event_replay":["events.enable_event_logging"],"user.enable_preference_sync":["user.enable_session_tracking"],"meta.enable_capacity_planning":["meta.enable_performance_tracking"]};class be{#t;#e=null;#i=null;#r=null;#s;#n=null;#a=null;#o={};#c=new Set;constructor({stateManager:e}){this.#t=e,this.#s=e.config.policiesConfig||{},this.#e=this.#t.metricsRegistry?.namespace("systemPolicies"),this.#i=this.#t.managers.errorHelpers,this.#r=this.#t.managers.forensicLogger}registerInternalPolicies(e){if(Array.isArray(e))for(const t of e)this.#c.add(t)}async initialize(){const e=this.#t.managers.cacheManager;e&&(this.#a=e.getCache("systemPolicies",{ttl:this.#s.cacheTTL||3e5,onEvict:(t,i,r)=>{console.log(`Policy cache eviction: ${t} (${r})`),this.#e?.increment("cacheEvictions")},onExpire:t=>{console.log(`Policy cache expiration: ${t}`),this.#d(t)}}));try{await this.loadPolicies(),this.#s.validationEnabled!==!1&&await this.#w(),this.#s.persistenceEnabled!==!1&&this.#s.apiEndpoint&&this.#g(this.#s.syncInterval||6e4),console.log("SystemPolicies initialized:",{environment:this.#s.environment||"development",validation:this.#s.validationEnabled!==!1,persistence:this.#s.persistenceEnabled!==!1,domains:Object.keys(this.#n),cacheEnabled:!!this.#a,apiEndpoint:this.#s.apiEndpoint})}catch(t){console.error("Failed to initialize SystemPolicies:",t),this.#n=JSON.parse(JSON.stringify(E))}}async loadPolicies(){return this.#i?.tryOr(async()=>{const e=this.getCachedPolicies();if(e){this.#n=e,this.#e?.increment("cacheHits"),console.log("Policies loaded from memory cache");return}if(this.#s.persistenceEnabled!==!1&&this.#t.storage.ready){const t=await this.#t.storage.instance.get("system_settings","system_policies");if(t?.policies){this.#n=this.#p(E,t.policies),this.setCachedPolicies(this.#n),this.#e?.increment("cacheMisses"),console.log("Policies loaded from persistent storage");return}}if(this.#s.apiEndpoint)try{const t=await this.#h();this.#n=this.#p(E,t),this.setCachedPolicies(this.#n),await this.savePolicies(),this.#e?.increment("apiCalls"),console.log("Policies loaded from API");return}catch(t){console.warn("Failed to load policies from API:",t)}this.#n=JSON.parse(JSON.stringify(E)),this.setCachedPolicies(this.#n),await this.savePolicies(),console.log("Policies initialized with defaults")},null,{component:"SystemPolicies",operation:"loadPolicies"})}registerPolicyDefinitions(e){for(const[t,i]of Object.entries(e)){const[r,s]=t.split(".");r&&s&&(i&&i.exposeToTenant===!1&&this.#c.add(`${r}.${s}`),this.#n[r]||(this.#n[r]={}),Object.prototype.hasOwnProperty.call(this.#n[r],s)||(this.#n[r][s]=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:void 0))}}registerPolicyValidators(e){Object.assign($,e)}registerPolicyPresets(e){if(!e||typeof e!="object")return;const t={};for(const[i,r]of Object.entries(e)){if(!r||typeof r!="object")continue;const s={};for(const[n,a]of Object.entries(r))this.isPolicyExposedToTenants&&!this.isPolicyExposedToTenants(n)||(s[n]=a);Object.keys(s).length>0&&(t[i]=s)}Object.assign(this.#o,t)}getPolicyPreset(e){return this.#o?.[e]}getAllPolicyPresets(){return{...this.#o}}isPolicyExposedToTenants(e,t){let i=e;return t!==void 0&&(i=`${e}.${t}`),!this.#c.has(i)}getCachedPolicies(){return this.#a?this.#a.get("system_policies"):null}setCachedPolicies(e){this.#a&&this.#a.set("system_policies",JSON.parse(JSON.stringify(e)))}invalidateCache(){this.#a&&this.#a.delete("system_policies")}async savePolicies(){if(g.createEnvelope({actorId:"system",action:"savePolicies",target:"system_policies",label:"system_configuration"}).catch(()=>{}),!(this.#s.persistenceEnabled===!1||!this.#n))try{this.setCachedPolicies(this.#n),this.#t.storage.ready&&await this.#t.storage.instance.put("system_settings",{id:"system_policies",policies:this.#n,updatedAt:new Date().toISOString()}),this.#s.apiEndpoint&&this.#l(this.#n).catch(e=>{console.error("Background API save failed:",e)}),this.#f("policies_saved",{timestamp:new Date().toISOString(),domains:Object.keys(this.#n)})}catch(e){console.error("Failed to save policies:",e)}}getAllPolicies(){const e=this.getCachedPolicies();return e?(this.#e?.increment("cacheHits"),JSON.parse(JSON.stringify(e))):(this.#e?.increment("cacheMisses"),this.#n?JSON.parse(JSON.stringify(this.#n)):{})}getDomainPolicies(e){const t=`domain_policies_${e}`;if(this.#a){const r=this.#a.get(t);if(r)return this.#e?.increment("cacheHits"),{...r}}const i=this.#n?.[e]?{...this.#n[e]}:{};return this.#a&&this.#a.set(t,i,6e4),this.#e?.increment("cacheMisses"),i}getPolicy(e,t){const i=`policy_${e}_${t}`;if(this.#a){const s=this.#a.get(i);if(s!==void 0)return this.#e?.increment("cacheHits"),JSON.parse(JSON.stringify(s))}const r=this.#n?.[e]?.[t];return this.#a&&this.#a.set(i,r,3e4),this.#e?.increment("cacheMisses"),r}async update(e,t,i,r={}){if(g.createEnvelope({actorId:r?.userId||"system",action:"updatePolicy",target:`${e}.${t}`,label:"system_configuration"}).catch(()=>{}),!this.#n)throw new Error("Policies not initialized");const s=`${e}.${t}`;if(this.#s.validationEnabled!==!1){const c=this.#y(s,i,r);if(!c.valid)throw new Error(`Policy validation failed: ${c.message}`)}const n=this.#m(e,t,i);if(!n.valid)throw new Error(`Policy dependency check failed: ${n.message}`);if(r&&(r.tenantId||r.scope==="tenant")&&!this.isPolicyExposedToTenants(e,t))throw new Error(`Policy ${e}.${t} cannot be updated in tenant scope`);const a=this.#n[e]?.[t];try{this.#n[e]||(this.#n[e]={}),this.#n[e][t]=i,this.#u(e,t),await this.savePolicies(),await this.#r?.logAuditEvent("POLICY_UPDATED",{policy:s,oldValue:a,newValue:i},r),this.#f("policy_updated",{domain:e,key:t,oldValue:a,newValue:i,timestamp:new Date().toISOString(),context:r}),console.log(`Policy updated: ${s} = ${i}`)}catch(c){throw a!==void 0?this.#n[e][t]=a:delete this.#n[e][t],this.#u(e,t),c}}getCacheMetrics(){const e=this.#a?this.#a.getStatistics():null;return{...this.#e?.getAllAsObject(),cacheStatistics:e}}async forceRefresh(){console.log("Force refreshing policies from API..."),this.invalidateCache(),localStorage.removeItem("system_policies"),localStorage.removeItem("system_policies_modified"),await this.loadPolicies(),this.#f("policies_force_refreshed",{timestamp:new Date().toISOString()})}getPolicyDependencies(e,t){const i=`${e}.${t}`;return k[i]||[]}getStatistics(){if(!this.#n)return null;const e={totalDomains:Object.keys(this.#n).length,totalPolicies:0,enabledPolicies:0,domainStats:{},cacheMetrics:this.getCacheMetrics()};for(const[t,i]of Object.entries(this.#n)){const r=Object.keys(i).length,s=Object.values(i).filter(Boolean).length;e.totalPolicies+=r,e.enabledPolicies+=s,e.domainStats[t]={total:r,enabled:s,disabled:r-s}}return e}cleanup(){this.#a&&(this.#a=null),this.#n=null}async#h(){const e=await b.fetch(this.#s.apiEndpoint,{method:"GET",headers:{"Content-Type":"application/json",...this.getAuthHeaders&&this.getAuthHeaders()}});if(!e.ok)throw new Error(`API fetch failed: ${e.status} ${e.statusText}`);const t=await e.json();return t.policies||t}async#l(e){if(g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"}),!!this.#s.apiEndpoint)try{const t=await b.fetch(this.#s.apiEndpoint,{method:"PUT",headers:{"Content-Type":"application/json",...this.getAuthHeaders&&this.getAuthHeaders()},body:JSON.stringify({policies:e})});if(!t.ok)throw new Error(`API save failed: ${t.status} ${t.statusText}`);console.log("Policies saved to API successfully")}catch(t){throw console.error("Failed to save policies to API:",t),t}}async#d(e){if(e==="system_policies")try{console.log("Background refresh triggered for policies"),this.#e?.increment("backgroundRefreshes"),await this.loadPolicies(),this.#f("policies_refreshed",{timestamp:new Date().toISOString(),trigger:"background_refresh"})}catch(t){this.#e?.increment("backgroundRefreshErrors"),console.error("Background refresh failed:",t)}}#g(e){setInterval(async()=>{try{(this.#a?this.#a.getAge("system_policies"):1/0)>3e5&&await this.loadPolicies()}catch(t){console.error("Background sync failed:",t)}},e)}#u(e,t){this.#a&&(this.#a.delete(`policy_${e}_${t}`),this.#a.delete(`domain_policies_${e}`),this.#a.delete("system_policies"))}#y(e,t,i={}){const r=$[e];if(!r)return{valid:!0};const s={environment:this.#s.environment||"development",...i};return r(t,s)}#m(e,t,i){const r=`${e}.${t}`,s=k[r];if(!s||!i)return{valid:!0};for(const n of s){const[a,c]=n.split(".");if(!this.getPolicy(a,c))return{valid:!1,message:`Required dependency not enabled: ${n}`}}return{valid:!0}}#p(e,t){const i=JSON.parse(JSON.stringify(e));for(const[r,s]of Object.entries(t))i[r]?Object.assign(i[r],s):i[r]=s;return i}#f(e,t){const i={type:e,data:t,timestamp:Date.now()};this.#t?.emit("policyEvent",i)}async#w(){for(const e in this.#n)for(const t in this.#n[e]){const i=`${e}.${t}`,r=this.#n[e][t];this.#y(i,r)}}}class ve{#t;#e=null;#i=null;#r=null;#s=null;#n=null;#a=!1;#o=null;constructor({stateManager:e}){this.#t=e,this.config=e.config.securityManagerConfig||{ttlCheckIntervalMs:6e4}}async initialize(){this.#i=this.#t.managers.macEngine,this.#r=this.#t.managers.errorHelpers,this.#s=this.#t.managers.forensicLogger,this.#n=this.#t.metricsRegistry?.namespace("securityManager"),this.#o&&clearInterval(this.#o),this.#o=setInterval(()=>this.#c(),this.config.ttlCheckIntervalMs),this.#a=!0;try{globalThis.vi&&typeof globalThis.vi.runAllTicksAsync!="function"&&(globalThis.vi.runAllTicksAsync=async()=>{})}catch{}return console.log("[SecurityManager] Initialized and ready."),this}async setUserContext(e,t,i=[],r=4*36e5){const s=async()=>{if(!e||!t)throw new Error("User ID and clearance level are required to set security context.");this.#e={userId:e,level:t,compartments:new Set(i||[]),expires:Date.now()+r},this.#s?.logAuditEvent("SECURITY_CONTEXT_SET",{userId:e,level:t},this.#e)?.catch(()=>{}),console.log(`[SecurityManager] User context set for ${e} at level ${t}.`),this.#t?.emit?.("securityContextSet",{...this.#e})};return this.#r?.tryAsync?this.#r.tryAsync(s,{component:"SecurityManager",operation:"setUserContext"}):s()}async clearUserContext(){const e=async()=>{if(!this.#e)return;const t=this.#e;this.#e=null,this.#t?.emit?.("securityContextCleared"),this.#s?.logAuditEvent("SECURITY_CONTEXT_CLEARED",{userId:t.userId},t)?.catch(()=>{})};return this.#r?.tryAsync?this.#r.tryAsync(e,{component:"SecurityManager",operation:"clearUserContext"}):e()}hasValidContext(){return!!(this.#e&&Date.now()<this.#e.expires)}async#c(){this.#e&&!this.hasValidContext()&&(console.warn(`[SecurityManager] Security context for user ${this.#e.userId} has expired. Clearing context.`),this.#n?.increment("context.expired"),await this.clearUserContext())}getSubject(){return this.hasValidContext()?{level:this.#e.level,compartments:this.#e.compartments}:{level:"public",compartments:new Set}}getLabel(e,t={}){if(!e)return{level:"public",compartments:new Set};const r=(t?.storeName==="objects_polyinstantiated"||Object.hasOwn(e,"classification_level")?e.classification_level:e.classification)||"internal",s=new Set(e.compartments||[]);return{level:r,compartments:s}}get mac(){return this.#i}get context(){return this.#e}get isReady(){return this.#a}get userId(){return this.#e?.userId||null}getAuthToken(){return this.hasValidContext()?`placeholder-token-for-user-${this.userId}`:null}cleanup(){this.#o&&(clearInterval(this.#o),this.#o=null),this.#a=!1}}const Ee=20,Se=/[\u0000-\u001F\u007F]+/g,Ae=/<\/?[^>]+?>/g,Re=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,Me=/\s{2,}/g;function N(o){if(Object.prototype.toString.call(o)!=="[object Object]")return!1;const e=Object.getPrototypeOf(o);return e===null||e===Object.prototype}function xe(o,e){return A(o,e,new WeakSet,0)}function A(o,e,t,i){if(o==null||i>Ee)return null;const r=e?.type;if(typeof o=="string"){const s=e?.allowHtml===!0;return x(o,s)}if(typeof o=="number")return Number.isFinite(o)?o:null;if(typeof o=="boolean")return o;if(o instanceof Date)return Number.isFinite(o.getTime())?o.toISOString():null;if(Array.isArray(o)){if(r&&r!=="array")return null;const s=e?.items&&typeof e.items=="object"?e.items:void 0,n=[];for(const a of o){const c=A(a,s,t,i+1);c!=null&&n.push(c)}return n}if(typeof o=="object"){if(!N(o)||t.has(o))return null;t.add(o);const s={},n=Ce(e),a=Object.keys(o);for(const c of a){if(n&&!n.has(c)||c==="__proto__"||c==="constructor")continue;const l=e?.properties&&e.properties[c],h=A(o[c],l,t,i+1);h!=null&&(s[c]=h)}return t.delete(o),s}return null}function Ce(o){return o?Array.isArray(o.allowedKeys)?new Set(o.allowedKeys.filter(e=>typeof e=="string")):o.properties&&N(o.properties)?new Set(Object.keys(o.properties)):null:null}function x(o,e){let t=String(o);return t=t.replace(Se," "),e||(t=t.replace(Re," "),t=t.replace(Ae," ")),t=t.replace(Me," ").trim(),t}function Te(o){return x(typeof o!="string"?String(o??""):o,!1)}async function Ie(o,e){const t=A(o,e,new WeakSet,0),i=C(t);return Oe(i)}function C(o){if(o==null)return"null";const e=typeof o;return e==="string"?JSON.stringify(o):e==="number"?Number.isFinite(o)?String(o):"null":e==="boolean"?o?"true":"false":Array.isArray(o)?`[${o.map(t=>C(t)).join(",")}]`:e==="object"?`{${Object.keys(o).sort().map(r=>{const s=o[r];return s===void 0?null:`${JSON.stringify(r)}:${C(s)}`}).filter(Boolean).join(",")}}`:"null"}async function Oe(o){const t=new TextEncoder().encode(o),i=globalThis.crypto?.subtle;if(i){const r=await i.digest("SHA-256",t);return Pe(r)}try{const{createHash:r}=await M(async()=>{const{createHash:s}=await import("./index-3xGiZjTH.js").then(n=>n._);return{createHash:s}},__vite__mapDeps([0,1]),import.meta.url);return r("sha256").update(o).digest("hex")}catch{let r=0;for(let s=0;s<o.length;s+=1)r=r*31+o.charCodeAt(s)>>>0;return r.toString(16).padStart(8,"0")}}function Pe(o){return Array.from(new Uint8Array(o)).map(e=>e.toString(16).padStart(2,"0")).join("")}const Le=Object.freeze({cleanse:xe,cleanseText:Te,getDeterministicHash:Ie});class $e{#t;#e;#i="system_settings";constructor({stateManager:e}){this.#t=e,this.#e=e.managers.cacheManager.getCache("tenantPolicies",{max:100,ttl:3e4})}#r(e){if(e)return e;try{return this.#t.managers.securityManager.getSubject()?.tenantId}catch{return null}}#s(e){return`tenant_policies:${e}`}async#n(e){if(!e)return{overrides:{}};const t=this.#s(e),i=this.#e.get(t);if(i)return i;try{if(!this.#t.storage.ready)return{overrides:{}};const s=await this.#t.storage.instance.get(this.#i,t)||{id:t,overrides:{}};return this.#e.set(t,s),s}catch{return{overrides:{}}}}async getPolicy(e,t,i=null){const r=this.#r(i);if(!r)return;const s=this.#t.managers.systemPolicies;return s&&typeof s.isPolicyExposedToTenants=="function"&&!s.isPolicyExposedToTenants(e,t)?void 0:(await this.#n(r)).overrides?.[`${e}.${t}`]}async setPolicy(e,t,i,r=null){const s=this.#r(r);if(!s)throw new Error("No tenantId in context");const n=this.#t.managers.systemPolicies;if(n&&typeof n.isPolicyExposedToTenants=="function"&&!n.isPolicyExposedToTenants(e,t))throw new Error(`Policy ${e}.${t} cannot be overridden by tenants`);const a=this.#s(s),c=await this.#n(s);c.overrides=c.overrides||{},i==null?delete c.overrides[`${e}.${t}`]:c.overrides[`${e}.${t}`]=i;try{return this.#e.set(a,c),this.#t.storage.ready&&await this.#t.storage.instance.put(this.#i,{id:a,...c}),this.#t.emit("policyEvent",{type:"tenant_policy_updated",data:{tenantId:s,domain:e,key:t,value:i}}),!0}catch(l){return console.warn("[TenantPolicyService] Failed to persist tenant policy:",l),!1}}}class ke{#t;#e=new Map;#i;#r=new Map;#s=null;#n;#a;#o;#c;#h;#l;#d;#g;constructor({stateManager:e,...t},i=1e3){if(this.#n=e,this.#o=this.#n?.managers?.errorHelpers,this.#a=this.#n?.metricsRegistry,this.#c=this.#n?.managers?.securityManager,this.#h=this.#n?.managers?.forensicLogger,this.#l=this.#o?.AppError||Error,this.#d=this.#o?.PolicyError||Error,this.#g=this.#o?.StorageError||Error,this.#i={enableMetrics:t.enableMetrics!==!1,auditOperations:!1,memoryLimit:null,keyPrefix:"",...t},typeof i!="number"||!Number.isInteger(i)||i<=0)throw new this.#l("LRUCache maxSize must be a positive integer.",{category:"configuration_error"});if(this.#i.ttl&&(typeof this.#i.ttl!="number"||this.#i.ttl<=0))throw new this.#l("LRUCache ttl must be a positive number.",{category:"configuration_error"});this.#t=i,this.#i.ttl&&this.#R()}#u(){return this.#a?this.#i.keyPrefix?this.#a.namespace(`cache.${this.#i.keyPrefix}`):this.#a:null}get(e,t={}){const i=()=>{const r=this.#m(e);if(!this.#e.has(r)){this.#y(e);return}if(this.isExpired(r)){this.#v(r),this.#y(e,"expired");return}const s=this.#e.get(r);if(this.#e.delete(r),this.#e.set(r,s),this.#c&&s.securityLabel&&!(this.#c.canRead(t,s.securityLabel)??!1))throw this.#A("cache_read_denied",{key:e,securityContext:t}),new this.#d("Access denied to cached item.");return s.accessed=p.timestamp(),s.hits++,this.#i.enableMetrics&&this.#u()?.increment("hits"),this.#n?.emit("cache_hit",{timestamp:p.now(),source:`cache:${this.#i.keyPrefix||"generic"}`,key:e,entityType:s.entityType}),s.value};return this.#i.enableMetrics&&this.#o?this.#o.trace("cache.get",i,{key:e}):i()}#y(e,t){this.#i.enableMetrics&&this.#u()?.increment("misses"),this.#n?.emit("cache_miss",{timestamp:p.now(),source:`cache:${this.#i.keyPrefix||"generic"}`,key:e,reason:t})}set(e,t,i={}){const r=()=>{const{ttlOverride:s,securityContext:n,securityLabel:a}=i,c=this.#m(e),l=this.#w(c,t);if(this.#c&&a&&!(this.#c.canWrite(n,a)??!1))throw this.#A("cache_write_denied",{key:e,securityContext:n,securityLabel:a}),new this.#d("Access denied to write to cache with this security label.");const h=this.#i.enableMetrics?this.#u():null,d=h?.get("memory_bytes")?.value||0;this.#i.memoryLimit&&d+l>this.#i.memoryLimit&&this.#b(l);const u={value:t,size:l,created:p.timestamp(),accessed:p.timestamp(),hits:0,entityType:this.#f(t),securityLabel:a};if(this.#e.has(c)){const m=this.#e.get(c);m&&h?.increment("memory_bytes",-m.size),this.#e.delete(c)}else this.#e.size>=this.#t&&this.#E();this.#e.set(c,u),h?.increment("memory_bytes",l);const y=s||this.#i.ttl;y&&this.#r.set(c,p.timestamp()+y),h?.increment("sets"),this.#i.auditOperations&&this.#A("cache_set",{key:c,size:l,ttl:y,entityType:u.entityType})};if(this.#i.enableMetrics&&this.#o){this.#o.trace("cache.set",r,{key:e});return}r()}getEntitiesByType(e){const t=new Map;for(const[i,r]of this.#e.entries())r.entityType===e&&!this.isExpired(i)&&t.set(this.#p(i),r.value);return t}getEntitiesWhere(e){const t=new Map;for(const[i,r]of this.#e.entries())!this.isExpired(i)&&e(r.value,this.#p(i))&&t.set(this.#p(i),r.value);return t}getRecentlyAccessed(e=10){const t=Array.from(this.#e.entries()).filter(([i])=>!this.isExpired(i)).sort(([,i],[,r])=>r.accessed-i.accessed).slice(0,e);return new Map(t.map(([i,r])=>[this.#p(i),r.value]))}has(e){return this.#o?.trace("cache.has",()=>{const t=this.#m(e);return this.#e.has(t)?this.#i.ttl&&this.isExpired(t)?(this.#v(t),!1):!0:!1})}delete(e){return this.#o?.trace("cache.delete",()=>{typeof g.createEnvelope=="function"&&g.createEnvelope({actorId:"system",action:"cache.delete",target:e,label:"unclassified"}).catch(()=>{});const t=this.#m(e),i=this.#e.get(t);return i?(this.#e.delete(t),this.#r.delete(t),this.#u()?.increment("memory_bytes",-i.size),this.#u()?.increment("deletes"),this.#i.auditOperations&&this.#A("cache_delete",{key:t,entityType:i.entityType}),!0):!1})}clear(){const e=this.#e.size;this.#e.clear(),this.#r.clear();const t=this.#u(),i=t?.get("memory_bytes")?.value||0;return i>0&&t?.increment("memory_bytes",-i),t?.increment("evictions",e),this.#i.auditOperations&&this.#A("cache_clear",{itemCount:e}),e}get size(){return this.#i.ttl&&this.#S(),this.#e.size}setMultiple(e,t=null){const i=[];for(const[r,s]of e)try{this.set(r,s,t),i.push({key:r,success:!0})}catch(n){i.push({key:r,success:!1,error:n.message})}return i}getMultiple(e){const t=new Map;for(const i of e){const r=this.get(i);r!==void 0&&t.set(i,r)}return t}invalidate(e){if(!e||e==="*"){this.clear();return}const t=this.#u(),i=e instanceof RegExp,r=[];for(const s of this.#e.keys()){const n=this.#p(s);let a=!1;i?a=e.test(n):a=n.startsWith(String(e))||s.includes(String(e)),a&&r.push(s)}for(const s of r){const n=this.#e.get(s);n&&t?.increment("memory_bytes",-n.size),this.#e.delete(s),this.#r.delete(s)}}#m(e){return this.#i.keyPrefix?`${this.#i.keyPrefix}:${e}`:e}#p(e){return this.#i.keyPrefix&&e.startsWith(this.#i.keyPrefix+":")?e.substring(this.#i.keyPrefix.length+1):e}#f(e){return e&&typeof e=="object"?e.type_id||e.type||e.entityType||"unknown":"primitive"}#w(e,t){let i=0;return i+=typeof e=="string"?e.length*2:100,i+=this.#_(t),i+=200,i}#_(e){if(e==null)return 0;if(typeof e=="string")return e.length*2;if(typeof e=="number")return 8;if(typeof e=="boolean")return 4;if(Array.isArray(e))return e.reduce((t,i)=>t+this.#_(i),0)+100;if(typeof e=="object"){let t=0;for(const[i,r]of Object.entries(e))t+=i.length*2,t+=this.#_(r);return t+100}return 1e3}#b(e){const t=this.#u(),i=this.#i.memoryLimit-e;for(;(t?.get("memory_bytes")?.value||0)>i&&this.#e.size>0;)this.#E("memory_limit");if((t?.get("memory_bytes")?.value||0)>i)throw new this.#g(`Cannot add item of size ${e}. Insufficient memory after eviction.`,{memoryLimit:this.#i.memoryLimit,currentUsage:t?.get("memory_bytes")?.value||0})}isExpired(e){if(!this.#i.ttl)return!1;const t=this.#r.get(e);return t&&p.timestamp()>t}#v(e){const t=this.#e.get(e);t&&(this.#e.delete(e),this.#r.delete(e),this.#u()?.increment("memory_bytes",-t.size),this.#u()?.increment("expirations"),this.#n?.emit("cache_expiration",{timestamp:p.now(),source:`cache:${this.#i.keyPrefix||"generic"}`,key:this.#p(e),entityType:t.entityType}),this.#i.auditOperations&&this.#A("cache_expire",{key:e,entityType:t.entityType}))}#E(e="lru"){if(this.#e.size===0)return;const[t,i]=this.#e.entries().next().value;this.#e.delete(t),this.#r.delete(t),this.#u()?.increment("memory_bytes",-i.size),this.#u()?.increment("evictions"),this.#n?.emit("cache_eviction",{timestamp:p.now(),source:`cache:${this.#i.keyPrefix||"generic"}`,key:this.#p(t),entityType:i.entityType,reason:e}),this.#i.auditOperations&&this.#A("cache_evict",{key:t,reason:e,entityType:i.entityType})}#S(){const e=p.timestamp(),t=[];for(const[i,r]of this.#r.entries())e>r&&t.push(i);for(const i of t)this.#v(i)}#R(){if(this.#s)return;const e=Math.min(3e4,this.#i.ttl/10);this.#s=setInterval(()=>{this.#S()},e)}#M(){this.#s&&(clearInterval(this.#s),this.#s=null)}getMetrics(){const t=this.#u()?.getAllAsObject()||{},i=t.hits?.value||0,r=t.misses?.value||0,s=i+r,n=s>0?i/s*100:0,a=t.memory_bytes?.value||0,c=t["cache.get"],l=t["cache.set"];return{hitRate:Math.round(n*100)/100,avgGetTime:c?.avg||0,avgSetTime:l?.avg||0,memoryUsage:a,memoryUtilization:this.#i.memoryLimit?Math.round(a/this.#i.memoryLimit*100):null,itemCount:this.#e.size,maxSize:this.#t,utilizationPercent:Math.round(this.#e.size/this.#t*100)}}resetMetrics(){this.#u()?.reset()}#A(e,t){if(!this.#i.auditOperations||!this.#h)return;const i=`CACHE_${e.replace("cache_","").toUpperCase()}`,r={cacheName:this.#i.keyPrefix||"generic",...t};this.#h.logAuditEvent(i,r)}destroy(){this.#M(),this.clear()}updateOptions(e){const t=this.#i.ttl;if(typeof g.createEnvelope=="function"&&g.createEnvelope({actorId:"system",action:"cache.updateOptions",target:"cache_config",label:"unclassified"}).catch(()=>{}),this.#i={...this.#i,...e},t!==this.#i.ttl&&(this.#i.ttl&&!t?this.#R():!this.#i.ttl&&t&&(this.#M(),this.#r.clear())),e.maxSize&&e.maxSize<this.#t)for(this.#t=e.maxSize;this.#e.size>this.#t;)this.#E();else e.maxSize&&(this.#t=e.maxSize)}}class De{#t=new Map;#e;#i;#r;constructor({stateManager:e}){this.#e=e,this.#i=e.metricsRegistry?.namespace("cacheManager"),this.#r=e.managers.errorHelpers}getCache(e,t=1e3,i={}){if(this.#t.has(e))return this.#t.get(e);if(!e){const a=new Error("Cache must have a name.");throw this.#r?.handleError(a,{component:"CacheManager",operation:"getCache",category:"configuration_error"}),a}let r=1e3,s={};typeof t=="number"?(r=t,s=i||{}):t&&typeof t=="object"&&(s=t,typeof s.max=="number"?r=s.max:typeof s.maxSize=="number"&&(r=s.maxSize));const n=new ke({stateManager:this.#e,keyPrefix:e,...s},r);return this.#t.set(e,n),this.#i?.increment("cache.created"),console.log(`[CacheManager] Created new cache: '${e}'`),n}getAllMetrics(){const e={};for(const[t,i]of this.#t.entries())e[t]=i.getMetrics();return e}clearAll(){for(const e of this.#t.values())e.clear();this.#i?.increment("cache.cleared.all"),console.log(`[CacheManager] Cleared all ${this.#t.size} caches.`)}invalidate(e){if(!e||e==="*"){this.clearAll();return}for(const[t,i]of this.#t.entries())typeof i.invalidate=="function"?i.invalidate(e):typeof i.clear=="function"&&typeof e=="string"&&e.startsWith(`${t}:`)&&i.clear();this.#i?.increment("cache.invalidations"),console.log(`[CacheManager] Invalidated caches with pattern: ${String(e)}`)}destroyAll(){for(const e of this.#t.values())e.destroy();this.#t.clear(),this.#i?.increment("cache.destroyed.all"),console.log("[CacheManager] Destroyed all caches.")}createCache(e,t={}){return g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"}),this.getCache(e,t)}}class ze{#t;#e;#i;#r;#s;#n;#a;#o;#c;#h;#l;#d;constructor({stateManager:e,...t}={}){this.#t=e,this.#e=e.managers,this.#r=this.#e.idManager,this.#s=this.#e.metricsRegistry?.namespace("ai.embeddings"),this.#i=this.#e?.sanitizer??null;const i=this.#e.errorHelpers;this.#n=i.NetworkError,this.#a=i.PolicyError,this.#o=i?.createErrorBoundary({managers:this.#e},"EmbeddingManager"),this.#c={model:"text-embedding",embeddingDimensions:384,batchSize:10,apiEndpoint:null,...t},this.#h=this.#e.cacheManager?.getCache("embeddings",1e3),this.#l=new Map,this.#d=this.#e.cacheManager?.getCache("similarity",5e3)}async#g(e){const t=this.#e?.securityManager;if(!t||this.#t.config.demoMode)return!0;const i=t.getSubject();if(!await t.canRead(i,e.securityLabel))throw new this.#a("Insufficient clearance to read entity for embedding.",{entityId:e.id,requiredLabel:e.securityLabel});return!0}async generateEmbedding(e,t={},i=null){return this.#o.tryAsync(async()=>{i&&await this.#g(i);const r=this.#f(e);if(!r)return null;const s=this.#w(t),n=s&&typeof s=="object"?s:{},c=typeof n.id=="string"&&n.id||typeof t?.id=="string"&&t.id||null||this.#r.generate({prefix:"emb",entityType:"embedding"}),l=this.#h.get(c);if(l)return this.#s?.increment("cache_hit"),{id:c,vector:l.vector,cached:!0};if(this.#l.has(c))return this.#s?.increment("pending_hit"),await this.#l.get(c);const h=this.#u(r,c,n);this.#l.set(c,h);const d=await h;return this.#l.delete(c),this.#s?.increment("generated"),d})}async#u(e,t,i){const r=performance.now();let s;this.#c.apiEndpoint?s=await this.#y(e):s=await this.#m(e);const n={vector:s,meta:{...i&&typeof i=="object"?i:{},text_preview:e.substring(0,100),timestamp:p.timestamp(),dimensions:s.length}};this.#h.set(t,n);const a=performance.now()-r;return this.#s?.timer("generation_time",a),{id:t,vector:s,cached:!1}}async#y(e){const t=await b.fetch(this.#c.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.#c.apiKey}`},body:JSON.stringify({model:this.#c.model,input:e})});if(!t.ok)throw new this.#n(`Embedding API request failed: ${t.status} ${t.statusText}`);return(await t.json()).data[0].embedding}async#m(e){const t=this.#b(e),i=[];for(let s=0;s<this.#c.embeddingDimensions;s++){const n=t*(s+1)%2147483647,a=(Math.sin(n)+1)/2;i.push((a-.5)*2)}const r=Math.sqrt(i.reduce((s,n)=>s+n*n,0));return i.map(s=>s/r)}#p(){const e=this.#e?.sanitizer;return e&&e!==this.#i&&(this.#i=e),this.#i}#f(e){const t=this.#p(),i=typeof e=="string"?e:String(e??"");if(!t?.cleanseText)return i;try{return t.cleanseText(i)}catch(r){console.warn("[EmbeddingManager] Failed to sanitize text.",r);try{return t.cleanseText(`${i}`)}catch{return""}}}#w(e){const t=this.#p();if(!t?.cleanse)return e&&typeof e=="object"?{...e}:{};try{const i=t.cleanse(e);return i&&typeof i=="object"?i:{}}catch(i){console.warn("[EmbeddingManager] Failed to sanitize metadata.",i);try{return t.cleanse(e&&typeof e=="object"?{...e}:{})??{}}catch{return{}}}}async semanticSearch(e,t={}){return this.#o.tryAsync(async()=>{const{topK:i=5,threshold:r=.5,includeText:s=!1}=t,n=this.#f(e);if(!n)return[];const a=await this.generateEmbedding(n);if(!a)return[];const c=a.vector,l=[];for(const[d,u]of this.#h.entries()){const y=this.cosineSimilarity(c,u.vector);if(y>=r){const m={id:d,relevance:y,meta:u.meta};s&&u.meta?.text_preview&&(m.text=u.meta.text_preview),l.push(m)}}const h=l.sort((d,u)=>u.relevance-d.relevance).slice(0,i);return this.#s?.increment("semantic_search.executed"),h})}async generateBatchEmbeddings(e,t=[]){return this.#o.tryAsync(async()=>{const i=[],r=this.#v(e,this.#c.batchSize),s=performance.now();for(const a of r){const c=a.map((h,d)=>{const u=t[d]||{};return this.generateEmbedding(h,u)});(await Promise.allSettled(c)).forEach(h=>{h.status==="fulfilled"?i.push(h.value):i.push(null)})}const n=performance.now()-s;return this.#s?.timer("batch_generation_time",n),i})}cosineSimilarity(e,t){if(e.length!==t.length)throw new Error("Vectors must have same dimensions");const i=e.reduce((n,a,c)=>n+a*t[c],0),r=Math.sqrt(e.reduce((n,a)=>n+a*a,0)),s=Math.sqrt(t.reduce((n,a)=>n+a*a,0));return r&&s?i/(r*s):0}async findSimilar(e,t=5,i={}){const{threshold:r=.7,includeText:s=!1}=i;return this.#o.tryAsync(async()=>{const n=this.#h.get(e);if(!n)throw new Error(`Embedding not found: ${e}`);const a=[];for(const[c,l]of this.#h.entries()){if(c===e)continue;const h=this.cosineSimilarity(n.vector,l.vector);if(h>=r){const d={id:c,relevance:h,meta:l.meta};s&&l.meta?.text_preview&&(d.text=l.meta.text_preview),a.push(d)}}return this.#s?.increment("similarity_search.executed"),a.sort((c,l)=>l.relevance-c.relevance).slice(0,t)})}async upsertEmbedding(e,t,i="v1"){return this.#o.tryAsync(async()=>{const r=this.#t?.clientState?.entities.get(e);r&&(r.embeddings=r.embeddings||{},r.embeddings.default=t,r.embedding_version=i,r.embedding_updated_at=p.timestamp(),await this.#t.storage.instance.put("objects",r),this.#t.emit?.("entitySaved",{store:"objects",item:r}),this.#_(e,t),this.#s?.increment("entity_embedding_upserted"))})}async bulkUpsertEmbeddings(e=[],t="v1"){return this.#o.tryAsync(async()=>{if(!e.length)return;const i=this.#t?.storage?.instance,r=[];for(const{id:s,vector:n}of e){const a=this.#t?.clientState?.entities.get(s);a&&(a.embeddings=a.embeddings||{},a.embeddings.default=n,a.embedding_version=t,a.embedding_updated_at=p.timestamp(),await this.#g(a),r.push(a),this.#_(s,n))}if(i?.bulkPut)await i.bulkPut("objects",r);else for(const s of r)await i.put("objects",s);this.#t.emit?.("embeddingsBatchUpdated",{count:r.length,version:t,entities:r.map(s=>s.id)}),this.#s?.increment("bulk_embeddings_upserted",r.length)})}#_(e,t){g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"}),t?.length&&this.#d.set(e,this.normalizeVector(t))}normalizeVector(e){const t=Math.sqrt(e.reduce((i,r)=>i+r*r,0));return t?e.map(i=>i/t):e}#b(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t&=t;return Math.abs(t)}#v(e,t){g.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});const i=[];for(let r=0;r<e.length;r+=t)i.push(e.slice(r,r+t));return i}getStats(){return{cache:this.#h?.getMetrics(),pendingEmbeddings:this.#l.size,embeddingDimensions:this.#c.embeddingDimensions,apiConfigured:!!this.#c.apiEndpoint,metrics:this.#s?.getAllAsObject()}}clearCache(){this.#h?.clear(),this.#d?.clear(),this.#l.clear(),this.#s?.increment("cache_cleared")}exportEmbeddings(){const e={};for(const[t,i]of this.#h.entries())e[t]={vector:i.vector,meta:i.meta};return e}importEmbeddings(e){let t=0;for(const[i,r]of Object.entries(e))this.#h.set(i,r),t++;return this.#s?.increment("imported",t),t}}class Ne{#t;#e;constructor({stateManager:e}={}){this.#t=e?.metricsRegistry?.namespace("idManager"),this.#e=e?.managers?.forensicLogger}generate(e={}){const{prefix:t="",entityType:i="",classification:r}=e,s=crypto.randomUUID(),n=t?`${t}_${s}`:s;return this.#t?.increment("ids.generated.total"),i&&this.#t?.increment(`ids.generated.by_type.${i}`),this.#e&&r&&["secret","top_secret"].includes(r)&&this.#e.logAuditEvent("ID_GENERATION_SENSITIVE",{id:n,entityType:i,classification:r},e.securitySubject||{}),n}generateSimpleId(e="id"){const t=Array.from(crypto.getRandomValues(new Uint8Array(4))).map(i=>i.toString(16).padStart(2,"0")).join("");return`${e}_${p.timestamp()}_${t}`}}class Fe{#t;#e;#i;#r=10;#s;#n;#a=new Map;#o=null;#c=null;#h=null;#l=null;constructor({stateManager:e}){this.#t=e,this.#o=this.#t.metricsRegistry?.namespace("eventFlow"),this.#c=this.#t.managers.conditionRegistry,this.#h=this.#t.managers.actionHandler,this.#l=this.#t.managers.errorHelpers;const t=this.#t.config?.eventFlow?.queueSize||500;this.#s=new _(t,{stateManager:this.#t,name:"eventQueue"}),this.#t.on("stack_eviction",i=>{i?.source==="stack:eventQueue"&&i?.reason==="capacity"&&(this.#o?.increment("queueOverflows"),console.warn("[EventFlowEngine] Event queue capacity reached. Oldest event evicted:",i.item?.data))}),this.#e=new Map,this.#i=new _(this.#r),this.#n=!1}initialize(){const e=performance.now();this.#t.on("*",(i,r)=>{r&&r!=="systemInitialized"&&this.#g(r,i)}),this.#S();const t=performance.now()-e;try{this.#t.emit?.("metrics",{type:"bootstrap.stage",stage:"event_flow_engine",duration:t})}catch{}console.log(`EventFlowEngine initialized with ${this.#e.size} flows`)}registerFlow(e){const t={id:e.id||`flow_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:e.name,description:e.description,trigger:e.trigger,conditions:e.conditions||{},actions:e.actions||{},enabled:e.enabled!==!1,priority:e.priority||"normal",metadata:e.metadata||{}};return this.#e.set(t.id,t),this.#d(t),t}#d(e){const t=Array.isArray(e.trigger.events)?e.trigger.events:[e.trigger.events].filter(Boolean);for(const i of t)this.#a.has(i)||this.#a.set(i,new Set),this.#a.get(i).add(e.id)}#g(e,t){this.#s.push({type:e,timestamp:Date.now(),data:t})&&(this.#n||this.#u())}async#u(){if(!this.#n){for(this.#n=!0;!this.#s.isEmpty();){const e=this.#s.pop();await this.#y(e)}this.#n=!1}}async#y(e){const t=performance.now();this.#o?.increment("eventsProcessed"),await this.#l?.tryOr(async()=>{const i=this.#m(e.type),r=this.#p(i);for(const s of r)s?.enabled&&await this.#f(s,e)},null,{component:"EventFlowEngine",operation:"processEvent"},()=>this.#E(performance.now()-t))}#m(e){const t=[];if(this.#a&&this.#a.has(e)){const i=this.#a.get(e);for(const r of i){const s=this.#e.get(r);s&&t.push(s)}}if(this.#a&&this.#a.has("*")){const i=this.#a.get("*");for(const r of i){const s=this.#e.get(r);s&&!t.includes(s)&&t.push(s)}}return t}#p(e){const t={high:3,normal:2,low:1};return e.sort((i,r)=>{const s=t[i.priority]||2;return(t[r.priority]||2)-s})}async#f(e,t){if(this.#i.isFull()){const i=new Error(`Maximum flow execution depth (${this.#r}) reached for flow: ${e.id}. This may indicate a recursive loop.`);this.#t.managers.forensicLogger?.logAuditEvent("EVENT_FLOW_RECURSION_LIMIT",{flowId:e.id,executionStack:this.#i.toArray()}),this.#l?.handleError(i,{component:"EventFlowEngine"});return}this.#i.push(e.id),this.#o?.increment("flowsExecuted");try{const i=await this.#w(e,t),r=e.actions[i]||e.actions.default||[];for(const s of r)await this.#b(s,t,e)}finally{this.#i.pop()}}async#w(e,t){this.#o?.increment("conditionsEvaluated");const i=performance.now();if(!e.conditions||Object.keys(e.conditions).length===0)return"default";for(const[r,s]of Object.entries(e.conditions))if(await this.#_(s,t)){const a=performance.now()-i;return this.#o?.updateAverage("conditionEvalTime",a),r}return this.#o?.updateAverage("conditionEvalTime",performance.now()-i),"default"}async#_(e,t){if(!this.#c||!this.#l)return console.warn("[EventFlowEngine] ConditionRegistry or ErrorHelpers not found. Cannot evaluate condition."),!1;const i=this.#t.managers.securityManager?.getSubject();return this.#l.tryOr(()=>this.#c.evaluate(e,t,i),()=>!1,{component:"EventFlowEngine",operation:"evaluateCondition",conditionType:e.type})}async#b(e,t,i){if(!this.#h){console.warn("[EventFlowEngine] ActionHandlerRegistry not found.");return}const r=this.#h.get(e.type);if(!r){console.warn(`[EventFlowEngine] No handler for action type: ${e.type}`);return}if(!this.#l){console.warn("[EventFlowEngine] ErrorHelpers not found."),await r(e,t,i,this.#t);return}await this.#l.tryOr(()=>r(e,t,i,this.#t),null,{component:"EventFlowEngine",operation:"executeAction",actionType:e.type}),this.#o?.increment(`actionsExecuted.${e.type}`)}#v(){this.#a=new Map;for(const e of this.#e.values())this.#d(e)}#E(e){this.#o?.updateAverage("averageProcessingTime",e)}getStats(){return{...this.#o?.getAllAsObject()||{},registeredFlows:this.#e.size,currentExecutionDepth:this.#i.length,queueSize:this.#s.size}}removeFlow(e){const t=this.#e.delete(e);return t&&this.#v(),t}#S(){this.registerFlow({id:"error_handling",name:"Error Handling",trigger:{events:["error","exception","action_execution_error"]},conditions:{critical:{type:"property_equals",property:"data.severity",value:"high"},warning:{type:"property_equals",property:"data.severity",value:"warn"}},actions:{critical:[{type:"log_event",level:"error"},{type:"show_notification",template:"error",duration:0},{type:"track_metric",metric:"errors.critical"}],warning:[{type:"log_event",level:"warn"},{type:"show_notification",template:"warning",duration:5e3}],default:[{type:"log_event",level:"info"}]}}),this.registerFlow({id:"state_change_notification",name:"State Change Notification",trigger:{events:["entitySaved","entityDeleted"]},actions:{default:[{type:"invalidate_cache",pattern:"entity:*"}]}}),console.log("[EventFlowEngine] Registered default system event flows.")}exportFlows(){return Array.from(this.#e.values()).map(e=>({domain:"system",type:"event_flow",data:e}))}}class He{#t;#e;#i;#r;#s;#n;#a;constructor({stateManager:e}){this.#t=e;const t=e.managers;this.#e=t.pluginSystem,this.#i=t.embeddingManager,this.#r=t.metricsRegistry?.namespace("query"),this.#s=t.errorHelpers,this.#n=t.cacheManager?.getCache("queries",200,{ttl:6e4}),this.#a=this.#s?.createErrorBoundary({eventFlow:this.#t?.eventFlow,managers:this.#t?.managers},"QueryService"),this.#r?.measure&&(this.search=this.#r.measure("search.duration")(this.search.bind(this)))}async search(e,t={}){if(!e||typeof e!="string")return[];const i=`${e}:${JSON.stringify(t)}`,r=this.#n?.get(i);if(r)return this.#r?.increment("cache_hit"),r;this.#r?.increment("cache_miss");const s=[],{domains:n=[],limit:a=50,includeAI:c=!0}=t,l=await this.#o(e,n);s.push(...l);const h=await this.#c(e,n);if(s.push(...h),c&&this.#i){const u=await this.#h(e,{limit:a});s.push(...u)}const d=this.#l(s).slice(0,a);return this.#n?.set(i,d),d}async#o(e,t){return this.#a.tryAsync(async()=>{if(!this.#t?.queryLocalEntities)return[];const i=await this.#t.queryLocalEntities(e);return t.length>0?(i||[]).filter(r=>t.includes(r.domain)||t.includes(r.type)||!r.domain):i})}async#c(e,t){return this.#a.tryAsync(async()=>{if(!this.#e?.activePlugins)return[];const i=[];for(const s of this.#e.activePlugins)if(typeof s.search=="function"){const n=this.#s?.captureAsync(()=>s.search(e,{domains:t}),this.#t?.eventFlow,{component:`Plugin.${s.id}`}).then(a=>a?a.map(c=>({...c,source:"plugin",pluginId:s.id,pluginName:s.name||s.id})):[]);i.push(n)}return(await Promise.all(i)).flat().filter(Boolean)})}async#h(e,t){return this.#a.tryAsync(async()=>{if(!this.#i?.semanticSearch)return[];const i=await this.#i.semanticSearch(e,{topK:t.limit||10,threshold:.7});return i?i.map(r=>({...r,source:"ai",searchType:"semantic"})):[]})}#l(e){return e.sort((t,i)=>{const r=t.relevance||0,s=i.relevance||0;if(r!==s)return s-r;const n={local:3,plugin:2,ai:1},a=n[t.source]||0,c=n[i.source]||0;if(a!==c)return c-a;const l=new Date(t.timestamp||t.created||0).getTime();return new Date(i.timestamp||i.created||0).getTime()-l})}async getSuggestions(e,t=5){return this.#a.tryAsync(async()=>{if(!e||e.length<2)return[];const i=await this.search(e,{limit:t*2});if(!i)return[];const r=new Set;return i.forEach(s=>{s.title&&r.add(s.title),s.name&&r.add(s.name),s.tags&&s.tags.forEach(n=>r.add(n))}),Array.from(r).filter(s=>s.toLowerCase().includes(e.toLowerCase())).slice(0,t)})}clearCache(){this.#n.clear()}getStats(){return{cache:this.#n?.getMetrics(),localSearchAvailable:!!this.#t?.queryLocalEntities,pluginSearchAvailable:!!this.#e?.activePlugins?.length,aiSearchAvailable:!!this.#i?.semanticSearch}}}const I=Object.freeze({"basic-security":"basic-crypto"}),Ue=Object.freeze({searchPaths:[],legacyMap:new Map(Object.entries(I)),baseURL:"",cacheResults:!0});class F{constructor(e={}){const t={...Ue,...e};this.#n=Array.isArray(t.searchPaths)?t.searchPaths.filter(Boolean):[];const i=t.legacyMap instanceof Map?t.legacyMap:new Map(Object.entries(t.legacyMap||{}));this.#a=new Map(i),this.#o=t.policy||{},this.#c=t.metrics||null,this.#h=t.forensic||null,this.#l=t.baseURL||"",this.#d=t.cacheResults!==!1,this.#g=new Map}async import(e,t={}){const i=t.forceRefresh===!0,r=e;if(!i&&this.#d&&this.#g.has(r))return this.#g.get(r);const s=this.#t(e),n=this.#e(s,e);let a=null;for(const c of n)try{const h={module:await import(c.url),url:c.url,canonical:!c.fromLegacy,fromLegacy:c.fromLegacy};return this.#i(e,c),this.#d&&this.#g.set(r,h),h}catch(l){a=l,this.#r(e,c,l)}throw this.#s(e,a),new Error(`CanonicalResolver: failed to resolve '${e}' (last error: ${a?.message||"unknown"})`)}mapLegacy(e){return this.#a.get(e)||e}isCanonical(e){return!this.#a.has(e)}addLegacyAlias(e,t){this.#a.set(e,t),this.#g.clear()}setStrictMode(e){this.#o.enforceCanonicalOnly=e===!0}snapshot(){return{searchPaths:[...this.#n],legacyCount:this.#a.size,cacheSize:this.#g.size,strictMode:!!this.#o.enforceCanonicalOnly,baseURL:this.#l}}#t(e){const t=new Set([e]),i=this.#a.get(e);return i&&t.add(i),t}#e(e,t){const i=[],r=new Set,s=(n,a,c)=>{const l=n.replace(/\/+/g,"/");r.has(l)||(r.add(l),i.push({url:l,fromLegacy:a,fallback:c}))};for(const n of e){const a=n!==t;for(const c of this.#n)s(`${c}/${n}.js`,a,!1);this.#l&&s(`${this.#l}${n}.js`,a,!0)}return this.#l&&s(`${this.#l}${t}.js`,!1,!0),i}#i(e,t){if(this.#c?.increment?.("canonical.resolve.success",1),t.fromLegacy&&this.#c?.increment?.("canonical.resolve.legacy_hit",1),t.fromLegacy&&this.#o?.enforceCanonicalOnly===!0){const i={moduleName:e,resolvedUrl:t.url};throw this.#h?.logAuditEvent?.("CANONICAL_RESOLVE_POLICY_VIOLATION",i,{component:"CanonicalResolver"})?.catch?.(()=>{}),new Error(`CanonicalResolver: strict mode violation for '${e}'`)}t.fromLegacy&&this.#h?.logAuditEvent?.("CANONICAL_RESOLVE_FALLBACK",{moduleName:e,resolvedUrl:t.url},{component:"CanonicalResolver",severity:"info"})?.catch?.(()=>{})}#r(e,t,i){this.#c?.increment?.("canonical.resolve.attempt_failed",1),this.#h?.logAuditEvent?.("CANONICAL_RESOLVE_ATTEMPT_FAILED",{moduleName:e,url:t.url,error:i?.message||String(i)},{component:"CanonicalResolver",severity:"debug"})?.catch?.(()=>{})}#s(e,t){this.#c?.increment?.("canonical.resolve.failure",1),this.#h?.logAuditEvent?.("CANONICAL_RESOLVE_FAILURE",{moduleName:e,error:t?.message||String(t)},{component:"CanonicalResolver",severity:"warning"})?.catch?.(()=>{})}#n;#a;#o;#c;#h;#l;#d;#g}class qe{_map;constructor(){this._map=new Map}get(e){return this._map.get(e)}set(e,t){this._map.set(e,t)}delete(e){try{g.createEnvelope("MAPWRAPPER_DELETE",{key:e}).catch(()=>{})}catch{}return this._map.delete(e)}clear(){this._map.clear()}getStatistics(){return{size:this._map.size}}}class je{#t=new Map;#e;#i=!1;#r;#s=null;#n=null;constructor({stateManager:e,...t}){if(!e&&t.demoMode)this.#r={config:{demoMode:!0},managers:{forensicLogger:{logAuditEvent:()=>{}},cacheManager:{getCache:()=>new qe}},storage:{ready:!1}};else if(e)this.#r=e;else throw new Error("StorageLoader requires a stateManager instance.");this.#e={baseURL:t.baseURL??"/src/platform/storage/modules/",preloadModules:t.preloadModules??[],demoMode:t.demoMode??!1,mac:t.mac??null,cacheModules:t.cacheModules!==!1,moduleStacks:t.moduleStacks??{demo:{core:["validation-stack"],security:["basic-security"],crypto:["demo-crypto"],sync:[]},basic:{core:["validation-stack"],security:["basic-security"],crypto:["basic-crypto"],sync:[]},high_security:{core:["validation-stack"],security:["enterprise-security"],crypto:["aes-crypto","key-rotation"],sync:[]},nato:{core:["validation-stack"],security:["nato-security","compartment-security"],crypto:["zero-knowledge-crypto","key-rotation"],sync:[]}},...t},this.#s=this.#r?.managers?.metricsRegistry??this.#r?.metricsRegistry??null;const i=this;this.#n=new F({searchPaths:["/src/platform/security/encryption","/src/platform/security","/src/platform/storage/validation","/src/platform/storage/sync","/src/platform/storage/adapters","/src/platform/storage"],legacyMap:new Map(Object.entries(I)),baseURL:this.#e.baseURL,metrics:this.#s,forensic:this.#r?.managers?.forensicLogger??this.#r?.forensicLogger??null,policy:{get enforceCanonicalOnly(){try{return i.#r?.managers?.policies?.getPolicy?.("storage","enforce_canonical_only")===!0}catch{return!1}}}}),this.#_("STORAGE_LOADER_CREATED",{demoMode:this.#e.demoMode});try{typeof g?.createEnvelope=="function"&&g.createEnvelope({actorId:this.#r?.managers?.securityManager?.getSubject?.()?.userId||"system",action:"storage_loader.created",target:"StorageLoader",payload:{demoMode:this.#e.demoMode}}).catch(()=>{})}catch{}console.log("[StorageLoader] Created with demoMode:",this.#e.demoMode)}async init(){if(this.#i)return this;await this.#m();for(const e of this.#e.preloadModules)try{await this.#u(e)}catch(t){console.warn("[StorageLoader] Preload failed:",e,t)}return this.#i=!0,console.log("[StorageLoader] Ready with dynamic module loading"),this}async createStorage(e={},t={}){this.#i||await this.init();const i=await this.#a(e,t),r=await this.#o(i),s=new Be({moduleClasses:r,stateManager:this.#r});try{g.createEnvelope("STORAGE_CREATED",{demoMode:this.#e.demoMode,moduleCategories:Object.keys(r||{}).length}).catch(()=>{})}catch{}return await s.init(),s}#a(e,t){if(this.#e.demoMode)return this.#_("STORAGE_PROFILE_SELECTED",{profile:"demo"}),{...this.#e.moduleStacks.demo};const i=String(e?.clearanceLevel||"internal").toLowerCase();let r="basic";this.#p(i)?r="nato":this.#f(i)&&(r="high_security"),this.#_("STORAGE_PROFILE_SELECTED",{profile:r,level:i});const s=JSON.parse(JSON.stringify(this.#e.moduleStacks[r]||this.#e.moduleStacks.basic));return t.strictValidation&&(s.core=Array.from(new Set([...s.core||[],"strict-validator"]))),t.customValidators?.length&&(s.core=Array.from(new Set([...s.core||[],"custom-validator"]))),t.enableSync===!0&&(s.sync.push("sync-stack"),t.realtimeSync?s.sync.push("realtime-sync"):s.sync.push("batch-sync")),s.indexeddb=["indexeddb-adapter"],s}async#o(e){return{validation:await this.#c(e.core||[]),security:await this.#h(e.security||[]),crypto:await this.#l(e.crypto||[]),sync:await this.#d(e.sync||[]),indexeddb:await this.#g(e.indexeddb||["indexeddb-adapter"])}}async#c(e){const t=await this.#u("validation-stack"),i=[];if(e.includes("strict-validator"))try{i.push(await this.#u("strict-validator"))}catch(r){console.warn("[StorageLoader] strict-validator missing:",r)}if(e.includes("custom-validator"))try{i.push(await this.#u("custom-validator"))}catch(r){console.warn("[StorageLoader] custom-validator missing:",r)}return new t({stateManager:this.#r})}async#h(e){if(!e?.length)return null;let t=null;const i=[];for(const r of e)if(r==="basic-security"||r==="enterprise-security"||r==="nato-security")t=await this.#u(r);else try{i.push(await this.#u(r))}catch(s){console.warn("[StorageLoader] security extra missing:",r,s)}return t?new t({stateManager:this.#r,extras:i}):null}async#l(e){if(!e?.length)return null;let t=null;const i=[];for(const r of e)if(r==="demo-crypto"||r==="basic-crypto"||r==="aes-crypto"||r==="zero-knowledge-crypto"||r==="pqc-crypto")t=await this.#u(r);else try{i.push(await this.#u(r))}catch(s){console.warn("[StorageLoader] crypto extra missing:",r,s)}return t?new t({stateManager:this.#r,extras:i}):null}async#d(e){if(!e.includes("sync-stack"))return null;const t=await this.#u("sync-stack"),i=[];for(const r of e)r!=="sync-stack"&&i.push(await this.#u(r));return new t({stateManager:this.#r,submodules:i})}async#g(e){if(typeof indexedDB>"u"){class r{constructor(){this._store=new Map}async init(){return!0}async put(n,a){const c=a.id||`${n}:${Math.random().toString(36).slice(2)}`;return this._store.set(c,a),c}async get(n,a){return this._store.get(a)||null}async getAll(n){return Array.from(this._store.values())}async delete(n,a){try{g.createEnvelope("INMEM_INDEXEDDB_DELETE",{storeName:n,id:a}).catch(()=>{})}catch{}return this._store.delete(a)}async getHistory(n,a){return Array.from(this._store.values()).filter(c=>c.logical_id===a)}}return new r({stateManager:this.#r})}const t=e[0]||"indexeddb-adapter",i=await this.#u(t);return new i({stateManager:this.#r})}async#u(e){if(this.#t.has(e))return this.#t.get(e);console.log("[StorageLoader] Loading module:",e);const t=await this.#n.import(e),i=t.module,r=i.default||i[this.#w(e)];if(!r)throw new Error("No default or named export found");return this.#e.cacheModules&&this.#t.set(e,r),t.fromLegacy&&(this.#s?.increment?.("storage.resolve.fallback_used",1),this.#y()&&console.warn(`[StorageLoader] Legacy module path used for '${e}'`)),r}#y(){try{return this.#r?.managers?.policies?.getPolicy?.("storage","warn_on_legacy_resolve")===!0}catch{return!1}}async#m(){if(this.#t.has("core-validation"))return;class e{validateBasic(i){const r=[];return(!i||typeof i!="object")&&r.push("Invalid entity"),i?.id||r.push("Missing id"),i?.entity_type||r.push("Missing entity_type"),{valid:r.length===0,errors:r}}}this.#t.set("core-validation",e)}#p(e){return["nato_restricted","nato_confidential","nato_secret","cosmic_top_secret"].includes(e)}#f(e){return["confidential","secret","top_secret"].includes(e)}#w(e){return String(e).split("-").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join("")}#_(e,t){this.#r?.managers?.forensicLogger?.logAuditEvent(e,t,{component:"StorageLoader"})}get isReady(){return this.#i}get loadedModules(){return Array.from(this.#t.keys())}}class Be{#t=!1;#e;constructor({stateManager:e,moduleClasses:t}){if(!e)throw new Error("ModularOfflineStorage requires a stateManager instance.");this.#e=e,this.validation=t.validation,this.security=t.security,this.crypto=t.crypto,this.sync=t.sync,this.indexeddb=t.indexeddb,this.#y("MODULAR_STORAGE_CREATED",{modules:this.modules,demoMode:this.#i})}async init(){if(this.#t)return this;const e=["indexeddb","crypto","security","validation","sync"];for(const t of e){const i=this[t];i&&typeof i.init=="function"&&await i.init()}return this.#t=!0,console.log("[ModularOfflineStorage] Initialized with dynamic modules"),this}get#i(){return this.#e.config.demoMode===!0}get#r(){return this.#e?.managers?.securityManager?.mac}get#s(){return this.crypto}get#n(){return this.#e?.managers?.informationFlowTracker}#a(){return this.#r?.subject()||{level:"unclassified",compartments:new Set}}#o(e,{storeName:t}={}){if(!e||typeof e!="object")return{level:"unclassified",compartments:new Set};const r=(t==="objects_polyinstantiated"||"classification_level"in e?e.classification_level:e.classification)||"unclassified",s=new Set(e.compartments||[]);return{level:r,compartments:s}}#c(e){const i=["unclassified","confidential","secret","nato_secret","top_secret","cosmic_top_secret"].indexOf(String(e||"").toLowerCase());return i<0?0:i}#h(e){if(!Array.isArray(e)||e.length===0)return null;const t=[...e].sort((s,n)=>this.#c(n.classification_level)-this.#c(s.classification_level)),i={...t[0]};i.instance_data||(i.instance_data={});const r=t.reduce((s,n)=>{const a=n.instance_data||{},c=(l,h)=>{for(const d in h)typeof h[d]=="object"&&h[d]!==null&&!Array.isArray(h[d])?(l[d]||(l[d]={}),c(l[d],h[d])):d in l||(l[d]=h[d])};return c(s,a),s},{...i.instance_data});return i.instance_data=r,i.merged_at=new Date().toISOString(),this.#n?.derived(e.map(s=>({level:s.classification_level,compartments:s.compartments})),{level:i.classification_level},{operation:"poly_merge",logical_id:i.logical_id}),i}_mergePolyRows(e){return this.#h(e)}async#l(e,t){const i=this.#e?.managers?.metricsRegistry?.measure,r=this.#e?.managers?.errorHelpers;if(i&&r){const s=i(`storage.${e}`)(t);return r.captureAsync(s,{component:`ModularOfflineStorage.${e}`})}return t()}async put(e,t){return this.#l("put",async()=>{const i=this.indexeddb;if(!i?.put)throw new Error("IndexedDB adapter not loaded");const r=this.#r;if(!this.#i&&r&&!r.canWrite(this.#a(),this.#o(t,{storeName:e})))throw new Error("MAC_WRITE_DENIED: Insufficient clearance to write at this level.");let s={...t};e==="objects_polyinstantiated"&&(s.id=`${t.logical_id}-${t.classification_level}`);const n=this.#s;if(!this.#i&&n){const c=e==="objects_polyinstantiated",l=this.#o(t,{storeName:e});if(c&&s.instance_data){const h=new TextEncoder().encode(JSON.stringify(s.instance_data)),d={...l,logical_id:s.logical_id,id:s.id},u=new TextEncoder().encode(JSON.stringify(d)),y=await n.encrypt(l,h,u);s={...s,encrypted:!0,ciphertext:y.ciphertext,iv:y.iv,alg:y.alg,kid:y.kid,tag:y.tag},delete s.instance_data}else{const h=new TextEncoder().encode(JSON.stringify(s)),d={...l,id:s.id},u=new TextEncoder().encode(JSON.stringify(d)),y=await n.encrypt(l,h,u);s.envelope=y,s.encrypted=!0}}const a=await i.put(e,s);return this.#e.emit("entitySaved",{store:e,item:s}),a})}async get(e,t){return this.#l("get",async()=>{const i=this.indexeddb;if(!i?.get)throw new Error("IndexedDB adapter not loaded");if(e==="objects_polyinstantiated"){const n=await i.queryByIndex(e,"logical_id",t),a=this.#u(n||[],e),c=await Promise.all(a.map(l=>this.#d(l)));return this.#h(c)}const r=await i.get(e,t);if(!r)return null;const s=this.#r;if(!this.#i&&s&&!s.canRead(this.#a(),this.#o(r,{storeName:e})))throw new Error("MAC_READ_DENIED");return this.#g(r)})}async getLast(e){return this.#l("getLast",async()=>{const t=this.indexeddb;if(!t?.getAll)throw new Error("IndexedDB adapter not loaded");const i=await t.getAll(e);if(!i||i.length===0)return null;const r=i.filter(s=>s&&s.timestamp);return r.length>0?(r.sort((s,n)=>new Date(s.timestamp).getTime()-new Date(n.timestamp).getTime()),r[r.length-1]):i[i.length-1]||null})}async delete(e,t){return this.#l("delete",async()=>{const i=this.indexeddb;if(!i?.delete)throw new Error("IndexedDB adapter not loaded");if(e==="objects_polyinstantiated"){const n=t,a=await i.queryByIndex(e,"logical_id",n),c=this.#u(a||[],e);if(c.length===0)return;const l=this.#r;if(!this.#i&&l){const h=this.#a();for(const d of c)if(!l.canWrite(h,this.#o(d,{storeName:e})))throw new Error("MAC_DELETE_DENIED: Cannot delete an object you don't dominate.")}try{g.createEnvelope("ENTITY_DELETE_POLY",{store:e,logicalId:n,count:c.length}).catch(()=>{})}catch{}await Promise.all(c.map(h=>i.delete(e,h.id))),this.#e.emit("entityDeleted",{store:e,id:n});return}const r=await this.get(e,t);if(!r)return;const s=this.#r;if(!this.#i&&s&&!s.canWrite(this.#a(),this.#o(r,{storeName:e})))throw new Error("MAC_DELETE_DENIED");try{g.createEnvelope("ENTITY_DELETE",{store:e,id:t}).catch(()=>{})}catch{}await i.delete(e,t),this.#e.emit("entityDeleted",{store:e,id:t})})}async putBulk(e,t){return this.#l("putBulk",async()=>{const i=this.indexeddb;if(!i)throw new Error("IndexedDB adapter not loaded");if(typeof i.putBulk=="function")return i.putBulk(e,t);const r=[];for(const s of t){const n=await i.put(e,s);r.push(n)}return r})}async query(e,t,i){return this.#l("query",async()=>{const r=this.indexeddb;if(!r?.queryByIndex)throw new Error("IndexedDB adapter not loaded");const s=await r.queryByIndex(e,t,i),n=this.#u(s||[],e);return await Promise.all(n.map(c=>e==="objects_polyinstantiated"?this.#d(c):this.#g(c)))})}async getAll(e){return this.#l("getAll",async()=>{const t=this.indexeddb;if(!t?.getAll)throw new Error("IndexedDB adapter not loaded");const i=await t.getAll(e),r=this.#u(i||[],e);return await Promise.all(r.map(n=>e==="objects_polyinstantiated"?this.#d(n):this.#g(n)))})}async getHistory(e,t){return e!=="objects_polyinstantiated"?[]:this.#l("getHistory",async()=>{const i=this.indexeddb;if(!i?.queryByIndex)throw new Error("IndexedDB adapter not loaded");const r=await i.queryByIndex(e,"logical_id",t),s=this.#u(r||[],e);return(await Promise.all(s.map(a=>this.#d(a)))).sort((a,c)=>new Date(c.updated_at)-new Date(a.updated_at))})}async#d(e){const t=this.#s;if(this.#i||!t||!e?.encrypted)return e;const i=this.#o(e,{storeName:"objects_polyinstantiated"}),r={...i,logical_id:e.logical_id,id:e.id},s=new TextEncoder().encode(JSON.stringify(r)),n=await t.decrypt(i,{ciphertext:e.ciphertext,iv:e.iv,alg:e.alg,kid:e.kid,tag:e.tag},s),a=JSON.parse(new TextDecoder().decode(n)),c={...e};return delete c.ciphertext,delete c.iv,delete c.alg,delete c.kid,delete c.tag,delete c.encrypted,{...c,instance_data:a}}async#g(e){const t=this.#s;if(this.#i||!t||!e?.encrypted)return e;const i=this.#o(e),r={...i,id:e.id},s=new TextEncoder().encode(JSON.stringify(r)),n=await t.decrypt(i,e.envelope,s);return JSON.parse(new TextDecoder().decode(n))}#u(e,t){if(!Array.isArray(e))return[];const i=this.#r;if(!i)return e;const r=this.#a(),s=[];for(const n of e)i.canRead(r,this.#o(n,{storeName:t}))&&s.push(n);return s}#y(e,t){this.#e?.managers?.forensicLogger?.logAuditEvent(e,t,{component:"ModularOfflineStorage"})}get modules(){const e=[];return this.indexeddb&&e.push("indexeddb"),this.crypto&&e.push("crypto"),this.security&&e.push("security"),this.validation&&e.push("validation"),this.sync&&e.push("sync"),e}}class Ve{#t=new Map;#e=new Map;#i;#r=!1;#s=null;#n=null;#a=null;#o=null;constructor({stateManager:e,...t}){this.#s=e,this.#i={strictMode:t.strictMode!==!1,performanceMode:t.performanceMode||"balanced",customValidators:t.customValidators||{},maxErrors:t.maxErrors||10,asyncTimeout:t.asyncTimeout||5e3,...t}}async init(){if(this.#r)return this;const e=this.#s.managers;this.#n=this.#s.metricsRegistry?.namespace("validation"),this.#a=e?.errorHelpers??null,this.#o=e?.forensicLogger??null;const t=e.metricsRegistry?.measure.bind(e.metricsRegistry);return t&&(this.validateEntity=t("validation.validateEntity")(this.validateEntity.bind(this))),this.#M(),this.#A(this.#i.customValidators),await this.#x(),this.#R("VALIDATION_LAYER_INITIALIZED",{strictMode:this.#i.strictMode,customRules:this.#e.size,fieldValidators:this.#t.size}),this.#r=!0,console.log("[ValidationLayer] Ready with schema validation"),this}async validateEntity(e){if(!this.#r)throw new Error("ValidationLayer not initialized");const t=[];return this.#a?.tryAsync(async()=>{const i=performance.now(),r=[],s=this.#c(e);s.valid||t.push(...s.errors);const n=this.#h(e);n.valid||t.push(...n.errors);const a=this.#l(e);a.valid||t.push(...a.errors);const c=await this.#m(e);c.valid||t.push(...c.errors);const l=this.#p(e);l.valid||t.push(...l.errors);const h=performance.now()-i,d=t.length===0;return this.#C(d,h,t),d||(this.#R("VALIDATION_FAILED",{entityId:e.id,entityType:e.entity_type,errors:t.slice(0,this.#i.maxErrors)}),this.#s?.emit?.("validationError",{entityId:e.id,entityType:e.entity_type,errors:t.slice(0,this.#i.maxErrors)})),{valid:d,errors:t,warnings:r,metadata:{latency:h,rulesExecuted:this.#I(),entityType:e.entity_type}}},{component:"ValidationLayer",operation:"validateEntity",context:{entityId:e?.id,entityType:e?.entity_type},rethrow:!1,fallback:{valid:!1,errors:["A critical validation error occurred."],warnings:[],metadata:{systemError:!0}}})}validateField(e,t,i){const r=[];if(i.required&&(t==null||t===""))return r.push(`Field '${e}' is required`),{valid:!1,errors:r};if(t==null||t==="")return{valid:!0,errors:[]};const s=this.#f(e,t,i.type);if(s.valid||r.push(...s.errors),i.format){const n=this.#w(e,t,i.format);n.valid||r.push(...n.errors)}if(i.min!==void 0||i.max!==void 0){const n=this.#_(e,t,i);n.valid||r.push(...n.errors)}if(i.validator&&this.#t.has(i.validator)){const a=this.#t.get(i.validator)(t,i);a.valid||r.push(...a.errors)}return{valid:r.length===0,errors:r}}addValidationRule(e,t){if(this.#e.has(e)&&console.warn(`[ValidationLayer] Overwriting custom rule: ${e}`),typeof t!="function")throw new Error("Validation rule must be a function");this.#e.set(e,t),console.log(`[ValidationLayer] Added custom rule: ${e}`)}addFieldValidator(e,t){if(this.#t.has(e)&&console.warn(`[ValidationLayer] Overwriting field validator: ${e}`),typeof t!="function")throw new Error("Field validator must be a function");this.#t.set(e,t),console.log(`[ValidationLayer] Added field validator: ${e}`)}get stats(){const e=this.#n?.getAllAsObject()||{};return{...e,averageLatency:e.averageLatency?.avg||0,customRules:this.#e.size,fieldValidators:this.#t.size,isReady:this.#r}}cleanup(){this.#t.clear(),this.#e.clear(),this.#R("VALIDATION_LAYER_CLEANUP",{clearedRules:this.#e.size}),this.#r=!1}#c(e){const t=[],i=["id","entity_type"];for(const s of i)e[s]||t.push(`Missing required field: ${s}`);e.id&&!this.#b(e.id)&&t.push("ID must be a valid UUID"),e.created_at&&!this.#S(e.created_at)&&t.push("created_at must be a valid ISO timestamp"),e.updated_at&&!this.#S(e.updated_at)&&t.push("updated_at must be a valid ISO timestamp");const r=this.#s.managers.componentRegistry;return r&&e.entity_type&&!r.hasDefinition(e.entity_type)&&t.push(`Invalid entity_type: ${e.entity_type}`),{valid:t.length===0,errors:t}}#h(e){switch(e.entity_type){case"task":return this.#d(e);case"document":return this.#g(e);case"event":return this.#u(e);case"user":return this.#y(e);default:return{valid:!0,errors:[]}}}#l(e){const t=[],i=this.#s.managers.securityManager;if(i){const r=s=>s&&i.isValidClassification(s);e.classification&&!r(e.classification)&&t.push(`Invalid classification: ${e.classification}`),e.nato_classification&&!r(e.nato_classification)&&t.push(`Invalid NATO classification: ${e.nato_classification}`)}if(e.compartment_markings){if(!Array.isArray(e.compartment_markings))t.push("compartment_markings must be an array");else for(const r of e.compartment_markings)if(typeof r!="string"||r.length===0){t.push("All compartment markings must be non-empty strings");break}}return{valid:t.length===0,errors:t}}#d(e){const t=[];!e.title||typeof e.title!="string"?t.push("Task title is required and must be a string"):e.title.length>200&&t.push("Task title must be 200 characters or less");const i=["pending","in-progress","completed","cancelled"];e.status&&!i.includes(e.status)&&t.push(`Invalid task status: ${e.status}`);const r=["low","medium","high","critical"];return e.priority&&!r.includes(e.priority)&&t.push(`Invalid task priority: ${e.priority}`),e.due_date&&!this.#S(e.due_date)&&t.push("Task due_date must be a valid ISO timestamp"),{valid:t.length===0,errors:t}}#g(e){const t=[];!e.title||typeof e.title!="string"?t.push("Document title is required and must be a string"):e.title.length>200&&t.push("Document title must be 200 characters or less"),e.content&&typeof e.content!="string"?t.push("Document content must be a string"):e.content&&e.content.length>5e4&&t.push("Document content must be 50,000 characters or less");const i=["text","markdown","html","json"];return e.content_type&&!i.includes(e.content_type)&&t.push(`Invalid document content_type: ${e.content_type}`),{valid:t.length===0,errors:t}}#u(e){const t=[];(!e.event_type||typeof e.event_type!="string")&&t.push("Event event_type is required and must be a string");const i=["debug","info","warning","error","critical"];return e.severity&&!i.includes(e.severity)&&t.push(`Invalid event severity: ${e.severity}`),{valid:t.length===0,errors:t}}#y(e){const t=[];return e.email&&!this.#v(e.email)&&t.push("Invalid email format"),e.display_name&&typeof e.display_name!="string"&&t.push("Display name must be a string"),{valid:t.length===0,errors:t}}async#m(e){const t=[];for(const[i,r]of this.#e)try{const s=await Promise.race([r(e),new Promise((n,a)=>setTimeout(()=>a(new Error("Validation timeout")),this.#i.asyncTimeout))]);s.valid||t.push(...s.errors),this.#n?.increment(`ruleExecutions.${i}`)}catch(s){console.warn(`Custom rule '${i}' failed:`,s),this.#i.strictMode&&t.push(`Custom rule '${i}' failed: ${s.message}`)}return{valid:t.length===0,errors:t}}#p(e){const t=[];if(e.entity_type==="task"&&(e.status==="pending"&&e.due_date&&new Date(e.due_date)<new Date&&t.push("Due date cannot be in the past for pending tasks"),e.status==="completed"&&!e.completed_at&&t.push("Completed tasks should have a completion date")),e.entity_type==="document"&&e.content_type==="json"&&e.content)try{JSON.parse(e.content)}catch{t.push("Document content is not valid JSON despite content_type being json")}return{valid:t.length===0,errors:t}}#f(e,t,i){const r=[],s=typeof t;return i==="array"&&!Array.isArray(t)?r.push(`Field '${e}' must be an array`):i!=="array"&&s!==i&&r.push(`Field '${e}' must be of type ${i}, got ${s}`),{valid:r.length===0,errors:r}}#w(e,t,i){const r=[];switch(i){case"email":this.#v(t)||r.push(`Field '${e}' must be a valid email address`);break;case"uuid":this.#b(t)||r.push(`Field '${e}' must be a valid UUID`);break;case"url":this.#E(t)||r.push(`Field '${e}' must be a valid URL`);break;case"iso-date":this.#S(t)||r.push(`Field '${e}' must be a valid ISO timestamp`);break}return{valid:r.length===0,errors:r}}#_(e,t,i){const r=[];return typeof t=="string"?(i.min!==void 0&&t.length<i.min&&r.push(`Field '${e}' must be at least ${i.min} characters`),i.max!==void 0&&t.length>i.max&&r.push(`Field '${e}' must be at most ${i.max} characters`)):typeof t=="number"?(i.min!==void 0&&t<i.min&&r.push(`Field '${e}' must be at least ${i.min}`),i.max!==void 0&&t>i.max&&r.push(`Field '${e}' must be at most ${i.max}`)):Array.isArray(t)&&(i.min!==void 0&&t.length<i.min&&r.push(`Field '${e}' must have at least ${i.min} items`),i.max!==void 0&&t.length>i.max&&r.push(`Field '${e}' must have at most ${i.max} items`)),{valid:r.length===0,errors:r}}#b(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}#v(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}#E(e){try{return new URL(e),!0}catch{return!1}}#S(e){const t=new Date(e);return!isNaN(t.getTime())&&t.toISOString()===e}#R(e,t){const i=this.#s?.managers?.securityManager;this.#o?.logAuditEvent(e,t,{component:"ValidationLayer",userContext:i?.getSubject()})}#M(){this.#t.set("email",e=>({valid:this.#v(e),errors:this.#v(e)?[]:["Invalid email format"]})),this.#t.set("uuid",e=>({valid:this.#b(e),errors:this.#b(e)?[]:["Invalid UUID format"]})),this.#t.set("url",e=>({valid:this.#E(e),errors:this.#E(e)?[]:["Invalid URL format"]}))}#A(e){for(const[t,i]of Object.entries(e))this.addFieldValidator(t,i)}async#x(){}#C(e,t,i){if(this.#n?.increment("validationCount"),!e){this.#n?.increment("validationErrors");const r=this.#n?.get("recentErrors")||[],n=[{errors:i,timestamp:Date.now()},...r].slice(0,100);this.#n?.set("recentErrors",n)}this.#n?.updateAverage("averageLatency",t)}#I(){return Object.keys(this.#n?.getNamespace("ruleExecutions")||{})}}class Ge{#t="";#e=null;#i=null;#r=null;#s=v;#n=500;constructor({stateManager:e=null,prefix:t="",maxMetrics:i=500}={}){if(this.#t=t,this.#n=i,this.#e=e,this.#e){this.#r=this.#e.managers.errorHelpers,this.#s=this.#r?.AppError||v;const r=this.#e.managers.cacheManager;r&&(this.#i=r.createCache(`metrics:${t||"global"}`,{maxSize:this.#n,enableMetrics:!1}))}this.#i||(this.#i=new Map,console.warn("[MetricsRegistry] No CacheManager found. Using an unbounded Map. This is not recommended for production."))}increment(e,t=1,i={}){const r=this.#t+e,s=this.#i.get(r)||{type:"counter",value:0,...i};s.value+=t,this.#i.set(r,s)}timer(e,t,i={}){const r=this.#t+e,s=this.#i.get(r)||{type:"timer",unit:"ms",count:0,total:0,min:1/0,max:-1/0,avg:0,...i};s.count++,s.total+=t,s.min=Math.min(s.min,t),s.max=Math.max(s.max,t),s.avg=s.total/s.count,this.#i.set(r,s)}histogram(e,t,i={}){const r=this.#t+e,s=this.#i.get(r)||{type:"histogram",count:0,total:0,min:1/0,max:-1/0,avg:0,...i};s.count++,s.total+=t,s.min=Math.min(s.min,t),s.max=Math.max(s.max,t),s.avg=s.total/s.count,this.#i.set(r,s)}set(e,t,i={}){const r=this.#t+e,s=this.#i.get(r)||{type:"gauge",...i};s.value=t,this.#i.set(r,s)}measure(e,t={}){const i=this;return r=>(...s)=>{const n=performance.now();try{const a=r(...s);if(a&&typeof a.then=="function")return a.finally(()=>{const l=performance.now()-n;i?.timer(e,l,t)});const c=performance.now()-n;return i?.timer(e,c,t),a}catch(a){const c=performance.now()-n;throw i?.timer(e,c,{...t,error:!0}),a}}}get(e){return this.#i.get(this.#t+e)}getAll(){const e={};if(this.#i.entries)for(const[t,i]of this.#i.entries())e[t]={...i};return e}reset(e){if(e){const t=this.#t+e;this.#i.delete(t)}else this.#i.clear()}namespace(e){if(!e||typeof e!="string")throw new this.#s("MetricsRegistry namespace must be a non-empty string.");return this.#e.serviceRegistry.createNamespacedInstance("metricsRegistry",{prefix:`${this.#t}${e}.`,maxMetrics:this.#n})}}class We{#t;#e;#i;#r;#s;#n;#a;#o;#c;#h=null;#l=!1;#d=0;#g=null;constructor({stateManager:e},t=5e3){this.#t=e,this.#e=t,this.#i=this.#t.managers.renderMetrics,this.#r=this.#t.metricsRegistry,this.#s=this.#t.managers.cacheManager,this.#n=this.#t.managers.policies,this.#a=this.#t.managers.errorHelpers,this.#o=this.#t.managers.forensicLogger,this.#c={fps:{target:60,warning:30,critical:15},latency:{target:16,warning:50,critical:100},cacheHitRate:{target:95,warning:80,critical:60},...this.#t.config.metricsReporter?.thresholds||{}}}async start(){await this.#a.tryAsync(async()=>{if(this.#l){console.warn("[MetricsReporter] Already running");return}if(!this.#i)throw new Error("RenderMetrics manager not found. Cannot start.");this.#i.startTracking(),this.#g=this.#i.onUpdate(e=>{this.#u(e),this.#y(e)}),this.#h=setInterval(()=>this.generateReport(),this.#e),this.#l=!0,console.log(`[MetricsReporter] Started reporting every ${this.#e}ms`)},{component:"MetricsReporter",operation:"start"})}stop(){this.#a.try(()=>{this.#l&&(this.#i?.stopTracking(),this.#g&&(this.#g(),this.#g=null),this.#h&&(clearInterval(this.#h),this.#h=null),this.#l=!1,console.log("[MetricsReporter] Stopped reporting"))},{component:"MetricsReporter",operation:"stop"})}#u(e){g.createEnvelope({component:"MetricsReporter",operation:"updateMetricsRegistry",context:{fps:e?.fps}}).catch(()=>{}),this.#a.try(()=>{this.#r.set("performance.fps",e.fps),this.#r.set("performance.latency.render_avg",e.avgRenderLatency),this.#r.set("performance.latency.layout_avg",e.avgLayoutLatency),e.memory&&this.#r.set("performance.memory.js_heap_used",e.memory.usedJSHeapSize)},{component:"MetricsReporter",operation:"updateMetricsRegistry"})}#y(e){this.#a.try(()=>{const i=[];e.fps<=this.#c.fps.critical?i.push({type:"fps_critical",metric:"fps",value:e.fps,threshold:this.#c.fps.critical,severity:"critical",message:`Critical FPS: ${e.fps} (target: ${this.#c.fps.target})`}):e.fps<=this.#c.fps.warning&&i.push({type:"fps_warning",metric:"fps",value:e.fps,threshold:this.#c.fps.warning,severity:"warning",message:`Low FPS: ${e.fps} (target: ${this.#c.fps.target})`});const r=Math.max(e.avgRenderLatency,e.avgLayoutLatency,e.avgInteractionLatency);return r>=this.#c.latency.critical?i.push({type:"latency_critical",metric:"latency",value:r,threshold:this.#c.latency.critical,severity:"critical",message:`Critical latency: ${r}ms (target: ${this.#c.latency.target}ms)`}):r>=this.#c.latency.warning&&i.push({type:"latency_warning",metric:"latency",value:r,threshold:this.#c.latency.warning,severity:"warning",message:`High latency: ${r}ms (target: ${this.#c.latency.target}ms)`}),i},[],{component:"MetricsReporter",operation:"checkPerformanceAlerts"}).forEach(i=>{this.#t?.emit("performance_alert",{...i}),i.severity==="critical"&&this.#o&&this.#o.logAuditEvent("PERFORMANCE_ALERT_CRITICAL",i)})}generateReport(){return this.#i?this.#a.try(()=>{this.#d++;const e=this.#i.getCurrentMetrics(),i={timestamp:p.now(),reportId:`metrics_${p.timestamp()}_${this.#d}`,performance:{fps:e.fps,frameCount:e.frameCount,latency:{render:e.avgRenderLatency,layout:e.avgLayoutLatency,interaction:e.avgInteractionLatency},memory:e.memory,cumulativeLayoutShift:e.cumulativeLayoutShift,firstContentfulPaint:e.firstContentfulPaint},core:this.#r?this.#r.getAll():{},caches:this.#s?this.#s.getAllMetrics():{},system:{userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight},connection:this.#m()},thresholds:this.#c,alerts:this.#p(e)};return this.#f(i),this.#_(i),i},null,{component:"MetricsReporter",operation:"generateReport"}):null}#m(){return this.#a.try(()=>{if("connection"in navigator){const e=navigator.connection;return{effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt,saveData:e.saveData}}return null},null,{component:"MetricsReporter",operation:"getConnectionInfo"})}#p(e){return this.#a.try(()=>{const t=[];if(!this.#i)return t;const i=this.#i.detectPerformanceIssues(e);t.push(...i);const r=this.#s?.getAllMetrics()||{},s=Object.keys(r).length;if(s>0){const n=Object.values(r).reduce((a,c)=>a+(c.hitRate||0),0)/s;n<this.#c.cacheHitRate.critical?t.push({type:"low_cache_hit_rate",severity:"critical",message:`Very low cache hit rate: ${n.toFixed(2)}%`,suggestion:"Review caching strategy and cache size limits"}):n<this.#c.cacheHitRate.warning&&t.push({type:"suboptimal_cache_hit_rate",severity:"warning",message:`Suboptimal cache hit rate: ${n.toFixed(2)}%`,suggestion:"Consider increasing cache size or improving cache keys"})}return t},[],{component:"MetricsReporter",operation:"detectIssues"})}#f(e){this.#a.try(()=>{this.#t?.emit&&this.#t.emit("metrics_update",{type:"performance_metrics",data:e,policies:this.#w()})},{component:"MetricsReporter",operation:"emitAnalyticsEvent"})}#w(){return this.#a.try(()=>this.#n?{analytics:this.#n.getPolicy("system","enable_analytics")??!1,monitoring:this.#n.getPolicy("system","enable_monitoring")??!1,debug:this.#n.getPolicy("system","enable_debug_mode")??!1}:{analytics:!1,monitoring:!1,debug:!1},{analytics:!1,monitoring:!1,debug:!1},{component:"MetricsReporter",operation:"getRelevantPolicies"})}#_(e){this.#a.try(()=>{const t=this.#w();(t.debug||t.monitoring)&&console.log("[MetricsReporter] Performance Report:",{performance:{fps:e.performance.fps,latency:e.performance.latency},core_metrics_count:Object.keys(e.core).length,alerts:e.alerts.length,timestamp:e.timestamp}),e.alerts.length>0&&console.warn("[MetricsReporter] Performance Issues:",e.alerts)},{component:"MetricsReporter",operation:"logReport"})}recordLatency(e,t,i="unknown"){this.#a.try(()=>{this.#i&&this.#i.recordCustomLatency(e,t)},{component:"MetricsReporter",operation:"recordLatency"})}getCurrentSummary(){return this.#a.try(()=>{if(!this.#i)return{isRunning:this.#l};const e=this.#i.getCurrentMetrics();return{fps:e.fps,latency:{render:e.avgRenderLatency,layout:e.avgLayoutLatency,interaction:e.avgInteractionLatency},core:this.#r?this.#r.getAll():{},memory:e.memory,issues:this.#p(e),isRunning:this.#l,reportCount:this.#d}},{isRunning:this.#l},{component:"MetricsReporter",operation:"getCurrentSummary"})}exportData(){return this.#a.try(()=>this.#i?{renderMetrics:this.#i.exportData(),thresholds:{...this.#c},config:{interval:this.#e,isRunning:this.#l,reportCount:this.#d},summary:this.getCurrentSummary()}:{config:{isRunning:this.#l}},{config:{isRunning:this.#l}},{component:"MetricsReporter",operation:"exportData"})}updateThresholds(e){g.createEnvelope({component:"MetricsReporter",operation:"updateThresholds",context:{providedKeys:Object.keys(e||{})}}).catch(()=>{}),this.#a.try(()=>{this.#c={...this.#c,...e},console.log("[MetricsReporter] Updated performance thresholds:",this.#c)},{component:"MetricsReporter",operation:"updateThresholds"})}}const D={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1},Je={errorHelpers:se,cacheManager:De,metricsRegistry:Ge,idManager:Ne,securityManager:ve,keyring:S,nonRepudiation:_e},Ke={forensicLogger:g,conditionRegistry:me,actionHandler:ee,componentRegistry:Z,sanitizer:Le,eventFlowEngine:Fe,policies:be,asyncOrchestrator:we,validationLayer:Ve},Ye={plugin:ne,embeddingManager:ze,queryService:He,adaptiveRenderer:Q,buildingBlockRenderer:X,extensionManager:te,enhancedGridRenderer:G,completeGridSystem:V,gridPolicyService:Y,tenantPolicyService:$e},Xe={databaseOptimizer:ae,cds:J,optimizationAccessControl:oe,metricsReporter:We,storageLoader:je},z={...Je,...Ke,...Ye,...Xe};class Qe{#t;#e;constructor(e){this.#t=e;try{this.#e=typeof import.meta<"u"&&D?D:{}}catch{this.#e={}}}async initializeAll(){console.log("[ServiceRegistry] Initializing all core services...");const e=["errorHelpers","cacheManager","metricsRegistry","idManager","securityManager","keyring","nonRepudiation","storageLoader","sanitizer","forensicLogger","conditionRegistry","actionHandler","componentRegistry","policies","validationLayer","eventFlowEngine","asyncOrchestrator","queryService","plugin","buildingBlockRenderer","adaptiveRenderer","extensionManager","enhancedGridRenderer","gridPolicyService","completeGridSystem"];for(const t of e)await this.get(t);console.log("[ServiceRegistry] All core services initialized.")}async get(e){if(this.#t.managers[e])return this.#t.managers[e];const t=z[e];if(e==="securityManager")try{console.log("[ServiceRegistry] ServiceClass type for securityManager:",typeof t,"hasProto:",!!t?.prototype,"protoKeys:",Object.keys(t?.prototype||{}),"proto.initialize type:",typeof t?.prototype?.initialize)}catch{}if(!t)return console.error(`[ServiceRegistry] Unknown service: ${e}`),null;try{const i={stateManager:this.#t};let r;if(typeof t=="function"&&t.prototype?.constructor){const s=this.#i(e);r=s?new t(i,s):new t(i)}else r=t;if(this.#t.managers[e]=r,e==="forensicLogger")try{g.registerGlobal(r)}catch{}if(e==="securityManager")try{console.log("[ServiceRegistry] instantiated securityManager keys:",Object.keys(r||{}),"initializeType:",typeof r?.initialize)}catch{}if(typeof r.initialize=="function"){const s=r.initialize();s&&typeof s.then=="function"&&await s}return r}catch(i){throw console.error(`[ServiceRegistry] Failed to instantiate or initialize service '${e}':`,i),delete this.#t.managers[e],i}}#i(e){try{const t=typeof window<"u"&&window.NODUS_CONFIG?window.NODUS_CONFIG:{};if(e==="completeGridSystem"){const i=(r,s)=>r===!0||r===!1?r:typeof r=="string"?r.toLowerCase()==="true":s;return{enablePolicies:i(t?.grid?.enablePolicies??this.#e?.VITE_GRID_ENABLE_POLICIES,!0),enableAnalytics:i(t?.grid?.enableAnalytics??this.#e?.VITE_GRID_ENABLE_ANALYTICS,!0),enableToasts:i(t?.grid?.enableToasts??this.#e?.VITE_GRID_ENABLE_TOASTS,!0),enableAI:i(t?.grid?.enableAI??this.#e?.VITE_GRID_ENABLE_AI,!0),enableNesting:i(t?.grid?.enableNesting??this.#e?.VITE_GRID_ENABLE_NESTING,!1),enableHistoryInspector:i(t?.grid?.enableHistoryInspector??this.#e?.VITE_GRID_HISTORY_INSPECTOR,!0)}}return null}catch{return null}}createNamespacedInstance(e,t){g.createEnvelope({actorId:"system",action:"createNamespacedInstance",target:e,label:"system_configuration"}).catch(()=>{}),this.#t.managers.forensicLogger?.logAuditEvent("NAMESPACE_INSTANCE_CREATED",{serviceName:e,options:Object.keys(t||{})});const i=z[e];if(!i)return console.error(`[ServiceRegistry] Cannot create namespaced instance. Unknown service: ${e}`),null;try{return new i({stateManager:this.#t,...t})}catch(r){return console.error(`[ServiceRegistry] Failed to create namespaced instance of '${e}':`,r),null}}}class Ze{#t;#e;#i;#r;#s;#n;#a;#o;#c=null;#h=null;#l=!1;#d=!1;#g=null;#u=0;#y=null;#m=[];#p={};#f=new Map;get config(){return this.#t}async initialize(e={}){const t=await this.#o.get("storageLoader");this.#i.loader=t,t&&typeof t.init=="function"&&await t.init(),this.#i.instance=await this.#i.loader.createStorage(e,{demoMode:!!this.#t?.storageConfig?.demoMode}),this.#i.ready=!0,this.emit("storageReady",{loader:this.#i.loader,instance:this.#i.instance})}get clientState(){return this.#e}recordOperation(e){try{if(!e||typeof e.type!="string"||this.#d||this.#u>0&&e.type==="grid_layout_change")return;try{this.#m.push(e.type),this.#m.length>20&&this.#m.shift()}catch{}if(e.type==="grid_layout_change"){const t=this.managers?.enhancedGridRenderer,i=typeof t?.getCurrentLayout=="function"?t.getCurrentLayout():null,r=i?JSON.parse(JSON.stringify(i)):null,s=this.#g?JSON.parse(JSON.stringify(this.#g)):null;this.#e.undoStack.push({type:e.type,before:s,after:r,meta:{source:e.data||null}});return}this.#e.undoStack.push({type:e.type,data:e.data||null}),this.#e.redoStack.clear(),this.emit("operationRecorded",{type:e.type})}catch(t){console.warn("[HybridStateManager] recordOperation failed:",t)}}recordOperationWithSnapshots({type:e,before:t,after:i,meta:r}={}){try{if(!e)return;this.#e.undoStack.push({type:e,before:t?JSON.parse(JSON.stringify(t)):null,after:i?JSON.parse(JSON.stringify(i)):null,meta:r||null}),this.#e.redoStack.clear(),this.emit("operationRecorded",{type:e})}catch(s){console.warn("[HybridStateManager] recordOperationWithSnapshots failed:",s)}}transaction(e){if(typeof e!="function")return;const t=this.managers?.enhancedGridRenderer;if(this.#u++,this.#u===1&&t?.getCurrentLayout)try{const s=t.getCurrentLayout();this.#y=s?JSON.parse(JSON.stringify(s)):null}catch{this.#y=null}let i,r;try{i=e()}catch(s){r=s}if(--this.#u===0)try{if(r)this.#y&&this.#w(this.#y);else if(t?.getCurrentLayout){const s=t.getCurrentLayout(),n={type:"grid_layout_change",data:{batched:!0}},a=s?JSON.parse(JSON.stringify(s)):null,c=this.#y?JSON.parse(JSON.stringify(this.#y)):null;this.#e.undoStack.push({type:n.type,before:c,after:a,meta:n.data}),this.#s.forensicLogger?.logAuditEvent("GRID_LAYOUT_TRANSACTION_COMMITTED",{before:c?.blocks?.length,after:a?.blocks?.length,source:"transaction"}),this.#e.redoStack.clear(),this.#g=a,this.emit("operationRecorded",{type:n.type})}}finally{this.#y=null}if(r)throw r;return i}getHistoryInfo(){let e=null;try{const i=this.#e.undoStack.peek();i&&(e=i.type)}catch{}const t=(()=>{try{return this.#m.slice(-5)}catch{return[]}})();return{undoSize:this.#e.undoStack.size,redoSize:this.#e.redoStack.size,lastType:e,recent:t}}undo(){try{const e=this.#e.undoStack.pop();if(!e)return;if(e.type==="grid_layout_change"&&e.before){this.#d=!0,this._isApplyingHistory=!0,this.#w(e.before),this.#d=!1,this._isApplyingHistory=!1,this.#e.redoStack.push({type:e.type,before:e.before,after:e.after}),this.#g=e.before?JSON.parse(JSON.stringify(e.before)):null,this.emit("layoutRestored",{direction:"undo",snapshot:e.before});return}}catch(e){console.warn("[HybridStateManager] undo failed:",e)}finally{this.#d=!1,this._isApplyingHistory=!1}}redo(){try{const e=this.#e.redoStack.pop();if(!e)return;if(e.type==="grid_layout_change"&&e.after){this.#d=!0,this.#w(e.after),this.#d=!1,this.#e.undoStack.push({type:e.type,before:e.before,after:e.after}),this.#g=e.after?JSON.parse(JSON.stringify(e.after)):null,this.emit("layoutRestored",{direction:"redo",snapshot:e.after});return}}catch(e){console.warn("[HybridStateManager] redo failed:",e)}finally{this.#d=!1,this._isApplyingHistory=!1}}#w(e){try{const t=this.managers?.enhancedGridRenderer;if(!t||typeof t.updateBlockPosition!="function")return;const i=Array.isArray(e?.blocks)?e.blocks:[];for(const r of i){const s=r.position?.x??r.x,n=r.position?.y??r.y,a=r.position?.w??r.w,c=r.position?.h??r.h;[s,n,a,c].every(l=>Number.isFinite(l))&&t.updateBlockPosition(r.blockId,s,n,a,c)}this.emit("layoutChanged",{type:"history_apply"})}catch(t){console.warn("[HybridStateManager] applyLayoutSnapshot failed:",t)}}get storage(){return this.#i}get schema(){return this.#r}get managers(){return this.#s}get serviceRegistry(){return this.#o}get metricsRegistry(){return this.#c}get signer(){return this.#h}get initialized(){return this.#l}set initialized(e){this.#l=!!e}constructor(e={}){this.#t={maxUndoStackSize:e.maxUndoStackSize||50,performanceMode:e.performanceMode??!1,offlineEnabled:e.offlineEnabled||!0,embeddingEnabled:e.embeddingEnabled||!0,storageConfig:{demoMode:e.demoMode??!0,auditLevel:e.auditLevel||"standard",strictValidation:e.strictValidation||!1,enableSync:e.enableSync!==!1,offlineMode:e.offlineMode??e.demoMode??!1,realtimeSync:e.realtimeSync||!1,...e.storageConfig},...e},this.#e={entities:new Map,relationships:new Map,undoStack:new _(this.#t.maxUndoStackSize),redoStack:new _(this.#t.maxUndoStackSize),pendingOperations:new _(100),errors:[],searchIndex:new Map,viewport:{entities:new Map,currentFilter:null},selectedEntities:new Set,dragState:null,cache:null},this.#i={loader:null,instance:null,ready:!1,config:null},this.#r={entities:new Map,fields:new Map,relationships:new Map,classifications:new Set,loaded:!1},this.#n=new Map,this.#s={policies:null,plugin:null,embeddingManager:null,extension:null,validationLayer:null,securityManager:null,forensicLogger:null,idManager:null,cacheManager:null,databaseOptimizer:null,adaptiveRenderer:null,buildingBlockRenderer:null,queryService:null,eventFlowEngine:null,asyncOrchestrator:null,componentRegistry:null,conditionRegistry:null,actionHandler:null,errorHelpers:null,cds:null},this.#o=new Qe(this),this.#a=[],this.#h=null,this.#c=null,this.#l=!1}async bootstrapSubsystems(){await this.#o.get("cacheManager"),this.#c=await this.#o.get("metricsRegistry"),await this.#o.get("eventFlowEngine");const e=await this.#o.get("nonRepudiation");this.#h=e,console.log("[HybridStateManager] Core subsystems bootstrapped."),this.#s.cacheManager&&(this.#e.cache=this.#s.cacheManager.getCache("clientState")),this.#c&&(this.saveEntity=this.metricsRegistry.namespace("state").measure("saveEntity")(this.saveEntity.bind(this)))}get(e){if(e)return this.#v(String(e))}async set(e,t){if(!e)return t;const i=String(e),r=this.get(i);return Object.is(r,t)||(this.#b(i,t),this.#_({path:i,value:t,previous:r})),t}subscribe(e,t){if(!e||typeof t!="function")return()=>{};const i=String(e),r=this.#f.get(i)||new Set;return r.add(t),this.#f.set(i,r),()=>{const s=this.#f.get(i);s&&(s.delete(t),s.size===0&&this.#f.delete(i))}}#_(e){const t={path:e.path,value:e.value,previous:e.previous,changedPaths:[e.path]},i=this.#f.get(e.path);if(i)for(const r of i)try{r(e.value)}catch(s){console.error(`[HybridStateManager] subscriber for "${e.path}" failed:`,s)}this.emit("stateChanged",t),this.emit("state:changed",t),this.emit("stateChange",t)}#b(e,t){const i=e.split(".");let r=this.#p;for(let s=0;s<i.length;s++){const n=i[s];s===i.length-1?r[n]=t:((r[n]===void 0||r[n]===null||typeof r[n]!="object")&&(r[n]={}),r=r[n])}}#v(e){const t=e.split(".");let i=this.#p;for(const r of t){if(i==null||!(r in i))return;i=i[r]}return i}async recordAuditEvent(e,t,i={}){try{const r=this.#s.forensicLogger;if(!r){console.warn("[HybridStateManager] ForensicLogger not available for audit event.");return}await r.logAuditEvent(e,t,i)}catch(r){console.error("[HybridStateManager] Failed to log audit event:",r)}}async initializeStorageSystem(e,t){if(this.#i.ready)return this.#i;const i=await this.#o.get("securityManager");e?.userId&&e?.clearanceLevel&&i.setUserContext(e.userId,e.clearanceLevel,e.compartments);const r=await this.#o.get("storageLoader");this.#i.loader=r,this.#i.instance=await this.#i.loader.createStorage(e,{demoMode:!!this.#t.demoMode,enableSync:this.#t?.sync?.enableSync===!0,realtimeSync:this.#t?.sync?.realtime===!0,mac:i.mac,stateManager:t}),this.storage.ready=!0,this.emit("storageReady",{loader:this.#i.loader,instance:this.#i.instance})}storeFor(e){return e&&e.logical_id&&e.classification_level?"objects_polyinstantiated":"objects"}async saveEntity(e){return g.createEnvelope({actorId:"system",action:"saveEntity",target:e?.id,label:"entity_mutation"}).catch(()=>{}),this.#s.errorHelpers.tryOr(async()=>{if(!this.#i.ready)throw new Error("Storage system not initialized");const t=this.storeFor(e);t==="objects_polyinstantiated"&&!e.logical_id&&(e.logical_id=this.#s.idManager.generate()),this.#e.entities.set(e.id,e);const i=await this.#i.instance.put(t,e);return this.#s.forensicLogger?.logAuditEvent("ENTITY_SAVED",{entityId:e.id,entityType:e.type}),this.emit("entitySaved",{store:t,id:e.id||e.logical_id,entity:e}),i},t=>{throw this.emit("entitySaveFailed",{entity:e,error:t,severity:"high"}),t},{component:"HybridStateManager",operation:"saveEntity"})}async loadEntity(e){try{if(!this.#i.ready)throw new Error("Storage system not initialized");const t=await this.#i.instance.get("objects_polyinstantiated",e);return t||await this.#i.instance.get("objects",e)}catch(t){throw console.error(`[HybridStateManager] Failed to load entity ${e}:`,t),this.emit("entityLoadFailed",{id:e,error:t}),t}}async loadEntities(e={}){const t=performance.now();try{if(!this.#i.ready)throw new Error("Storage system not initialized");const i=await this.#i.instance.getAll("objects");return i.forEach(r=>this.#e.entities.set(r.id,r)),this.#c?.updateAverage("storage.loadTime",performance.now()-t),this.emit("entitiesLoaded",{result:i}),i}catch(i){throw console.error("[HybridStateManager] Failed to load entities:",i),this.emit("entitiesLoadFailed",{error:i}),i}}async deleteEntity(e){g.createEnvelope({actorId:"system",action:"deleteEntity",target:e,label:"entity_mutation"}).catch(()=>{});try{if(!this.#i.ready)throw new Error("Storage system not initialized");this.#e.entities.delete(e),await this.#i.instance.delete("objects_polyinstantiated",e),await this.#i.instance.delete("objects",e),this.#s.forensicLogger?.logAuditEvent("ENTITY_DELETED",{entityId:e,status:"success"}),this.emit("entityDeleted",{id:e})}catch(t){throw console.error(`[HybridStateManager] Failed to delete entity ${e}:`,t),this.emit("entityDeleteFailed",{id:e,error:t}),t}}async getEntityHistory(e){try{if(!this.#i.ready)throw new Error("Storage system not initialized");const t=await this.#i.instance.getHistory("objects_polyinstantiated",e);return this.emit("entityHistoryLoaded",{id:e,history:t}),t}catch(t){throw console.error(`[HybridStateManager] Failed to get history for entity ${e}:`,t),this.emit("entityHistoryFailed",{id:e,error:t}),t}}async syncEntities(e={}){const t=performance.now();try{if(!this.#i.ready||!this.#i.instance.sync)return console.warn("[HybridStateManager] Sync not available"),{synced:0,skipped:0};const i=await this.#i.instance.sync(e);return this.#c?.updateAverage("storage.syncTime",performance.now()-t),this.emit("entitiesSynced",{result:i}),i}catch(i){throw console.error("[HybridStateManager] Failed to sync entities:",i),this.emit("entitiesSyncFailed",{error:i}),i}}async setUserSecurityContext(e,t,i=[],r=4*36e5){try{const s=this.#s.securityManager;if(!s)throw new Error("SecurityManager not initialized.");s.setUserContext(e,t,i,r),this.emit("securityContextSet",{userId:e,clearanceLevel:t,compartments:i})}catch(s){throw console.error("[HybridStateManager] Failed to set security context:",s),s}}on(e,t){return this.#n.has(e)||this.#n.set(e,[]),this.#n.get(e).push(t),()=>{const r=this.#n.get(e);if(r){const s=r.indexOf(t);s>-1&&r.splice(s,1)}}}#E(){this.#a.forEach(e=>{typeof e=="function"&&e()}),this.#a.length=0}emit(e,t){const i=this.#n.get(e)||[];i&&i.forEach(s=>{try{s(t)}catch(n){console.error(`Error in listener for event ${e}:`,n)}}),(this.#n.get("*")||[]).forEach(s=>{try{s(t,e)}catch(n){console.error(`Error in wildcard listener for event ${e}:`,n)}})}async cleanup(){console.log("[HybridStateManager] Starting cleanup..."),this.#E();for(const e in this.#s){const t=this.#s[e];if(t&&typeof t.cleanup=="function")try{await t.cleanup()}catch(i){console.error(`[HybridStateManager] Error cleaning up manager '${e}':`,i)}}this.#n.clear(),this.#l=!1,console.log("[HybridStateManager] Cleanup complete.")}}async function et(o,{minDurationMs:e=100,errorHelpers:t=null,metrics:i=null,operationName:r="unknown"}={}){const s=performance.now();let n=0;try{return await o()}catch(a){throw t?.report(a,{component:"constantTimeCheck",operation:r,isSuppressed:!0}),new Error(`Constant-time operation '${r}' failed.`)}finally{const a=performance.now()-s;a<e&&(n=e-a,await new Promise(c=>setTimeout(c,n))),i?.timer("ct.padding.duration",n,{operation:r})}}class tt{#t;#e=new Map;#i=!1;#r=[];#s=null;constructor(e){if(this.#t=e,!e?.stateManager)throw new Error("BindEngine requires stateManager");this.#s=this.#h()}async start(e=document){if(this.#i)return;this.#i=!0;const t=["stateChanged","state:changed","stateChange"];for(const i of t){const r=this.#t.stateManager.on?.(i,s=>{try{this.#a(s)}catch{}});typeof r=="function"&&this.#r.push(r)}await this.bindAll(e)}stop(){for(const e of this.#r)try{e()}catch{}this.#r.length=0;for(const[e,t]of this.#e)t.unsub?.(),this.#e.delete(e);this.#i=!1}async bindAll(e=document){const t=e.querySelectorAll?.("[data-bind]")??[];for(const i of t){const r=i.getAttribute("data-bind");if(!r)continue;const s={format:i.getAttribute("data-bind-format")||void 0,twoWay:i.getAttribute("data-bind-two-way")==="true",attr:i.getAttribute("data-bind-attr")||void 0,fallback:i.getAttribute("data-bind-fallback")||""};await this.registerBinding(i,r,s)}}async registerBinding(e,t,i={}){this.unregisterBinding(e);const r=this.#t.stateManager.subscribe?this.#t.stateManager.subscribe(t,n=>this.#o(e,t,n,i)):void 0;this.#e.set(e,{path:t,opts:i,unsub:r});const s=this.#t.stateManager.get?.(t);await this.#o(e,t,s,i),i.twoWay&&this.#u(e,t,i)}unregisterBinding(e){const t=this.#e.get(e);t&&(t.unsub?.(),this.#e.delete(e))}async updateBinding(e,t){e&&await this.#n("UI_BIND_UPDATE_COARSE",{path:e,source:"StateUIBridge"},async()=>{for(const[i,r]of this.#e){if(r.path!==e)continue;const s=t!==void 0?t:this.#t.stateManager.get?.(e);try{await this.#o(i,e,s,r.opts)}catch{}}})}async#n(e,t,i){const r=this.#t.forensicLogger;if(!r?.createEnvelope||!r?.commitEnvelope)return await i();const s=t?.path!=null?this.#c(t.path):{level:"unclassified",compartments:new Set},n={...t,classification:{level:s.level,compartments:Array.from(s.compartments||[])}};let a;try{a=r.createEnvelope(e,n)}catch{return await i()}if(!a)return await i();let c;try{c=await i()}catch(l){try{const h=await a;await r.commitEnvelope(h)}catch{}throw l}try{const l=await a;await r.commitEnvelope(l)}catch{}return c}#a(e){const t=new Set(e?.changedPaths||[]);for(const[i,{path:r,opts:s}]of this.#e)if(t.size===0||t.has(r)){const n=this.#t.stateManager.get?.(r);this.#o(i,r,n,s)}}async#o(e,t,i,r){const s=globalThis.performance?.now?.()??Date.now();let n;if(!this.#t.securityManager&&!this.#t.stateManager?.mac?n=!0:n=await et(async()=>{const l=this.#c(t);return this.#t.securityManager?.canRead?!!await this.#t.securityManager.canRead(l,t):!0},{minDurationMs:this.#t.ctMinDurationMs??0}),!n){this.#t.securityExplainer?this.#t.securityExplainer.renderRestriction(e,{reason:"no-read-up",path:t}):this.#g(e,()=>{e.textContent=r.fallback??"Restricted"},{type:"UI_BIND_DENIED",path:t}),this.#t.metrics?.increment?.("bind.render.denied",1);return}let a=i;typeof r.map=="function"&&(a=r.map(a)),r.format&&typeof this.#t.stateManager.format=="function"&&(a=this.#t.stateManager.format(r.format,a)),a=this.#l(a),r.attr?this.#g(e,()=>{e.setAttribute(r.attr,a==null?"":String(a))},{type:"UI_BIND_ATTR",path:t,attr:r.attr,value:a}):this.#g(e,()=>{e.textContent=a==null?"":String(a)},{type:"UI_BIND_TEXT",path:t,value:a});const c=(globalThis.performance?.now?.()??Date.now())-s;this.#t.metrics?.record?.("bind.render.time",{path:t,ms:c}),this.#t.metrics?.increment?.("bind.render.count",1)}#c(e){const t=this.#t.stateManager,i=t?.mac||this.#t.securityManager,r=t?.get?.(e);if(i?.label)return i.label(r??{classification:"unclassified",compartments:[]});const s=r?.classification||"unclassified",n=new Set(r?.compartments||[]);return{level:s,compartments:n}}#h(){const e=this.#t.stateManager,t=e?.managers?.sanitizer||e?.sanitizer||null;return t&&t!==this.#s&&(this.#s=t),this.#s}#l(e){const t=this.#h();if(!t)return e;try{if(typeof e=="string"&&t.cleanseText)return t.cleanseText(e)??"";if(t.cleanse){const i=t.cleanse(e);return i==null&&typeof e=="string"?"":i}return e}catch(i){if(console.warn("[BindEngine] Failed to sanitize outbound value.",i),typeof e=="string"&&t.cleanseText)try{return t.cleanseText(String(e))}catch{return""}return e}}#d(e){const t=this.#h();if(!t)return e??(typeof e=="string"?"":e);try{if(typeof e=="string"&&t.cleanseText)return t.cleanseText(e)??"";if(t.cleanse){const i=t.cleanse(e);return i==null&&typeof e=="string"?"":i}return e}catch(i){if(console.warn("[BindEngine] Failed to sanitize inbound value.",i),typeof e=="string"&&t.cleanseText)try{return t.cleanseText(String(e))}catch{return""}return typeof e=="string"?"":null}}async#g(e,t,i){const r=this.#t.forensicLogger.createEnvelope("DOM_MUTATION",{target:e.tagName,...i});try{t(),r.then(s=>this.#t.forensicLogger.commitEnvelope(s)).catch(()=>{})}catch(s){throw r.then(n=>this.#t.forensicLogger.commitEnvelope(n)).catch(()=>{}),s}}#u(e,t,i){const r=async c=>{const l=c.target.value,h=this.#d(l),d=await this.#t.forensicLogger.createEnvelope("UI_BIND_MUTATION",{path:t,value:h,source:"input"});try{await this.#t.stateManager.set?.(t,h),await this.#t.forensicLogger.commitEnvelope(d)}catch(u){throw await this.#t.forensicLogger.commitEnvelope(d),u}};e.addEventListener("input",r),e.addEventListener("change",r);const s=this.#e.get(e),n=s?.unsub,a=()=>{e.removeEventListener("input",r),e.removeEventListener("change",r),n?.()};s&&this.#e.set(e,{...s,unsub:a})}}async function it(o){const e=await o.forensicLogger.createEnvelope("SERVICE_START",{service:"BindEngine",context:"bootstrap"});try{const t=new tt(o);return await t.start(document),await o.forensicLogger.commitEnvelope(e),t}catch(t){throw await o.forensicLogger.commitEnvelope(e),t}}class nt{#t;#e=null;#i=null;#r=null;#s=null;constructor(e){this.#t=e}async initialize(e){const t=performance.now();console.log("[SystemBootstrap] V8 Parity Initializing...");try{this.#e=new Ze(this.#t),await this.#n(e),this.#r?.logAuditEvent("BOOTSTRAP_START",{userId:e?.userId,timestamp:p.now()}),await this.#o(),await this.#a();const i=performance.now()-t;return this.#i?.timer("bootstrap.total_duration",i),this.#r?.logAuditEvent("BOOTSTRAP_SUCCESS",{duration:i}),this.#c()}catch(i){const r=performance.now()-t;throw console.error(`[SystemBootstrap] CRITICAL FAILURE after ${r.toFixed(2)}ms:`,i),this.#r?.logAuditEvent("BOOTSTRAP_FAILURE",{error:i.message,stack:i.stack,duration:r}),new Error(`System initialization failed: ${i.message}`)}}async#n(e){await this.#e.serviceRegistry.initializeAll(),await this.#e.initializeStorageSystem(e,this.#e);try{if(!globalThis.__NODUS_CDS_TRANSPORT__){const r=this.#t?.cdsTransport;if(this.#t?.cdsProxyEndpoint){const s=typeof globalThis<"u"&&globalThis.__NODUS_NATIVE_FETCH__;typeof s=="function"&&(globalThis.__NODUS_CDS_TRANSPORT__=K({proxyEndpoint:this.#t.cdsProxyEndpoint},s,this.#e.managers.forensicLogger))}else typeof r=="function"?globalThis.__NODUS_CDS_TRANSPORT__=r:r&&typeof r.nativeFetch=="function"?globalThis.__NODUS_CDS_TRANSPORT__=L(r.nativeFetch):typeof globalThis<"u"&&typeof globalThis.__NODUS_NATIVE_FETCH__=="function"&&(globalThis.__NODUS_CDS_TRANSPORT__=L(globalThis.__NODUS_NATIVE_FETCH__))}}catch(r){console.warn("[SystemBootstrap] Failed to wire CDS transport:",r)}const t=performance.now();if(console.log("[SystemBootstrap] Loading core infrastructure managers..."),this.#i=this.#e.metricsRegistry,this.#r=this.#e.managers.forensicLogger,!this.#s){const r=this;this.#s=new F({searchPaths:["/src/platform/security/encryption","/src/platform/security","/src/platform/storage/validation","/src/platform/storage/sync","/src/platform/storage/adapters","/src/platform/storage"],legacyMap:new Map(Object.entries(I)),baseURL:"/src/platform/storage/modules/",metrics:this.#i,forensic:this.#r,policy:{get enforceCanonicalOnly(){try{return r.#e?.managers?.policies?.getPolicy?.("storage","enforce_canonical_only")===!0}catch{return!1}}}}),this.#e.canonicalResolver=this.#s}const i=performance.now()-t;this.#i?.timer("bootstrap.core_infra_duration",i);try{this.#e.emit?.("metrics",{type:"bootstrap.stage",stage:"core_infra",duration:i})}catch{}}async#a(){const e=performance.now();console.log("[SystemBootstrap] Loading application services...");const t=performance.now();await this.#d();try{this.#e.emit?.("metrics",{type:"bootstrap.stage",stage:"event_flows",duration:performance.now()-t})}catch{}try{await this.#g()}catch(i){console.warn("[SystemBootstrap] BindEngine initialization failed:",i)}this.#l();try{const i=this.#e?.managers?.completeGridSystem;i&&typeof i.initialize=="function"&&(typeof i.isInitialized=="function"&&i.isInitialized()||(console.log("[SystemBootstrap] Ensuring completeGridSystem is initialized..."),await i.initialize(),console.info("[SystemBootstrap] completeGridSystem initialized.")))}catch(i){console.warn("[SystemBootstrap] Warning: completeGridSystem initialization failed (non-fatal):",i)}this.#i?.timer("bootstrap.app_services_duration",performance.now()-e)}async#o(){console.log("[SystemBootstrap] Running security validation checks...");const e=this.#e.managers.plugin;e&&typeof e.validateAllRuntimes=="function"&&await e.validateAllRuntimes()}#c(){return this.#e.initialized=!0,console.log("[SystemBootstrap] Application initialized successfully."),this.#e.emit("systemInitialized",{timestamp:p.now()}),this.#e}#h(){console.log("[SystemBootstrap] Initializing metrics pipeline..."),this.#e.managers.metricsReporter?.start().then(()=>console.log("[SystemBootstrap] Metrics reporting pipeline started.")).catch(e=>console.error("Failed to start metrics pipeline:",e))}#l(){this.#h()}async#d(){const e=this.#e.managers.eventFlowEngine;if(!(!e||!this.#e.storage.ready))try{const t=await this.#e.storage.instance.query("objects","entity_type","event_flow");for(const i of t||[])e.registerFlow(i.data||i.content||i);console.log(`[SystemBootstrap] Loaded ${t?.length||0} event flows from storage.`)}catch(t){console.error("[SystemBootstrap] Failed to load event flows:",t)}}async#g(){const e=this.#e,t=this.#r,i=this.#e?.managers?.eventFlowEngine||this.#e?.managers?.eventFlow,r=this.#e?.managers?.metricsRegistry,s=this.#e?.managers?.securityManager,n=this.#e?.managers?.securityExplainer,a=await it({stateManager:e,forensicLogger:t,eventBus:i,metrics:r,securityManager:s,securityExplainer:n});this.#e?.serviceRegistry?.register?.("bindEngine",a),console.log("[SystemBootstrap] âœ… BindEngine service initialized and running")}}const rt={setText(o,e){o&&(o.textContent=e??"")},replace(o,e){if(!o)return;const t=document.createElement(o.tagName);t.textContent=e??"",o.replaceWith(t)},insert(o,e,t="beforeend"){o&&o.insertAdjacentText(t,e??"")}};class at{constructor(e){if(!e)throw new Error("StateUIBridge requires a stateManager instance.");this.#r=e,this.#s=e?.forensicLogger??null}bindGrid(e){if(!this.#r||!e?.refreshRow||!e?.removeRow)return this.#s?.warn?.("StateUIBridge: Could not bind grid. StateManager is missing or grid does not implement the required methods (refreshRow, removeRow).",{context:"UIBinding"}),()=>{};const t=this.#r.on("entitySaved",this.#t.bind(this,e)),i=this.#r.on("entityDeleted",this.#e.bind(this,e)),r=this.#r.on("syncCompleted",this.#i.bind(this,e)),s=()=>{t?.(),i?.(),r?.(),this.#n.delete(s)};return this.#n.add(s),s}attachBindEngine(e){this.#o=e||null}enableDomBridge({root:e=document,updateInputs:t=!1}={}){if(this.disableDomBridge(),!e?.querySelectorAll||typeof this.#r?.on!="function")return()=>{};const i=({path:s,value:n})=>{if(typeof this.#o?.updateBinding=="function"){this.#o.updateBinding(s,n);return}const a=e.querySelectorAll?.(`[data-bind="${s}"]`);if(!(!a||a.length===0))for(const c of a)t&&c&&c.nodeType===1&&typeof c.matches=="function"&&c.matches("input, textarea, select")?document.activeElement!==c&&(c.value=n==null?"":String(n)):rt.setText(c,n==null?"":String(n))},r=this.#r.on("stateChange",i);return this.#a=()=>{r?.(),this.#a=null},this.#a}disableDomBridge(){this.#a?.(),this.#a=null}async updateState(e,t,{eventType:i="UI_STATE_CHANGE",actorId:r="ui.bridge"}={}){if(!e)return;const s=this.#r?.set;if(typeof s=="function")return W.wrap(()=>s.call(this.#r,e,t),{stateManager:this.#r,label:`ui.state.update.${e}`,eventType:i,actorId:r,meta:{path:e,source:"StateUIBridge.updateState"}})}dispose(){this.disableDomBridge();for(const e of this.#n)try{e()}catch{}this.#n.clear(),this.#o=null}#t(e,{store:t,item:i}){t==="objects"&&e.refreshRow(i)}#e(e,{store:t,id:i}){t==="objects"&&e.removeRow(i)}#i(e){e.refresh?.()}#r;#s;#n=new Set;#a=null;#o=null}export{_ as B,g as F,nt as S,tt as a,at as b};
