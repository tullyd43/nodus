import{F as S}from"./platform-BD71WT6-.js";const j="modulepreload",V=function(p,t){return new URL(p,t).href},z={},D=function(t,e,n){let i=Promise.resolve();if(e&&e.length>0){let a=function(d){return Promise.all(d.map(g=>Promise.resolve(g).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};const s=document.getElementsByTagName("link"),r=document.querySelector("meta[property=csp-nonce]"),l=r?.nonce||r?.getAttribute("nonce");i=a(e.map(d=>{if(d=V(d,n),d in z)return;z[d]=!0;const g=d.endsWith(".css"),h=g?'[rel="stylesheet"]':"";if(n)for(let u=s.length-1;u>=0;u--){const y=s[u];if(y.href===d&&(!g||y.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${h}`))return;const c=document.createElement("link");if(c.rel=g?"stylesheet":j,g||(c.as="script"),c.crossOrigin="",c.href=d,l&&c.setAttribute("nonce",l),document.head.appendChild(c),g)return new Promise((u,y)=>{c.addEventListener("load",u),c.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(s){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=s,window.dispatchEvent(r),!r.defaultPrevented)throw s}return i.then(s=>{for(const r of s||[])r.status==="rejected"&&o(r.reason);return t().catch(o)})};class O extends Error{constructor(t){super(t),this.name="DateUtilsError"}}class ${#t;constructor(t){if(this.#t=new Date(t),isNaN(this.#t.getTime()))throw new O(`Invalid date provided to ImmutableDateTime: ${t}`);Object.freeze(this)}valueOf(){return this.#t.getTime()}toDate(){return new Date(this.#t)}getFullYear(){return this.#t.getFullYear()}getMonth(){return this.#t.getMonth()}getDate(){return this.#t.getDate()}getDay(){return this.#t.getDay()}getHours(){return this.#t.getHours()}getMinutes(){return this.#t.getMinutes()}getSeconds(){return this.#t.getSeconds()}getMilliseconds(){return this.#t.getMilliseconds()}getTime(){return this.#t.getTime()}getTimezoneOffset(){return this.#t.getTimezoneOffset()}getUTCFullYear(){return this.#t.getUTCFullYear()}getUTCMonth(){return this.#t.getUTCMonth()}getUTCDate(){return this.#t.getUTCDate()}getUTCDay(){return this.#t.getUTCDay()}getUTCHours(){return this.#t.getUTCHours()}getUTCMinutes(){return this.#t.getUTCMinutes()}getUTCSeconds(){return this.#t.getUTCSeconds()}getUTCMilliseconds(){return this.#t.getUTCMilliseconds()}toISOString(){return this.#t.toISOString()}toJSON(){return this.#t.toJSON()}toLocaleDateString(t,e){return this.#t.toLocaleDateString(t,e)}toLocaleString(t,e){return this.#t.toLocaleString(t,e)}toLocaleTimeString(t,e){return this.#t.toLocaleTimeString(t,e)}toString(){return this.#t.toString()}toDateString(){return this.#t.toDateString()}toTimeString(){return this.#t.toTimeString()}toUTCString(){return this.#t.toUTCString()}}class T{static timestamp(){return Date.now()}static now(){return new Date().toISOString()}static toDate(t){return t instanceof $?t:new $(t)}static toISODateLocal(t){const e=this.toDate(t),n=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${n}-${i}-${o}`}static toDateTimeLocal(t){const e=this.toDate(t),n=a=>String(a).padStart(2,"0"),i=e.getFullYear(),o=n(e.getMonth()+1),s=n(e.getDate()),r=n(e.getHours()),l=n(e.getMinutes());return`${i}-${o}-${s}T${r}:${l}`}static parseTimeString(t){if(typeof t!="string"||!/^\d{2}:\d{2}$/.test(t))throw new O(`Invalid time string format: ${t}. Expected HH:mm.`);const[e,n]=t.split(":").map(Number);if(e<0||e>23||n<0||n>59)throw new O(`Invalid time value: ${t}.`);return e*60+n}static humanizeDuration(t,{maxUnits:e=2,compact:n=!1}={}){if(typeof t!="number"||!Number.isFinite(t))return n?"0s":"0 seconds";const i=[{name:"year",short:"y",ms:31536e6},{name:"month",short:"mo",ms:2592e6},{name:"week",short:"w",ms:6048e5},{name:"day",short:"d",ms:864e5},{name:"hour",short:"h",ms:36e5},{name:"minute",short:"m",ms:6e4},{name:"second",short:"s",ms:1e3}],o=[];let s=Math.abs(t);for(const r of i){if(o.length>=e||s<r.ms)continue;const l=Math.floor(s/r.ms);if(l>0){const a=n?r.short:` ${r.name}${l!==1?"s":""}`;o.push(`${l}${a}`),s-=l*r.ms}}return o.length===0?t<1e3&&t>0?n?"<1s":"less than 1 second":n?"0s":"0 seconds":o.join(n?" ":", ")}}class Y{#t;#i=null;#e=!1;constructor({stateManager:t}){this.#t=t}initialize(){this.#s();const t=n=>{n.altKey&&n.key?.toLowerCase()==="h"&&(n.preventDefault(),this.toggle())};document.addEventListener("keydown",t);const e=()=>this.#n();this.#t?.on?.("operationRecorded",e),this.#t?.on?.("layoutRestored",e)}toggle(){this.#e=!this.#e,this.#i||this.#s(),this.#i.style.display=this.#e?"block":"none",this.#e&&this.#n()}#s(){if(this.#i)return;const t=document.createElement("div");t.id="grid-history-inspector",t.style.cssText=`
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 10000;
      background: rgba(30,30,30,0.9);
      color: #fff;
      padding: 12px 14px;
      border-radius: 8px;
      font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
      display: none;
      min-width: 200px;
    `;const e=document.createElement("div");e.style.cssText="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:8px;";const n=document.createElement("strong");n.textContent="Grid History";const i=document.createElement("button");i.id="ghi-close",i.style.cssText="background:#444;color:#fff;border:0;border-radius:4px;padding:4px 6px;cursor:pointer",i.textContent="×",e.appendChild(n),e.appendChild(i);const o=document.createElement("div");o.id="ghi-body";const s=document.createElement("div");s.style.cssText="display:flex; gap:8px; margin-bottom:8px;";const r=document.createElement("button");r.id="ghi-undo-btn",r.title="Undo (Ctrl/Cmd+Z)",r.style.cssText="background:#2b7cff;color:#fff;border:0;border-radius:4px;padding:6px 8px;cursor:pointer",r.textContent="Undo";const l=document.createElement("button");l.id="ghi-redo-btn",l.title="Redo (Ctrl/Cmd+Y)",l.style.cssText="background:#2b7cff;color:#fff;border:0;border-radius:4px;padding:6px 8px;cursor:pointer",l.textContent="Redo",s.appendChild(r),s.appendChild(l);const a=document.createElement("div");a.appendChild(document.createTextNode("Undo: "));const d=document.createElement("span");d.id="ghi-undo",d.textContent="0",a.appendChild(d);const g=document.createElement("div");g.appendChild(document.createTextNode("Redo: "));const h=document.createElement("span");h.id="ghi-redo",h.textContent="0",g.appendChild(h);const c=document.createElement("div");c.appendChild(document.createTextNode("Last: "));const u=document.createElement("span");u.id="ghi-last",u.textContent="—",c.appendChild(u);const y=document.createElement("div");y.style.marginTop="6px",y.textContent="Recent:";const m=document.createElement("ul");m.id="ghi-recent",m.style.cssText="margin:6px 0 0 16px; padding:0; list-style:disc; opacity:0.9";const f=document.createElement("div");f.style.marginTop="8px",f.style.opacity="0.8",f.textContent="Toggle: Alt+H",o.appendChild(s),o.appendChild(a),o.appendChild(g),o.appendChild(c),o.appendChild(y),o.appendChild(m),o.appendChild(f),t.appendChild(e),t.appendChild(o),t.querySelector("#ghi-close").addEventListener("click",()=>this.toggle()),t.querySelector("#ghi-undo-btn").addEventListener("click",()=>{try{this.#t?.undo?.(),this.#n()}catch{}}),t.querySelector("#ghi-redo-btn").addEventListener("click",()=>{try{this.#t?.redo?.(),this.#n()}catch{}}),document.body.appendChild(t),this.#i=t}#n(){if(!(!this.#i||!this.#e))try{const t=this.#t?.getHistoryInfo?.()||{undoSize:0,redoSize:0,lastType:null,recent:[]};this.#i.querySelector("#ghi-undo").textContent=String(t.undoSize??0),this.#i.querySelector("#ghi-redo").textContent=String(t.redoSize??0),this.#i.querySelector("#ghi-last").textContent=t.lastType||"—";const e=this.#i.querySelector("#ghi-recent");e.replaceChildren(),(t.recent||[]).forEach(n=>{const i=document.createElement("li");i.textContent=n,e.appendChild(i)})}catch{}}}class K{#t=null;#i=null;#e=null;#s=null;#n=null;#d=null;#o=null;#r=null;#h={};#l=!1;#a=!1;#m=!1;#c=null;#x=!1;#p=[];#P=null;#u=24;#S=!0;#g=3;#v=["right","down","left","up"];#_=!1;#M=new Map;#F=!0;#L=1200;#I=!1;#f=8;#y=null;#R=0;#E=null;#z=!1;#k=null;#b=null;#T=!1;constructor(t){const e=t&&t.stateManager?t.stateManager:t;this.#t=e,this.#i=e?.managers?.errorHelpers||null,this.#d=e?.managers?.gridToastManager||null,this.#e=e?.metricsRegistry?.namespace("grid.renderer")||null,this.#s=e?.managers?.policies||null,this.#n=e?.eventFlowEngine||null,this.#v}initialize(t={}){if(!this.#l){this.#o=t.container||document.querySelector(".grid-container")||document.querySelector("#view-container")||document.body,this.#r=t.appViewModel||{},this.#h={onLayoutChange:null,enableKeyboard:!0,enableAria:!0,...t.options};try{const e=this.#s?.getPolicy?.("grid","default_columns");Number.isInteger(e)&&e>0&&(this.#u=e)}catch{}this.#H(),this.#nt(),this.#B(),this.#ot();try{this.#T=!!this.#s?.getPolicy?.("grid","reflow_on_drag_enabled")}catch{this.#T=!1}try{this.#_=!!this.#s?.getPolicy?.("grid","reflow_live_preview")}catch{this.#_=!1}this.#D(),this.#l=!0;try{this.#C()}catch{}try{if(this.#t?.managers){this.#t.managers.enhancedGridRenderer=this;try{console.log("[EnhancedGridRenderer] registered with stateManager.managers.enhancedGridRenderer")}catch{}this.#t?.on?.("layoutRestored",e=>{try{if(e?.direction==="undo"||e?.direction==="redo")try{this.getCurrentLayout()}catch{}}catch{}})}}catch{}this.#e?.increment("grid.enhanced"),this.#n?.emit("gridEnhanced",{renderer:this});try{const e=n=>{if(!(n.ctrlKey||n.metaKey))return;const i=n.key.toLowerCase();i==="z"&&!n.shiftKey&&typeof this.#t?.undo=="function"&&(n.preventDefault(),this.#t.undo(),this.#e?.increment("grid.undo")),(i==="y"||i==="z"&&n.shiftKey)&&typeof this.#t?.redo=="function"&&(n.preventDefault(),this.#t.redo(),this.#e?.increment("grid.redo"))};document.addEventListener("keydown",e),this.#P=()=>document.removeEventListener("keydown",e)}catch{}}}#B(){const t=()=>this.refresh();this.#t?.on&&(this.#p.push(this.#t.on("entitySaved",t)),this.#p.push(this.#t.on("entityDeleted",t)),this.#p.push(this.#t.on("syncCompleted",t)))}#H(){const t=this.#o.querySelectorAll(".grid-block");this.#o.style.display="grid",this.#o.style.gridTemplateColumns=`repeat(${this.#u}, 1fr)`,this.#o.style.gridAutoRows="60px",this.#o.style.gap="16px",this.#o.style.position=this.#o.style.position||"relative",t.forEach(e=>this.#A(e)),this.#it()}setGridColumns(t){const e=Number(t);if(!(!Number.isInteger(e)||e<=0)){this.#u=e,this.#o&&(this.#o.style.gridTemplateColumns=`repeat(${e}, 1fr)`);try{const n=this.getCurrentLayout(),i=Array.isArray(n?.blocks)?n.blocks:[],o=[];let s=0;for(const l of i){let a=l.position?.x??l.x??0,d=l.position?.w??l.w??1;const g=l.position?.y??l.y??0,h=l.position?.h??l.h??1,c=a,u=d;a>=e&&(a=Math.max(0,e-1)),a+d>e&&(d=Math.max(1,e-a)),(a!==c||d!==u)&&s++,o.push({blockId:l.blockId,x:a,y:g,w:d,h});const y=this.#o?.querySelector?.(`[data-block-id="${l.blockId}"]`);y&&(y.style.gridColumnStart=a+1,y.style.gridColumnEnd=a+d+1)}if(o.length&&this.#r?.gridLayoutViewModel?.updatePositions){const l=()=>this.#r.gridLayoutViewModel.updatePositions(o);typeof this.#t?.transaction=="function"?this.#t.transaction(l):l()}const r={columns:e,clampedCount:s};this.#n?.emit("gridColumnsChanged",r),this.#t?.emit?.("gridColumnsChanged",r)}catch{}}}#A(t){const e=this.#Z(t);if(!e)return;try{const i=this.#s?.getPolicy?.("grid","default_min_w")??1,o=this.#s?.getPolicy?.("grid","default_min_h")??1,s=this.#s?.getPolicy?.("grid","default_max_w")??this.#u,r=this.#s?.getPolicy?.("grid","default_max_h")??1e3,l=parseInt(t.dataset.minW||String(i),10),a=parseInt(t.dataset.minH||String(o),10),d=parseInt(t.dataset.maxW||String(s),10),g=parseInt(t.dataset.maxH||String(r),10);e.constraints={minW:Math.max(1,l),minH:Math.max(1,a),maxW:Math.max(1,Math.min(this.#u,d)),maxH:Math.max(1,g)}}catch{}t.style.gridColumnStart=e.position.x+1,t.style.gridColumnEnd=e.position.x+e.position.w+1,t.style.gridRowStart=e.position.y+1,t.style.gridRowEnd=e.position.y+e.position.h+1,t.classList.add("enhanced-grid-block"),this.#h.enableAria&&this.#G(t,e);const n=t.querySelector(".resize-handle");n&&this.#tt(n,e),this.#et(t,e),this.#h.enableKeyboard&&this.#U(t,e);try{this.#s?.getPolicy?.("grid","expand_enabled")!==!1&&(t.addEventListener("dblclick",()=>this.#ft(t,e)),t.classList.add("expandable"))}catch{}}#G(t,e){if(t.setAttribute("role","gridcell"),t.setAttribute("aria-label",`Grid block ${e.blockId} at position ${e.position.x}, ${e.position.y}`),t.setAttribute("aria-describedby",`${e.blockId}-instructions`),t.setAttribute("tabindex","0"),!document.getElementById(`${e.blockId}-instructions`)){const n=document.createElement("div");n.id=`${e.blockId}-instructions`,n.className="sr-only",n.textContent="Use arrow keys to move, Shift+arrow keys to resize, Enter to activate",n.style.cssText=`
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      `,document.body.appendChild(n)}t.addEventListener("focus",()=>{t.style.outline="3px solid #007cba",t.style.outlineOffset="2px"}),t.addEventListener("blur",()=>{t.style.outline="",t.style.outlineOffset=""})}#U(t,e){t.addEventListener("keydown",n=>{if(!t.matches(":focus"))return;let i=!1;const o=1,s=1;if(!n.shiftKey)switch(n.key){case"ArrowLeft":this.#N(e,-o,0),i=!0;break;case"ArrowRight":this.#N(e,o,0),i=!0;break;case"ArrowUp":this.#N(e,0,-o),i=!0;break;case"ArrowDown":this.#N(e,0,o),i=!0;break}if(n.shiftKey)switch(n.key){case"ArrowLeft":this.#W(e,-s,0),i=!0;break;case"ArrowRight":this.#W(e,s,0),i=!0;break;case"ArrowUp":this.#W(e,0,-s),i=!0;break;case"ArrowDown":this.#W(e,0,s),i=!0;break}i&&(n.preventDefault(),t.setAttribute("aria-label",`Grid block ${e.blockId} at position ${e.position.x}, ${e.position.y}, size ${e.position.w} by ${e.position.h}`),this.#j(e,n.shiftKey?"resized":"moved"))})}#N(t,e,n){const i=Math.max(0,t.position.x+e),o=Math.max(0,t.position.y+n);if(i===t.position.x&&o===t.position.y||!this.#w(t.blockId,i,o,t.position.w,t.position.h))return;t.position.x=i,t.position.y=o;const s=this.#o.querySelector(`[data-block-id="${t.blockId}"]`);s&&(s.style.gridColumnStart=i+1,s.style.gridRowStart=o+1);const r=()=>this.#r.gridLayoutViewModel.updatePositions([{blockId:t.blockId,x:i,y:o,w:t.position.w,h:t.position.h}]);typeof this.#t?.transaction=="function"?this.#t.transaction(r):r(),this.#e?.increment("grid.keyboard_move"),this.#$("keyboard_move",t)}#W(t,e,n){const i=t.position.w,o=t.position.h,s=i+e,r=o+n,l=this.#q(t,t.position.x,t.position.y,s,r);if(l.w===i&&l.h===o)return;if(!this.#w(t.blockId,t.position.x,t.position.y,l.w,l.h)){this.#e?.increment("grid.resize_blocked");return}if(t.position.w=l.w,t.position.h=l.h,l.clamped){this.#e?.increment("grid.constraint_clamped");try{this.#s?.getPolicy?.("system","grid_constraint_toast")!==!1&&this.#d?.warning("Block size adjusted to fit constraints",2e3)}catch{}}const a=this.#o.querySelector(`[data-block-id="${t.blockId}"]`);a&&(a.style.gridColumnEnd=t.position.x+t.position.w+1,a.style.gridRowEnd=t.position.y+t.position.h+1);const d=()=>this.#r.gridLayoutViewModel.updatePositions([{blockId:t.blockId,x:t.position.x,y:t.position.y,w:t.position.w,h:t.position.h}]);typeof this.#t?.transaction=="function"?this.#t.transaction(d):d(),this.#e?.increment("grid.keyboard_resize"),this.#$("keyboard_resize",t)}#j(t,e){let n=document.getElementById("grid-live-region");n||(n=document.createElement("div"),n.id="grid-live-region",n.setAttribute("aria-live","polite"),n.className="sr-only",n.style.cssText=`
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      `,document.body.appendChild(n)),n.textContent=`Block ${e} to position ${t.position.x}, ${t.position.y}, size ${t.position.w} by ${t.position.h}`}#Z(t){const e=t.dataset.blockId;return e&&this.getCurrentLayout()?.blocks.find(i=>i.blockId===e)||null}#tt(t,e){t.style.cssText+=`
      width: 16px;
      height: 16px;
      background: linear-gradient(-45deg, transparent 40%, #3498db 40%, #3498db 60%, transparent 60%);
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: se-resize;
      z-index: 10;
    `;const n=t.closest(".grid-block");n.addEventListener("mouseenter",()=>{t.style.opacity="0.7"}),n.addEventListener("mouseleave",()=>{this.#m||(t.style.opacity="0")})}#et(t,e){const n=t.onmousedown,i=o=>{if(!o.target.classList.contains("resize-handle")){this.#a=!0,this.#c={element:t,data:e,orig:{x:e.position.x,y:e.position.y,w:e.position.w,h:e.position.h}},t.style.transform="rotate(1deg)",t.style.boxShadow="0 8px 25px rgba(0,0,0,0.3)",t.style.zIndex="1000",t.style.transition="none",this.#n?.emit("blockDragStart",{blockId:e.blockId,position:e.position});try{this.#y||this.#C()}catch{}n&&n.call(t,o)}};t.addEventListener("mousedown",i)}#nt(){let t=0,e=T.timestamp();const n=()=>{t++;const i=T.timestamp();if(i-e>=1e3){const o=t/((i-e)/1e3);this.#V()===null&&(o<30&&!this.#x?(this.#Y(),this.#n?.emit("gridPerformanceMode",{fps:o,enabled:!0,reason:"auto"})):o>50&&this.#x&&(this.#K(),this.#n?.emit("gridPerformanceMode",{fps:o,enabled:!1,reason:"auto"})),this.#n?.emit("gridFps",{fps:Math.round(o)})),t=0,e=i}(this.#a||this.#m)&&requestAnimationFrame(n)};this.#n&&(this.#p.push(this.#n.on("blockDragStart",()=>requestAnimationFrame(n))),this.#p.push(this.#n.on("blockResizeStart",()=>requestAnimationFrame(n))),this.#p.push(this.#n.on("policyChanged",this.#st.bind(this))))}#it(){try{if(typeof IntersectionObserver>"u"||!this.#o)return;this.#E=new IntersectionObserver(t=>{for(const e of t){const n=e.target;e.isIntersecting?(n.style.visibility="",n.classList.add("in-viewport")):(n.style.visibility="hidden",n.classList.remove("in-viewport"))}try{const e=this.#o.querySelectorAll(".grid-block");let n=0;e.forEach(i=>{i.classList.contains("in-viewport")&&n++}),this.#n?.emit("gridBlockVisibility",{inView:n,total:e.length})}catch{}},{root:this.#o,threshold:0}),this.#o.querySelectorAll(".grid-block").forEach(t=>this.#E.observe(t))}catch{}}#V(){try{const t=this.#s?.getPolicy("system","grid_performance_mode");return t!==null&&t!==this.#x&&(t?this.#Y():this.#K(),this.#n?.emit("gridPerformanceMode",{enabled:t,reason:"policy_override"})),t}catch(t){return this.#i?.handleError(t,{component:"EnhancedGridRenderer",operation:"checkPerformancePolicyOverride",severity:"low"}),null}}#st(t){if(t.domain==="system"&&t.key==="grid_performance_mode"&&this.#V(),t.domain==="grid"&&t.key==="reflow_on_drag_enabled")try{this.#T=!!this.#s?.getPolicy?.("grid","reflow_on_drag_enabled")}catch{}if(t.domain==="grid"&&t.key==="reflow_live_preview")try{this.#_=!!this.#s?.getPolicy?.("grid","reflow_live_preview")}catch{}t.domain==="grid"&&t.key&&t.key.startsWith("nudging")&&this.#D()}#D(){try{const t=this.#t?.managers?.gridPolicyService;if(t&&typeof t.getNudgingConfig=="function"){const a=t.getNudgingConfig();this.#S=a?.enabled??this.#S,this.#g=Number.isFinite(Number(a?.maxRadius))?Math.max(0,Number(a.maxRadius)):this.#g,Array.isArray(a?.prefer)&&a.prefer.length&&(this.#v=a.prefer),this.#F=a?.tooltipEnabled??this.#F,this.#L=Number.isFinite(Number(a?.tooltipDuration))?Math.max(200,Number(a.tooltipDuration)):this.#L,this.#I=a?.powerMode??this.#I,this.#f=Number.isFinite(Number(a?.powerMaxRadius))?Math.max(this.#g,Number(a.powerMaxRadius)):this.#f;return}const e=this.#s?.getPolicy?.("grid","nudging_enabled");this.#S=e!==!1;const n=parseInt(this.#s?.getPolicy?.("grid","nudging_max_radius")??this.#g,10);this.#g=Number.isFinite(n)?Math.max(0,n):this.#g;const i=this.#s?.getPolicy?.("grid","nudging_prefer");Array.isArray(i)&&i.length&&(this.#v=i);const o=this.#s?.getPolicy?.("grid","nudging_tooltip_enabled");this.#F=o!==!1;const s=parseInt(this.#s?.getPolicy?.("grid","nudging_tooltip_duration")??this.#L,10);this.#L=Number.isFinite(s)?Math.max(200,s):this.#L;const r=this.#s?.getPolicy?.("grid","nudging_power_mode");this.#I=r===!0;const l=parseInt(this.#s?.getPolicy?.("grid","nudging_power_max_radius")??this.#f,10);this.#f=Number.isFinite(l)?Math.max(this.#g,l):this.#f}catch{}}#Y(){this.#x||(this.#o.classList.add("performance-mode"),this.#x=!0,this.#e?.increment("performance_mode.toggled",{status:"on"}))}#K(){this.#x&&(this.#o.classList.remove("performance-mode"),this.#x=!1,this.#e?.increment("performance_mode.toggled",{status:"off"}))}#ot(){document.addEventListener("mousemove",this.#rt.bind(this)),document.addEventListener("mouseup",this.#ct.bind(this)),this.#n&&(this.#p.push(this.#n.on("gridRendered",this.#gt.bind(this))),this.#p.push(this.#n.on("blockAdded",this.#yt.bind(this))),this.#p.push(this.#n.on("blockRemoved",this.#mt.bind(this))))}#rt(t){!this.#a&&!this.#m||(this.#k=t,!this.#z&&(this.#z=!0,requestAnimationFrame(()=>{this.#z=!1;const e=this.#k;this.#k=null,e&&this.#a&&this.#c&&this.#at(e)})))}#at(t){const e=this.#o.getBoundingClientRect(),n=t.clientX-e.left,i=t.clientY-e.top,{element:o,data:s}=this.#c,r=this.#X(n,i,s),l=this.#q(s,r.x,r.y,r.w,r.h);let a={x:l.x,y:l.y,w:l.w,h:l.h},d=!1;if(!this.#w(s.blockId,a.x,a.y,a.w,a.h)){const h=this.#J(s.blockId,a.x,a.y,a.w,a.h,this.#I?this.#f:this.#g);h&&(a=h,d=!0)}const g=this.#w(s.blockId,a.x,a.y,a.w,a.h);if(l.clamped){this.#e?.increment("grid.constraint_clamped");try{this.#s?.getPolicy?.("system","grid_constraint_toast")!==!1&&this.#d?.warning("Block size or position adjusted to fit constraints",2e3)}catch{}}if(g){o.classList.contains("blocked")&&(o.classList.remove("blocked"),this.#n?.emit("gridBlockUnblocked",{blockId:s.blockId,x:a.x,y:a.y})),o.style.gridColumnStart=a.x+1,o.style.gridRowStart=a.y+1,this.#c.preview={x:a.x,y:a.y,w:a.w,h:a.h};try{this.#_&&this.#ht(s.blockId,a.x,a.y,a.w,a.h)}catch{}if(d){this.#e?.increment("grid.nudged"),this.#n?.emit("gridBlockNudged",{blockId:s.blockId,x:a.x,y:a.y});try{o.classList.add("nudged"),setTimeout(()=>{try{o.classList.remove("nudged")}catch{}},1200);try{this.#j({...s,position:{x:a.x,y:a.y,w:a.w,h:a.h}},"nudged")}catch{}}catch{}}}else if(!o.classList.contains("blocked")){o.classList.add("blocked"),this.#e?.increment("grid.blocked"),this.#n?.emit("gridBlockBlocked",{blockId:s.blockId,x:a.x,y:a.y,reason:"collision_or_constraint"});try{this.#s?.getPolicy?.("system","grid_block_toast")!==!1&&this.#d?.warning("Cannot move block: space occupied or violates constraints",2e3)}catch{}}}#ct(t){this.#a&&this.#lt(t),this.#m&&this.#pt(t)}#lt(t){if(!this.#c)return;const{element:e,data:n}=this.#c;e.style.transform="",e.style.boxShadow="",e.style.zIndex="",e.style.transition="";const i=this.#c.preview||n.position;!this.#w(n.blockId,i.x,i.y,i.w,i.h)&&this.#c?.orig&&(e.style.gridColumnStart=this.#c.orig.x+1,e.style.gridRowStart=this.#c.orig.y+1,this.#c.preview=null);const o=[{blockId:n.blockId,x:i.x,y:i.y,w:i.w,h:i.h}],s=()=>{try{typeof S?.createEnvelope=="function"&&S.createEnvelope({actorId:this.#t?.managers?.securityManager?.getSubject?.()?.userId||"system",action:"grid.drag",target:n.blockId,label:"ui.grid.layout",payload:{updates:o}}).catch(()=>{})}catch{}try{const l=this.getCurrentLayout(),a=l?JSON.parse(JSON.stringify(l)):null;if(a&&a.blocks){const g=a.blocks.find(h=>h.blockId===n.blockId);g&&(g.position={x:this.#c.orig.x,y:this.#c.orig.y,w:this.#c.orig.w,h:this.#c.orig.h})}if(typeof this.#t?.transaction=="function")this.#t.transaction(()=>{this.#r.gridLayoutViewModel.updatePositions(o);try{this.#t?.managers?.forensicLogger?.logAuditEvent?.("GRID_LAYOUT_CHANGED",{updates:o},{securitySubject:this.#t?.managers?.securityManager?.getSubject?.()})}catch{}});else{this.#r.gridLayoutViewModel.updatePositions(o);try{this.#t?.managers?.forensicLogger?.logAuditEvent?.("GRID_LAYOUT_CHANGED",{updates:o},{securitySubject:this.#t?.managers?.securityManager?.getSubject?.()})}catch{}}const d=this.getCurrentLayout();try{const g={type:"layout_change",changeType:"drag",blockId:n.blockId,position:{...this.#c.preview||n.position},timestamp:T.timestamp(),userId:this.#r?.getCurrentUser?.()?.id};this.#n?.emit("layoutChanged",g),this.#h?.onLayoutChange&&this.#h.onLayoutChange(g)}catch{}try{typeof this.#t?.recordOperationWithSnapshots=="function"?this.#t.recordOperationWithSnapshots({type:"grid_layout_change",before:a,after:d,meta:{source:"drag",updates:o}}):this.#t?.recordOperation?.({type:"grid_layout_change",data:{source:"drag",updates:o}})}catch{}}catch{}};try{this.#_&&this.#ut()}catch{}const r=typeof this.#t?.transaction=="function";r?this.#t.transaction(s):s();try{this.#C()}catch{}try{this.#T&&this.#dt(n.blockId)}catch{}if(this.#n?.emit("blockDragEnd",{blockId:n.blockId,position:n.position}),this.#e?.increment("grid.drag"),!r)try{this.#$("drag",{blockId:n.blockId,position:i}),this.#c.preview=null}catch{}this.#a=!1,this.#c=null}#dt(t){if(String(this.#s?.getPolicy?.("grid","reflow_strategy")||"push_down")!=="push_down")return;const n=this.#O().map(a=>({blockId:a.blockId,x:a.position?.x??a.x,y:a.position?.y??a.y,w:a.position?.w??a.w,h:a.position?.h??a.h}));if(!new Map(n.map(a=>[a.blockId,a])).get(t))return;let s=!0,r=0;for(;s&&r++<100;){s=!1;for(const a of n)for(const d of n){if(a.blockId===d.blockId)continue;const g=a.x<d.x+d.w&&a.x+a.w>d.x,h=a.y<d.y+d.h&&a.y+a.h>d.y;if(g&&h){const c=a.blockId===t?d:a,u=c===a?d:a,y=u.y+u.h;c.y<y&&(c.y=y,s=!0)}}}const l=[];for(const a of n){const d=this.#O().find(c=>c.blockId===a.blockId),g=d?.position?.x??d?.x,h=d?.position?.y??d?.y;if(g!==a.x||h!==a.y){l.push({blockId:a.blockId,x:a.x,y:a.y,w:a.w,h:a.h});const c=this.#o.querySelector(`[data-block-id="${a.blockId}"]`);c&&(c.style.gridColumnStart=a.x+1,c.style.gridRowStart=a.y+1)}}l.length&&(this.#t?.transaction?.(()=>{this.#r?.gridLayoutViewModel?.updatePositions(l)}),this.#n?.emit("gridReflow",{movedId:t,updates:l}))}#ht(t,e,n,i,o){if(String(this.#s?.getPolicy?.("grid","reflow_strategy")||"push_down")!=="push_down")return;const r=this.#O(),l=r.map(c=>({blockId:c.blockId,x:c.position?.x??c.x,y:c.position?.y??c.y,w:c.position?.w??c.w,h:c.position?.h??c.h})),d=new Map(l.map(c=>[c.blockId,c])).get(t);if(!d)return;d.x=e,d.y=n,d.w=i,d.h=o;let g=!0,h=0;for(;g&&h++<100;){g=!1;for(const c of l)for(const u of l){if(c.blockId===u.blockId)continue;const y=c.x<u.x+u.w&&c.x+c.w>u.x,m=c.y<u.y+u.h&&c.y+c.h>u.y;if(y&&m){const f=c.blockId===t?u:c,w=f===c?u:c,b=w.y+w.h;f.y<b&&(f.y=b,g=!0)}}}for(const c of l){if(c.blockId===t)continue;const u=r.find(f=>f.blockId===c.blockId),y=u?.position?.x??u?.x,m=u?.position?.y??u?.y;if(y!==c.x||m!==c.y){this.#M.has(c.blockId)||this.#M.set(c.blockId,{x:y,y:m});const f=this.#o.querySelector(`[data-block-id="${c.blockId}"]`);f&&(f.style.gridColumnStart=c.x+1,f.style.gridRowStart=c.y+1)}}}#ut(){if(this.#M.size){for(const[t,e]of this.#M.entries()){const n=this.#o.querySelector(`[data-block-id="${t}"]`);n&&(n.style.gridColumnStart=(e.x??0)+1,n.style.gridRowStart=(e.y??0)+1)}this.#M.clear()}}#pt(t){if(this.resizeItem){const e=this.resizeItem,n=this.#q(e,e.position.x,e.position.y,e.position.w,e.position.h);if(n.clamped){e.position.x=n.x,e.position.y=n.y,e.position.w=n.w,e.position.h=n.h,this.#e?.increment("grid.constraint_clamped");try{this.#s?.getPolicy?.("system","grid_constraint_toast")!==!1&&this.#d?.warning("Block size adjusted to fit constraints",2e3)}catch{}}if(this.#w(e.blockId,e.position.x,e.position.y,e.position.w,e.position.h)){const i=()=>this.#r.gridLayoutViewModel.updatePositions([{blockId:e.blockId,x:e.position.x,y:e.position.y,w:e.position.w,h:e.position.h}]);typeof this.#t?.transaction=="function"?this.#t.transaction(i):i()}else if(this.resizeItem?.orig){const i=this.resizeItem.orig;e.position.x=i.x,e.position.y=i.y,e.position.w=i.w,e.position.h=i.h;const o=this.#o.querySelector(`[data-block-id="${e.blockId}"]`);o&&(o.style.gridColumnStart=e.position.x+1,o.style.gridRowStart=e.position.y+1,o.style.gridColumnEnd=e.position.x+e.position.w+1,o.style.gridRowEnd=e.position.y+e.position.h+1),this.#e?.increment("grid.resize_reverted");try{this.#d?.warning("Resize reverted due to collision",2500)}catch{}}else{this.#e?.increment("grid.resize_blocked");try{this.#d?.warning("Cannot resize: space occupied",2500)}catch{}}try{this.#C()}catch{}this.#e?.increment("grid.resize"),this.#$("resize",e)}this.#n?.emit("blockResizeEnd",{}),this.#m=!1}#$(t,e){try{const n={type:"layout_change",changeType:t,blockId:e.blockId,position:{...e.position},timestamp:T.timestamp(),userId:this.#r?.getCurrentUser?.()?.id};this.#n?.emit("layoutChanged",n);try{this.#t?.emit?.("layoutChanged",n)}catch{}let i=null;try{i=typeof this.getCurrentLayout=="function"?this.getCurrentLayout():null}catch{i=null}try{i?(this.#t?.set?.("grid.layout",i),this.#t?.set?.("grid.lastChange",n),this.#t?.emit?.("grid:layoutChange",{change:n,layout:i})):(this.#t?.emit?.("grid:layoutChange",n),this.#t?.set?.("grid.lastChange",n))}catch{}this.#h?.onLayoutChange&&this.#h.onLayoutChange(n),this.#t?.recordOperation({type:"grid_layout_change",data:n})}catch(n){this.#e?.increment("layout_persistence.failed"),this.#i?.handleError(n,{component:"EnhancedGridRenderer",operation:"triggerLayoutPersistence",userFriendlyMessage:"Could not save layout change.",showToUser:!1})}}#gt(t){t.forEach(e=>{const n=this.#o.querySelector(`[data-block-id="${e.blockId}"]`);n&&!n.classList.contains("enhanced-grid-block")&&this.#A(n)});try{this.#C()}catch{}}#yt(t){setTimeout(()=>{const e=this.#o.querySelector(`[data-block-id="${t.blockId}"]`);e&&this.#A(e);try{this.#C()}catch{}},0)}#mt(t){this.#c?.data.blockId===t.blockId&&(this.#a=!1,this.#c=null);try{this.#C()}catch{}}refresh(){this.#e?.increment("grid.refreshed"),this.#H()}enhance(){this.#l||this.initialize({container:this.#o,appViewModel:this.#r,options:this.#h})}disable(){if(!this.#l)return;this.#o.style.display="",this.#o.classList.remove("performance-mode"),this.#o.querySelectorAll(".enhanced-grid-block").forEach(e=>{e.classList.remove("enhanced-grid-block"),e.style.gridColumnStart="",e.style.gridRowStart="",e.style.gridColumnEnd="",e.style.gridRowEnd=""}),this.#l=!1,this.#n?.emit("gridEnhancementDisabled")}getCurrentLayout(){try{const t=this.#r?.gridLayoutViewModel.getCurrentLayout?.();return t?JSON.parse(JSON.stringify(t)):null}catch{return null}}canPlaceDebug(t,e,n,i,o){try{return this.#y||this.#C(),this.#w(t,e,n,i,o)}catch{return!1}}getOccupancyMap(){return this.#y?this.#y.map(t=>t.slice()):null}updateBlockPosition(t,e,n,i,o){try{typeof S?.createEnvelope=="function"&&S.createEnvelope({actorId:this.#t?.managers?.securityManager?.getSubject?.()?.userId||"system",action:"grid.programmatic_update",target:t,label:"ui.grid.update",payload:{x:e,y:n,w:i,h:o}}).catch(()=>{})}catch{}const s=[{blockId:t,x:e,y:n,w:i,h:o}];try{if(this.#t?._isApplyingHistory){this.#r?.gridLayoutViewModel.updatePositions(s);return}if(typeof this.#t?.transaction=="function")this.#t.transaction(()=>{this.#r?.gridLayoutViewModel.updatePositions(s);try{this.#t?.managers?.forensicLogger?.logAuditEvent?.("GRID_LAYOUT_CHANGED",{updates:s},{securitySubject:this.#t?.managers?.securityManager?.getSubject?.()})}catch{}try{this.#t?.recordOperation?.({type:"grid_layout_change",data:{source:"programmatic",updates:s}})}catch{}});else{this.#r?.gridLayoutViewModel.updatePositions(s);try{this.#t?.managers?.forensicLogger?.logAuditEvent?.("GRID_LAYOUT_CHANGED",{updates:s},{securitySubject:this.#t?.managers?.securityManager?.getSubject?.()})}catch{}try{this.#$("programmatic",{blockId:t,position:{x:e,y:n,w:i,h:o}})}catch{}try{this.#t?.recordOperation?.({type:"grid_layout_change",data:{source:"programmatic",updates:s}})}catch{}}}catch(r){try{this.#i?.handleError(r,{component:"EnhancedGridRenderer",operation:"updateBlockPosition"})}catch{}}}#ft(t,e){try{const n=String(this.#s?.getPolicy?.("grid","expand_mode")||"reflow").toLowerCase();return this.#b&&this.#b.blockId===e.blockId?this.#wt(t,e,n):this.#bt(t,e,n)}catch{}}#bt(t,e,n){return n==="overlay"?this.#xt(t):this.#kt(t,e)}#wt(t,e,n){return n==="overlay"?this.#vt(t):this.#Ct(t,e)}#xt(t){t.classList.add("expanded-overlay");const e=t.dataset.blockId;this.#b={blockId:e,snapshot:null},this.#n?.emit("blockExpanded",{blockId:e,mode:"overlay"})}#vt(t){t.classList.remove("expanded-overlay");const e=t.dataset.blockId;this.#b=null,this.#n?.emit("blockCollapsed",{blockId:e,mode:"overlay"})}#kt(t,e){const n=this.#s?.getPolicy?.("grid","expand_target_full_width")??!0,i=this.#s?.getPolicy?.("grid","expand_target_rows")??8,o={x:e.position.x,y:e.position.y,w:e.position.w,h:e.position.h},s=n?this.#u:o.w,r=Math.max(o.h,i),l=r-o.h,a=o.x,d=o.x+s,g=this.getCurrentLayout(),h=[];h.push({blockId:e.blockId,x:o.x,y:o.y,w:s,h:r});for(const c of g?.blocks||[]){if(c.blockId===e.blockId)continue;const u=c.position?.x??c.x,y=c.position?.y??c.y,m=c.position?.w??c.w,f=c.position?.h??c.h;u<d&&u+m>a&&y>=o.y&&h.push({blockId:c.blockId,x:u,y:y+l,w:m,h:f})}this.#t?.transaction?.(()=>{this.#r?.gridLayoutViewModel?.updatePositions(h)}),this.#b={blockId:e.blockId,snapshot:o},t.classList.add("expanded"),this.#n?.emit("blockExpanded",{blockId:e.blockId,mode:"reflow"})}#Ct(t,e){if(!this.#b?.snapshot)return;const n=this.#b.snapshot,i={x:e.position.x,y:e.position.y,w:e.position.w,h:e.position.h},o=i.h-n.h,s=n.x,r=n.x+i.w,l=this.getCurrentLayout(),a=[];a.push({blockId:e.blockId,x:n.x,y:n.y,w:n.w,h:n.h});for(const d of l?.blocks||[]){if(d.blockId===e.blockId)continue;const g=d.position?.x??d.x,h=d.position?.y??d.y,c=d.position?.w??d.w,u=d.position?.h??d.h;g<r&&g+c>s&&h>n.y&&a.push({blockId:d.blockId,x:g,y:Math.max(n.y+n.h,h-o),w:c,h:u})}this.#t?.transaction?.(()=>{this.#r?.gridLayoutViewModel?.updatePositions(a)}),t.classList.remove("expanded"),this.#n?.emit("blockCollapsed",{blockId:e.blockId,mode:"reflow"}),this.#b=null}#O(){try{const t=this.getCurrentLayout();return Array.isArray(t?.blocks)?t.blocks:[]}catch{return[]}}#C(){try{const t=this.#O(),e=this.#u||24;let n=0;for(const s of t){const r=s.position?.y??s.y??0,l=s.position?.h??s.h??1;n=Math.max(n,r+l)}const i=Math.max(1,n),o=Array.from({length:i},()=>Array.from({length:e},()=>null));for(const s of t){const r=s.blockId;if(!r)continue;const l=s.position?.x??s.x??0,a=s.position?.y??s.y??0,d=s.position?.w??s.w??1,g=s.position?.h??s.h??1;for(let h=a;h<a+g;h++)if(!(h<0||h>=i))for(let c=l;c<l+d;c++)c<0||c>=e||(o[h][c]=r)}this.#y=o,this.#R=i}catch{this.#y=null,this.#R=0}}#St(t,e,n,i,o){if(!this.#y)return!1;const s=this.#u||24;if(e<0||n<0||e+i>s)return!0;for(let r=n;r<n+o;r++){if(r>=this.#R)continue;const l=this.#y[r];for(let a=e;a<e+i;a++){if(a<0||a>=s)return!0;const d=l[a];if(d&&d!==t)return!0}}return!1}#It(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}#q(t,e,n,i,o){const s=t?.constraints||{minW:1,minH:1,maxW:this.#u,maxH:1e3},r=Math.max(s.minW,Math.min(s.maxW,i)),l=Math.max(s.minH,Math.min(s.maxH,o));let a=Number.isFinite(e)?e:0;const d=Math.max(0,Number.isFinite(n)?n:0);return a+r>this.#u&&(a=Math.max(0,this.#u-r)),{x:a,y:d,w:r,h:l,clamped:r!==i||l!==o||a!==e||d!==n}}#w(t,e,n,i,o){if(e<0||n<0||e+i>this.#u)return!1;if(!this.#y)try{this.#C()}catch{}if(this.#y)return!this.#St(t,e,n,i,o);const s={x:e,y:n,w:i,h:o},r=this.#O();for(const l of r){if(l.blockId===t)continue;const a={x:l.position?.x??l.x,y:l.position?.y??l.y,w:l.position?.w??l.w,h:l.position?.h??l.h};if(this.#It(s,a))return!1}return!0}#X(t,e,n){const i=this.#Q(),o=i.cols||this.#u||24,s=i.cellWidth||1,r=i.cellHeight||1,l=Math.max(0,Math.round(t/s)),a=Math.max(0,Math.round(e/r)),d=n?.position?.w??n?.w??1,g=n?.position?.h??n?.h??1,h=Math.max(0,Math.min(o-d,l)),c=Math.max(0,a);return{x:h,y:c,w:d,h:g}}#J(t,e,n,i,o,s){if(!this.#S)return null;const r=Number.isFinite(this.#g)?this.#g:3,l=Number.isFinite(s)?s:this.#I?this.#f:r;if(this.#w(t,e,n,i,o))return{x:e,y:n,w:i,h:o};const a=this.#u||24;for(let d=1;d<=l;d++)for(let g=-d;g<=d;g++)for(let h=-d;h<=d;h++){if(Math.abs(h)+Math.abs(g)!==d)continue;const c=e+h,u=Math.max(0,n+g);if(!(c<0||c+i>a)&&this.#w(t,c,u,i,o))return{x:c,y:u,w:i,h:o}}return null}snapToCellsDebug(t,e,n){try{const i=this.#O().find(l=>l.blockId===n)||{position:{w:1,h:1}},o=this.#X(t,e,i),s=this.#q(i,o.x,o.y,o.w,o.h);let r={x:s.x,y:s.y,w:s.w,h:s.h};if(!this.#w(n,r.x,r.y,r.w,r.h)){const l=this.#J(n,r.x,r.y,r.w,r.h,this.#I?this.#f:this.#g);l&&(r=l)}return{...r,clamped:s.clamped}}catch{return null}}#Q(){try{const t=this.#u||24,e=window.getComputedStyle?window.getComputedStyle(this.#o):null,n=this.#o?.clientWidth||this.#o?.getBoundingClientRect&&this.#o.getBoundingClientRect().width||0,i=e?e.getPropertyValue("grid-auto-rows"):null,o=e?e.getPropertyValue("gap")||e.getPropertyValue("grid-gap"):null;let s=60,r=16;if(i){const d=i.match(/(\d+(?:\.\d+)?)px/);d&&(s=parseFloat(d[1]))}if(o){const d=o.match(/(\d+(?:\.\d+)?)px/);d&&(r=parseFloat(d[1]))}const l=t>0?n/t:0,a=s+r;return{cellWidth:l,cellHeight:a,cols:t,gap:r}}catch{return{cellWidth:0,cellHeight:0,cols:this.#u||24,gap:0}}}getCellMetrics(){return this.#Q()}destroy(){this.disable(),this.#p.forEach(t=>t()),this.#p=[];try{this.#E&&typeof this.#E.disconnect=="function"&&this.#E.disconnect()}catch{}this.#E=null,this.#y=null,this.#R=0;try{typeof this.#P=="function"&&this.#P()}catch{}try{this.#t?.managers?.enhancedGridRenderer===this&&delete this.#t.managers.enhancedGridRenderer}catch{}}}const X=`
.enhanced-grid-block {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  will-change: transform;
}
.enhanced-grid-block.expandable { cursor: zoom-in; }
.enhanced-grid-block.expanded { cursor: zoom-out; }
.enhanced-grid-block.expanded-overlay {
  position: absolute !important;
  top: 0; left: 0; right: 0;
  z-index: 2000;
  width: 100% !important;
  height: auto;
  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
}
.enhanced-grid-block.blocked { outline: 2px solid #dc3545; }

.enhanced-grid-block.nudged { outline: 2px dashed #ffc107; box-shadow: 0 0 0 6px rgba(255,193,7,0.08); }

.enhanced-grid-block:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.enhanced-grid-block:focus {
  outline: 3px solid #007cba;
  outline-offset: 2px;
}

.enhanced-grid-block:focus:not(:focus-visible) {
  outline: none;
}

.performance-mode .enhanced-grid-block {
  transition: none;
  will-change: auto;
}

.performance-mode .enhanced-grid-block:hover {
  transform: none;
  box-shadow: none;
}

/* Screen reader only content */
.sr-only {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border: 0 !important;
}

/* Responsive adjustments that work with existing breakpoints */
@media (max-width: 768px) {
  .enhanced-grid-block .resize-handle {
    width: 20px;
    height: 20px;
    opacity: 0.7;
  }

  /* Larger touch targets for accessibility */
  .enhanced-grid-block:focus {
    outline-width: 4px;
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  .enhanced-grid-block:focus {
    outline: 4px solid currentColor;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  .enhanced-grid-block {
    transition: none;
  }

  .enhanced-grid-block:hover {
    transform: none;
  }
}
`;if(typeof document<"u"){const p="enhanced-grid-styles";if(!document.getElementById(p)){const t=document.createElement("style");t.id=p,t.textContent=X,document.head.appendChild(t)}}function B(p={}){const t=typeof p=="object"&&p?{...p}:{};t.columns=Number.isFinite(t.columns)&&t.columns>0?Math.floor(t.columns):24,t.gap=Number.isFinite(t.gap)&&t.gap>=0?t.gap:16,t.blocks=Array.isArray(t.blocks)?t.blocks:[];const e=i=>{const o=[];for(const s of i||[]){const r=String(s?.id||s?.blockId||"").trim();if(!r)continue;const l=E(s?.x??s?.position?.x??0,0),a=E(s?.y??s?.position?.y??0,0),d=E(s?.w??s?.position?.w??1,1),g=E(s?.h??s?.position?.h??1,1),h=String(s?.type||"html"),c=typeof s?.props=="object"&&s?.props?s.props:{},u={minW:E(s?.constraints?.minW??1,1),minH:E(s?.constraints?.minH??1,1),maxW:E(s?.constraints?.maxW??t.columns,1),maxH:E(s?.constraints?.maxH??1e3,1)},y=Math.min(Math.max(d,u.minW),u.maxW),m=Math.min(Math.max(g,u.minH),u.maxH);l+y>t.columns||o.push({id:r,x:l,y:a,w:y,h:m,type:h,props:c,constraints:u})}return o};t.blocks=e(t.blocks);const n=typeof p.templates=="object"&&p.templates?p.templates:null;if(n){const i={};for(const[o,s]of Object.entries(n)){const r=typeof s=="object"&&s?s:{};i[o]={blocks:e(r.blocks||[])}}t.templates=i}return t}function E(p,t){const e=Number.isFinite(p)?Math.floor(p):t;return e<t?t:e}class U{#t;constructor({stateManager:t}){this.#t=t}async save(t,e,n){S.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});const i=this.#t?.storage?.instance;if(!i)throw new Error("Storage instance not available");const o=this.#i("grid_layout",t,n);await i.put("system_settings",{id:o,layout:e,updatedAt:new Date().toISOString()})}async load(t,e){const n=this.#t?.storage?.instance;if(!n)throw new Error("Storage instance not available");const i=this.#i("grid_layout",t,e);return(await n.get("system_settings",i))?.layout||null}async saveConfig(t,e,n){S.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});const i=this.#t?.storage?.instance;if(!i)throw new Error("Storage instance not available");const o=this.#i("grid_config",t,n);await i.put("system_settings",{id:o,config:e,updatedAt:new Date().toISOString()})}async loadConfig(t,e){const n=this.#t?.storage?.instance;if(!n)throw new Error("Storage instance not available");const i=this.#i("grid_config",t,e);return(await n.get("system_settings",i))?.config||null}#i(t,e,n){const i=n?.tenantId||this.#t?.managers?.securityManager?.getSubject?.()?.tenantId||"public",o=n?.userId||this.#t?.managers?.securityManager?.getSubject?.()?.userId||"anon";return`${t}:${i}:${o}:${e}`}}class J{#t=new Map;#i=new Set(["text","html"]);setAllowedTypes(t){Array.isArray(t)&&(this.#i=new Set(t.map(String)))}register(t,{mount:e,unmount:n}){!t||typeof e!="function"||this.#t.set(t,{mount:e,unmount:n})}async mount(t,e,n={},i={}){if(!this.#i.has(t))return e.textContent="[blocked component]",()=>{e.textContent=""};const o=this.#t.get(t);if(!o)return e.textContent=n?.text??"",()=>{e.textContent=""};const s=await o.mount(e,n,i);return typeof s=="function"?s:()=>{try{o.unmount?.(e)}catch{}}}}const I=new J;I.register("text",{mount(p,t){return p.textContent=t?.value??t?.text??"",()=>{p.textContent=""}}});I.register("html",{mount(p,t){const e=String(t?.html??""),n=document.createElement("div");return n.textContent=e,n.querySelectorAll("script").forEach(i=>i.remove()),n.querySelectorAll("*").forEach(i=>{[...i.attributes].forEach(o=>{const s=o.name,r=String(o.value||"").trim();if(/^on/i.test(s)){i.removeAttribute(s);return}if(s.toLowerCase()==="style"){i.removeAttribute(s);return}if(["href","src","xlink:href"].includes(s.toLowerCase())){const l=r.toLowerCase();(l.startsWith("javascript:")||l.startsWith("data:"))&&i.removeAttribute(s)}})}),p.replaceChildren(...n.childNodes),()=>{p.replaceChildren()}}});I.register("block",{mount(p,t={}){const e=t.title??"Block",n=t.body??"Configure me";p.classList.add("cfg-block");const i=document.createElement("div");i.className="cfg-block-card",i.style.cssText="border:1px solid #e1e4e8;border-radius:8px;padding:12px;background:#fff;min-height:60px;";const o=document.createElement("div");o.className="cfg-block-title",o.style.fontWeight="600",o.style.marginBottom="6px",o.textContent=e;const s=document.createElement("div");return s.className="cfg-block-body",s.style.opacity="0.85",s.textContent=n,i.appendChild(o),i.appendChild(s),p.replaceChildren(i),()=>{p.replaceChildren(),p.classList.remove("cfg-block")}}});I.register("button",{mount(p,t={},e={}){const n=e.stateManager,i=t.label??"Add",o=String(t.mode||"modal"),s=String(t.variant||"primary"),r=document.createElement("button");r.type="button",r.className=`ui-btn ui-btn-${s}`,r.textContent=i,r.style.cssText=`
      display:inline-block; border:0; border-radius:6px; padding:10px 14px;
      background:#2b7cff; color:#fff; font-weight:600; cursor:pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.12);
    `;const l=a=>{try{n?.emit?.("gridAddBlockRequested",{mode:o,source:"button",context:e})}catch{}};return r.addEventListener("click",l),p.replaceChildren(r),()=>{try{r.removeEventListener("click",l)}catch{}p.replaceChildren()}}});I.register("grid",{async mount(p,t={},e={}){const n=e.stateManager,i=document.createElement("div");i.className="grid-container nested-grid-container",p.appendChild(i);const s=`${String(e.parentConfigId||"default")}:${String(e.blockId||t.id||"grid")}`,r=(()=>{try{const u=n?.managers?.policies,y=n?.managers?.securityManager?.getSubject?.()||{},m=String(u?.getPolicy("system","grid_auto_save_layout_scope")||"tenant").toLowerCase();return m==="user"?{tenantId:y.tenantId,userId:y.userId}:m==="tenant"?{tenantId:y.tenantId,userId:"tenant"}:{tenantId:"global",userId:"global"}}catch{return{tenantId:"public",userId:"anon"}}})(),l=new U({stateManager:n});let a=t?.config||{};try{const u=await l.loadConfig(s,r);u&&(a=u)}catch{}const d=B(a),h={_layout:{blocks:d.blocks.map(u=>({blockId:u.id,position:{x:u.x,y:u.y,w:u.w,h:u.h}}))},getCurrentLayout(){return this._layout},updatePositions(u){S.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});const y=new Map(this._layout.blocks.map(m=>[m.blockId,m]));for(const m of u||[]){const f=y.get(m.blockId);f&&(f.position.x=m.x,f.position.y=m.y,f.position.w=m.w,f.position.h=m.h)}this._layout.blocks=this._layout.blocks.map(m=>y.get(m.blockId)||m)}},c=new K(n);await c.initialize({container:i,appViewModel:{gridLayoutViewModel:h},options:{onLayoutChange:async()=>{try{const u=c.getCurrentLayout?.();u&&await l.save(s,u,r)}catch{}}}});for(const u of d.blocks){const y=document.createElement("div");y.className="grid-block",y.dataset.blockId=u.id,y.dataset.minW=String(u.constraints.minW),y.dataset.minH=String(u.constraints.minH),y.dataset.maxW=String(u.constraints.maxW),y.dataset.maxH=String(u.constraints.maxH);const m=document.createElement("div");m.className="grid-block-content",y.appendChild(m),i.appendChild(y);try{await I.mount(u.type,m,u.props||{},{...e,parentConfigId:s})}catch{}}try{await l.saveConfig(s,d,r)}catch{}try{const u=await l.load(s,r);if(u?.blocks&&Array.isArray(u.blocks))for(const y of u.blocks){const m={blockId:y.blockId,x:y.position?.x??y.x,y:y.position?.y??y.y,w:y.position?.w??y.w,h:y.position?.h??y.h};c.updateBlockPosition?.(m.blockId,m.x,m.y,m.w,m.h)}}catch{}return()=>{try{c.destroy?.()}catch{}p.replaceChildren()}}});const H="async.operation",F="ASYNC_OPERATION",Q="system",Z="shared",tt="async",et=["beforeRun","onSuccess","onError","onSkip","afterRun"],A=Object.freeze({PENDING:"pending",SUCCESS:"success",ERROR:"error",SKIPPED:"skipped"});function nt(p){const t=p;if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID();const e=Math.random().toString(16).slice(2,10);return`${tt}-${t}-${Date.now()}-${e}`}function it(){return typeof globalThis<"u"&&globalThis.performance&&typeof globalThis.performance.now=="function"?globalThis.performance.now():Date.now()}function st(p){if(!p)return{level:F,compartments:new Set};if(typeof p=="string")return{level:p,compartments:new Set};const t=typeof p.level=="string"&&p.level.length>0?p.level:F,e=new Set;if(p.compartments&&Symbol.iterator in Object(p.compartments))for(const n of p.compartments)typeof n=="string"&&n.length>0&&e.add(n);return{level:t,compartments:e}}function ot(p){return!p||typeof p!="object"?{}:{...p}}function rt(p){const t=p?.stateManager;if(!t)return null;const e=t.managers;return e?.sanitizer?e.sanitizer:t.sanitizer?t.sanitizer:null}function R(p,t,e){if(!t?.cleanse)return p;if(p!==void 0)try{return e?t.cleanse(p,e):t.cleanse(p)}catch(n){console.warn("[AsyncOrchestrator] Sanitizer cleanse failed; retrying with no schema.",n);try{return t.cleanse(p)}catch{return p}}}function at(p){if(!p||typeof p!="object")return p;const t=rt(p);if(!t)return p;const e={...p};if("payload"in p){const n=R(p.payload,t,p.payloadSchema);n!==void 0&&(e.payload=n)}if(p.meta!==void 0){const n=R(p.meta,t,p.metaSchema);n!==void 0&&(e.meta=n)}if(p.policyOverrides!==void 0){const n=R(p.policyOverrides,t,p.policySchema);n!==void 0&&(e.policyOverrides=n)}if(p.actorId!==void 0){const n=R(p.actorId,t);n!==void 0&&(e.actorId=n)}if(p.tenantId!==void 0){const n=R(p.tenantId,t);n!==void 0&&(e.tenantId=n)}return e}function ct(p,t,e){const n=new Map;let i=!1,o;const s=st(t.classification),r=ot(t.meta),l=e(),a={id:t.id||nt(t.label||H),label:t.label||H,eventType:t.eventType||F,meta:r,classification:s,actorId:t.actorId||Q,tenantId:t.tenantId||Z,startTime:l,endTime:null,status:A.PENDING,error:null,orchestrator:p,options:t,get result(){return o},set result(d){o=d},attach(d,g){n.set(d,g)},getAttachment(d){return n.get(d)},deleteAttachment(d){n.delete(d)},skip(d){i=!0,d!==void 0&&(o=d),a.status=A.SKIPPED},isSkipped(){return i}};return Object.defineProperty(a,"durationMs",{enumerable:!0,get(){return(a.endTime??e())-a.startTime}}),a}class x{static#t=null;#i=[];#e;#s;constructor(t={}){if(this.#e=t.logger||console,this.#s=typeof t.now=="function"?t.now:it,Array.isArray(t.plugins))for(const e of t.plugins)this.registerPlugin(e);t.registerGlobal&&x.registerGlobal(this)}registerPlugin(t){if(!t||typeof t.name!="string")throw new Error("AsyncOrchestrator plugin must define a name.");return this.#i.some(e=>e.name===t.name)?(this.#e?.warn?.(`[AsyncOrchestrator] Plugin '${t.name}' already registered. Skipping duplicate.`),()=>this.unregisterPlugin(t.name)):(this.#i.push(t),this.#n(),()=>this.unregisterPlugin(t.name))}unregisterPlugin(t){this.#i=this.#i.filter(e=>e.name!==t)}clearPlugins(){this.#i.length=0}async run(t,e={}){const n=typeof t=="function"?t:()=>t,i=at(e),o=this.#d(i.plugins),s=ct(this,i,this.#s);if(await this.#o("beforeRun",o,s),s.isSkipped())return s.endTime=this.#s(),await this.#o("onSkip",o,s),await this.#o("afterRun",o,s),s.result;try{const r=await n(s);return s.result=r,s.status=A.SUCCESS,s.endTime=this.#s(),await this.#o("onSuccess",o,s),r}catch(r){throw s.error=r,s.status=A.ERROR,s.endTime=this.#s(),await this.#o("onError",o,s),r}finally{await this.#o("afterRun",o,s)}}getPlugins(){return[...this.#i]}static registerGlobal(t){return x.#t=t,t}static getGlobal(){return x.#t}static getOrCreateGlobal(t){return x.#t||(x.#t=new x(t)),x.#t}#n(){this.#i.sort((t,e)=>{const n=typeof t.priority=="number"?t.priority:100,i=typeof e.priority=="number"?e.priority:100;return n-i})}#d(t=[]){const e=[...this.#i];for(const n of t)if(!(!n||typeof n.name!="string")){if(e.some(i=>i.name===n.name)){this.#e?.warn?.(`[AsyncOrchestrator] Run-scoped plugin '${n.name}' ignored (duplicate name).`);continue}e.push(n)}return e.sort((n,i)=>{const o=typeof n.priority=="number"?n.priority:100,s=typeof i.priority=="number"?i.priority:100;return o-s}),e}async#o(t,e,n){if(et.includes(t))for(const i of e){const o=i[t];if(typeof o=="function")try{if(typeof i.supports=="function"){const r=i.supports(n);if(r===!1||r&&typeof r.then=="function"&&!await r)continue}const s=o.call(i,n);s&&typeof s.then=="function"&&await s}catch(s){this.#e?.warn?.(`[AsyncOrchestrator] Plugin '${i.name}' hook '${t}' failed:`,s)}}}}const G=Symbol("async.metrics.sample");class lt{constructor(t={}){this.name="metrics",this.priority=30,this.#n=t.metrics||null,this.#d=typeof t.sampleRate=="number"?t.sampleRate:1}supports(t){return!!this.#n&&this.#i(t)>0}beforeRun(t){const e=this.#t(t);t.attach(G,e),e&&(this.#n?.increment?.("async.started",1),this.#n?.increment?.(`async.${t.label}.started`,1))}onSuccess(t){this.#e(t)&&(this.#n?.increment?.("async.success",1),this.#n?.increment?.(`async.${t.label}.success`,1))}onError(t){if(!this.#e(t))return;const e=t.error&&t.error.name?t.error.name:"unknown_error";this.#n?.increment?.("async.failure",1),this.#n?.increment?.(`async.${t.label}.failure.${e}`,1)}afterRun(t){this.#e(t)&&(this.#n?.increment?.("async.completed",1),this.#n?.increment?.(`async.${t.label}.completed`,1),typeof t.durationMs=="number"&&(this.#n?.updateAverage?.("async.duration_ms",t.durationMs),this.#n?.updateAverage?.(`async.${t.label}.duration_ms`,t.durationMs)))}#t(t){const e=this.#i(t);return e>=1?!0:e<=0?!1:Math.random()<=e}#i(t){const e=t.options?.metricsSampleRate;if(typeof e=="number")return this.#s(e);const n=t.options?.policyOverrides?.observability?.metrics_sample_rate;return typeof n=="number"?this.#s(n):this.#s(this.#d)}#e(t){return!!t.getAttachment(G)}#s(t){return Number.isNaN(t)||t<=0?0:t>=1?1:t}#n;#d}const M=Symbol("async.forensic.envelope");class dt{constructor(t={}){this.name="forensic",this.priority=40,this.#t=t.forensicLogger||null}supports(t){const e=this.#t||t.options?.forensicLogger||t.options?.stateManager?.forensicLogger||t.options?.stateManager?.managers?.forensicLogger;return!!(e?.createEnvelope&&e?.commitEnvelope)}beforeRun(t){const e=this.#t||t.options?.forensicLogger||t.options?.stateManager?.forensicLogger||t.options?.stateManager?.managers?.forensicLogger;if(!e?.createEnvelope||!e.commitEnvelope)return;const n={label:t.label,meta:t.meta,tenantId:t.tenantId,actorId:t.actorId,startedAt:new Date().toISOString(),classification:{level:t.classification.level,compartments:Array.from(t.classification.compartments)},status:"pending"};try{const i=e.createEnvelope(t.eventType,n,{actorId:t.actorId,tenantId:t.tenantId});t.attach(M,{logger:e,envelopeTask:i,payload:n})}catch{}}onSuccess(t){const e=t.getAttachment(M);e&&(e.payload.status="success",e.payload.completedAt=new Date().toISOString(),e.payload.durationMs=t.durationMs)}onError(t){const e=t.getAttachment(M);e&&(e.payload.status="error",e.payload.completedAt=new Date().toISOString(),e.payload.durationMs=t.durationMs,t.error&&(e.payload.error={name:t.error.name,message:t.error.message}))}onSkip(t){const e=t.getAttachment(M);e&&(e.payload.status="skipped",e.payload.completedAt=new Date().toISOString(),e.payload.durationMs=t.durationMs)}async afterRun(t){const e=t.getAttachment(M);if(!e)return;t.deleteAttachment(M);const{logger:n,envelopeTask:i,payload:o}=e;if(!(!n?.commitEnvelope||!i))try{const s=await i;s&&s.payload&&Object.assign(s.payload,o),await n.commitEnvelope(s)}catch{}}#t}const N=Symbol("async.state.manager");class ht{constructor(t={}){this.name="state-events",this.priority=10,this.#i=t.stateManager||null}supports(t){return!!this.#t(t)?.emit}beforeRun(t){const e=this.#t(t);e?.emit&&(e.emit("async:start",{label:t.label,meta:t.meta}),t.attach(N,e))}afterRun(t){const e=t.getAttachment(N)||this.#t(t);e?.emit&&(t.deleteAttachment(N),e.emit("async:end",{label:t.label,status:t.status,durationMs:t.durationMs,errorName:t.error?.name}))}#t(t){return t.options?.stateManager||this.#i||null}#i}const W=new WeakMap;function ut(p,t){const e=p.metricsRegistry;if(e)return e;const n=t?.metricsRegistry||t?.managers?.metricsRegistry||null;if(!n)return null;if(typeof n.namespace=="function")try{const i=n.namespace("async");if(i)return i}catch{}return n}function pt(p={}){if(p.asyncOrchestrator instanceof x)return p.asyncOrchestrator;const t=p.asyncOrchestrator;if(t&&typeof t.getOrchestrator=="function"&&t.getOrchestrator()instanceof x)return t.getOrchestrator();const e=p.stateManager,n=e?.managers?.asyncOrchestrator;if(n?.getOrchestrator)return n.getOrchestrator();if(e){const s=W.get(e);if(s)return s;const r=new x({logger:e?.managers?.logger||console});r.registerPlugin(new ht({stateManager:e}));const l=p.forensicLogger||e?.forensicLogger||e?.managers?.forensicLogger||null;l&&r.registerPlugin(new dt({forensicLogger:l}));const a=ut(p,e);return a&&r.registerPlugin(new lt({metrics:a})),W.set(e,r),x.getGlobal()||x.registerGlobal(r),r}const i=x.getGlobal();if(i)return i;const o=new x({logger:console});return x.registerGlobal(o),o}function gt(p={}){const e=p.stateManager?.managers?.asyncOrchestrator;return e&&typeof e.run=="function"?e:null}class yt{static async wrap(t,e={}){const n=typeof t=="function"?t:()=>t,i=e.label||"async.operation";e.label||console.warn("[AsyncHelper.wrap] Missing label; defaulting to 'async.operation'."),e.stateManager||console.warn("[AsyncHelper.wrap] Missing stateManager; state events will not be emitted.");const o=gt(e),s={label:i,meta:{source:"AsyncHelper.wrap",...e.meta||{}},stateManager:e.stateManager,actorId:e.actorId,tenantId:e.tenantId,classification:e.classification,policyOverrides:e.policyOverrides,metricsSampleRate:e.metricsSampleRate,eventType:e.eventType};return o?.run?o.run(n,s):pt(e).run(n,s)}}class bt{#t;#i=null;#e=null;#s=null;#n;#d;#o=!1;#r=[];#h=null;#l=null;#a=null;#m=null;#c=null;constructor({stateManager:t,appViewModel:e},n={}){this.#t=t,this.#d=e||{},this.#e=this.#t.managers.toastManager,this.#s=this.#t.managers.aiLayoutAssistant,this.#i=this.#t.managers.enhancedGridRenderer,this.#h=this.#t.managers.gridPolicyService;try{this.#l=new U({stateManager:this.#t})}catch{}this.#n={gridContainer:".grid-container",enablePolicies:!0,enableToasts:!0,enableAI:!0,enableAnalytics:!0,enableNesting:!1,...n}}async initialize(){if(!this.#o)try{this.#n.enablePolicies&&this.#h&&await this.#h.registerGridPolicies({includeNesting:!!this.#n.enableNesting}),await this.#_(),this.#f(),this.#n.enableAnalytics&&(this.#B(),this.#H());try{this.#n.enableHistoryInspector!==!1&&(this.#c=new Y({stateManager:this.#t}),this.#c.initialize())}catch{}try{this.#z()}catch{}try{const t=e=>this.#x(e||{});this.#r.push(this.#t.on("gridAddBlockRequested",t))}catch{}this.#o=!0,console.log("Complete Grid System initialized with all features"),this.#e&&this.#e.success("🎯 Enhanced grid system ready",3e3)}catch(t){console.error("Failed to initialize complete grid system:",t),this.#e&&this.#e.error("Failed to initialize grid enhancements",5e3)}}#x(t){try{String(t.mode||"modal")==="add"?this.#p():this.#u()}catch{}}#p(){try{const t=this.#a||{blocks:[]},e=Number(this.#t?.managers?.policies?.getPolicy("grid","default_columns")??24),n=6,i=4,o=Math.max(0,Math.floor((e-n)/2)),s=t.blocks.reduce((l,a)=>Math.max(l,(a.y??0)+(a.h??0)),0),r={id:`block_${Date.now()}`,type:"block",x:o,y:s,w:n,h:i,constraints:{minW:2,minH:2,maxW:e,maxH:1e3},props:{title:"Block",body:"New"}};t.blocks.push(r),this.#P(r),this.saveRuntimeConfig("dev-default").catch(()=>{})}catch{}}#P(t){const e=document.querySelector(this.#n.gridContainer)||document.querySelector(".grid-container")||document.body,n=document.createElement("div");n.className="grid-block",n.dataset.blockId=t.id,n.dataset.minW=String(t.constraints.minW),n.dataset.minH=String(t.constraints.minH),n.dataset.maxW=String(t.constraints.maxW),n.dataset.maxH=String(t.constraints.maxH);const i=document.createElement("div");i.className="grid-block-content",n.appendChild(i),e.appendChild(n);try{I.mount(t.type,i,t.props||{},{stateManager:this.#t,appViewModel:this.#d,parentConfigId:"dev-default",blockId:t.id})}catch{}this.#i?.updateBlockPosition?.(t.id,t.x,t.y,t.w,t.h)}#u(){const t=document.getElementById("grid-add-modal");t&&t.remove();const e=document.createElement("div");e.id="grid-add-modal",e.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:20000;display:flex;align-items:center;justify-content:center;";const n=document.createElement("div");n.style.cssText="background:#fff;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,0.3);width:420px;max-width:90vw;padding:16px;";const i=document.createElement("h3");i.style.margin="0 0 10px",i.textContent="Add Grid Block";const o=document.createElement("label");o.style.display="block",o.style.marginBottom="8px";const s=document.createElement("span");s.textContent="Component Type";const r=document.createElement("select");r.id="gb-type",r.style.width="100%",r.style.padding="8px",r.style.marginTop="4px",[["block","Block"],["text","Text"],["html","HTML"]].forEach(([y,m])=>{const f=document.createElement("option");f.value=y,f.textContent=m,r.appendChild(f)}),o.appendChild(s),o.appendChild(r);const l=document.createElement("label");l.style.display="block",l.style.marginBottom="8px";const a=document.createElement("span");a.textContent="Title/Text";const d=document.createElement("input");d.id="gb-title",d.type="text",d.style.width="100%",d.style.padding="8px",d.style.marginTop="4px",d.placeholder="Title or text",l.appendChild(a),l.appendChild(d);const g=document.createElement("div");g.style.display="flex",g.style.gap="8px",g.style.justifyContent="flex-end",g.style.marginTop="12px";const h=document.createElement("button");h.id="gb-cancel",h.style.padding="8px 12px",h.textContent="Cancel";const c=document.createElement("button");c.id="gb-add",c.style.padding="8px 12px",c.style.background="#2b7cff",c.style.color="#fff",c.style.border="0",c.style.borderRadius="6px",c.textContent="Add",g.appendChild(h),g.appendChild(c),n.appendChild(i),n.appendChild(o),n.appendChild(l),n.appendChild(g),e.appendChild(n),document.body.appendChild(e);const u=()=>e.remove();e.addEventListener("click",y=>{y.target===e&&u()}),n.querySelector("#gb-cancel").addEventListener("click",u),n.querySelector("#gb-add").addEventListener("click",()=>{try{const y=n.querySelector("#gb-type").value,m=n.querySelector("#gb-title").value||(y==="text"?"Text":"Block"),f=Number(this.#t?.managers?.policies?.getPolicy("grid","default_columns")??24),w=6,b=4,C=Math.max(0,Math.floor((f-w)/2)),v=(this.#a?.blocks||[]).reduce((L,P)=>Math.max(L,(P.y??0)+(P.h??0)),0),k=y==="block"?{title:m,body:""}:y==="text"?{value:m}:{html:m},_={id:`block_${Date.now()}`,type:y,x:C,y:v,w,h:b,constraints:{minW:2,minH:2,maxW:f,maxH:1e3},props:k};this.#a=this.#a||{blocks:[]},this.#a.blocks.push(_),this.#P(_),this.saveRuntimeConfig("dev-default").catch(()=>{}),u()}catch{u()}})}async setRuntimeConfig(t,e="default",n=null,i=0){try{let l=function(h,c){const u=h.x+h.w-1,y=c.x+c.w-1,m=h.y+h.h-1,f=c.y+c.h-1,w=!(u<c.x||y<h.x),b=!(m<c.y||f<h.y);return w&&b};const o=Number(this.#t?.managers?.policies?.getPolicy("grid","nesting_max_depth")??3);if(i>o){console.warn(`[Grid] Max nesting depth of ${o} exceeded. Aborting render.`);const h=document.querySelector(this.#n.gridContainer)||document.body;h.textContent="[max nesting depth exceeded]";return}this.#a=B(t);try{const h=this.#t?.managers?.policies?.getPolicy("grid","allowed_component_types");Array.isArray(h)&&h.length&&I.setAllowedTypes(h)}catch{}const s=document.querySelector(this.#n.gridContainer)||document.querySelector(".grid-container")||document.body;for(;s.firstChild;)s.removeChild(s.firstChild);const r=new Set;this.#a.blocks=this.#a.blocks.filter(h=>r.has(h.id)?(console.warn(`[Grid] Duplicate block ID found and removed: ${h.id}`),!1):(r.add(h.id),!0));const a=[];for(const h of this.#a.blocks)a.some(c=>l(c,h))||a.push(h);this.#a.blocks=a;const g=(()=>{if(!this.#a?.templates)return this.#a.blocks;const h=this.#S(window.innerWidth);return this.#a.templates?.[h]?.blocks||this.#a.blocks})();for(const h of g){const c=document.createElement("div");c.className="grid-block",c.dataset.blockId=h.id,c.dataset.minW=String(h.constraints.minW),c.dataset.minH=String(h.constraints.minH),c.dataset.maxW=String(h.constraints.maxW),c.dataset.maxH=String(h.constraints.maxH);const u=document.createElement("div");u.className="grid-block-content",c.appendChild(u),s.appendChild(c);try{await I.mount(h.type,u,h.props||{},{stateManager:this.#t,appViewModel:this.#d,parentConfigId:e,blockId:h.id,depth:i+1})}catch{}try{this.#m&&h?.nestedGrid&&this.#t?.managers?.policies?.getPolicy("grid","nesting_enabled")&&await this.#m.attach(c,this.#d,h.nestedGrid,i)}catch{}}this.#i?.refresh?this.#i.refresh():this.#i?.initialize&&await this.#i.initialize({container:s,appViewModel:this.#d}),await this.loadRuntimeLayout(e,n),this.#g(e)}catch(o){console.warn("[Grid] setRuntimeConfig failed:",o)}}async saveRuntimeConfig(t="default",e=null){S.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});try{if(!this.#l||!this.#a)return;const n=e||this.#v();try{await this.#l.saveConfig(t,this.#a,n)}catch(i){if(i?.name==="ConstraintError")await this.#l.deleteConfig(t,n),await this.#l.saveConfig(t,this.#a,n);else throw i}await this.#l.saveConfig(t,this.#a,n)}catch(n){console.warn("[Grid] saveRuntimeConfig failed:",n)}}async loadRuntimeConfig(t="default",e=null){try{if(!this.#l)return;const n=e||this.#v(),i=await this.#l.loadConfig(t,n);i?await this.setRuntimeConfig(i,t,n):console.warn("[Grid] No runtime config found for id",t)}catch(n){console.warn("[Grid] loadRuntimeConfig failed:",n)}}#S(t){return t>=1400?"xxl":t>=1200?"xl":t>=992?"lg":t>=768?"md":t>=576?"sm":"xs"}#g(t){if(!this.#a?.templates)return;let e=this.#S(window.innerWidth);const n=()=>{const i=this.#S(window.innerWidth);if(i===e)return;e=i;const o=this.#a.templates?.[i];if(!o?.blocks||!this.#i?.updateBlockPosition)return;const s=()=>{for(const r of o.blocks)this.#i.updateBlockPosition(r.id,r.x,r.y,r.w,r.h);this.saveRuntimeLayout(t).catch(()=>{})};typeof this.#t?.transaction=="function"?this.#t.transaction(s):s()};window.addEventListener("resize",n),this.#r.push(()=>window.removeEventListener("resize",n))}async saveRuntimeLayout(t="default",e=null,n=null){S.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});try{if(!this.#l)return;const i=async()=>{const o=n||this.#i?.getCurrentLayout?.();if(!o)return;const s=e||this.#v();try{await this.#l.save(t,o,s)}catch(r){if(r?.name==="ConstraintError")await this.#l.delete(t,s),await this.#l.save(t,o,s);else throw r}};await yt.wrap(i(),{stateManager:this.#t,label:"grid:layoutSave"})}catch(i){console.warn("[Grid] saveRuntimeLayout failed:",i)}}async loadRuntimeLayout(t="default",e=null){try{if(!this.#l||!this.#i)return;const n=e||this.#v(),i=await this.#l.load(t,n);if(!i?.blocks||!Array.isArray(i.blocks))return;const o=i.blocks.map(r=>({blockId:r.blockId,x:r.position?.x??r.x,y:r.position?.y??r.y,w:r.position?.w??r.w,h:r.position?.h??r.h})),s=()=>{this.#i.updateBlockPosition&&o.forEach(r=>{this.#i.updateBlockPosition(r.blockId,r.x,r.y,r.w,r.h)})};typeof this.#t?.transaction=="function"?this.#t.transaction(s):s()}catch(n){console.warn("[Grid] loadRuntimeLayout failed:",n)}}#v(){try{const t=this.#t?.managers?.securityManager?.getSubject?.()||{},e=String(this.#t?.managers?.policies?.getPolicy("system","grid_auto_save_layout_scope")||"tenant").toLowerCase();return e==="user"?{tenantId:t.tenantId,userId:t.userId}:e==="tenant"?{tenantId:t.tenantId,userId:"tenant"}:{tenantId:"global",userId:"global"}}catch{return{tenantId:"public",userId:"anon"}}}async#_(){if(!this.#i)throw new Error("EnhancedGridRenderer not available from state manager.");if(await this.#i.initialize({container:document.querySelector(this.#n.gridContainer),appViewModel:this.#d}),this.#t.on&&(this.#r.push(this.#t.on("layoutChanged",this.#M.bind(this))),this.#r.push(this.#t.on("grid:layoutChange",e=>{try{const n=this.#t?.managers?.policies;if(!n?.getPolicy?.("system","grid_auto_save_layouts"))return;const o=n?.getPolicy?.("system","grid_save_feedback"),s=n?.getPolicy?.("system","grid_auto_save_layout_id")||"default",r=this.#v(),l=e&&typeof e=="object"&&e.layout&&typeof e.layout=="object"?e.layout:null;this.saveRuntimeLayout(s,r,l).then(()=>{o&&this.#e&&this.#e.success("Layout auto-saved",1500)}).catch(()=>{})}catch{}}))),this.#t.on&&(this.#r.push(this.#t.on("gridEnhanced",this.#F.bind(this))),this.#r.push(this.#t.on("gridPerformanceMode",this.#L.bind(this))),this.#r.push(this.#t.on("gridColumnsChanged",e=>{if(e&&this.#e){const n=Number.isFinite(e.clampedCount)&&e.clampedCount>0,i=n?`Grid columns set to ${e.columns}. Adjusted ${e.clampedCount} blocks to fit.`:`Grid columns set to ${e.columns}.`,o=n?"warning":"info";this.#e[o](i,2500)}})),this.#n.enableAI&&this.#r.push(this.#t.on("aiLayoutSuggestions",this.#I.bind(this)))),this.#t.on){const e=n=>{try{if(n?.type!=="policy_updated")return;const{domain:i,key:o,newValue:s}=n.data||{};i==="grid"&&o==="allowed_component_types"&&Array.isArray(s)&&I.setAllowedTypes(s),i==="grid"&&o==="default_columns"&&Number.isInteger(s)&&this.#i?.setGridColumns?.(s)}catch{}};this.#r.push(this.#t.on("policyEvent",e))}const t=e=>{if(!e.ctrlKey&&!e.metaKey)return;const n=e.key?.toLowerCase();n==="z"&&(e.preventDefault(),this.undoLayoutChange()),n==="y"&&(e.preventDefault(),this.redoLayoutChange())};document.addEventListener("keydown",t),this.#r.push(()=>document.removeEventListener("keydown",t))}#M(t){this.#t.recordOperation({type:"grid_layout_change",data:t}),this.#n.enableAnalytics&&this.#A(t)}#F(t){console.log("Grid enhancement active"),this.#T()}#L(t){console.log("Performance mode changed:",t),this.#n.enableAnalytics&&this.#G(t)}#I(t){console.log("AI suggestions received:",t.suggestions),this.#e&&this.#e.info(`💡 ${t.suggestions.length} layout suggestions available`,5e3)}#f(){const t=this.#y(),e=document.querySelector(".sidebar");e?e.appendChild(t):(t.style.cssText=`
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        padding: 16px;
        z-index: 1000;
        max-width: 250px;
      `,document.body.appendChild(t))}undoLayoutChange(){try{typeof this.#t?.history?.undo=="function"?(this.#t.history.undo(),this.#e&&this.#e.info("Undo layout change",1500),this.#t.emit("layoutRestored",{action:"undo",timestamp:Date.now()})):this.#e&&this.#e.warning("Undo history not available",2e3)}catch{this.#e?.error("Undo failed",2500)}}redoLayoutChange(){try{typeof this.#t?.history?.redo=="function"?(this.#t.history.redo(),this.#e&&this.#e.info("Redo layout change",1500),this.#t.emit("layoutRestored",{action:"redo",timestamp:Date.now()})):this.#e&&this.#e.warning("Redo history not available",2e3)}catch{this.#e?.error("Redo failed",2500)}}#y(){S.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});const t=document.createElement("div");t.className="grid-policy-panel";const e=document.createElement("h4");e.textContent="Grid Settings",t.appendChild(e);const n=(b,C,v)=>{const k=document.createElement("div");k.className="policy-control";const _=document.createElement("label"),L=document.createElement("input");if(L.type="checkbox",L.id=b,_.appendChild(L),_.appendChild(document.createTextNode(" "+C)),k.appendChild(_),v){const P=document.createElement("small");P.textContent=v,k.appendChild(P)}return k};t.appendChild(n("perf-mode-toggle","Performance Mode","Override automatic FPS-based switching")),t.appendChild(n("auto-save-toggle","Auto-save Layouts")),t.appendChild(n("save-feedback-toggle","Save Notifications")),t.appendChild(n("ai-suggestions-toggle","AI Suggestions")),t.appendChild(document.createElement("hr"));const i=document.createElement("h5");i.textContent="Tenant Overrides",t.appendChild(i);const o=document.createElement("small");o.textContent="Applies only to this tenant. Use Revert to return to global policy.",t.appendChild(o);const s=document.createElement("div");s.className="policy-control",s.style.cssText="margin-top:8px; display:flex; align-items:center; gap:8px;";const r=document.createElement("label");r.style.minWidth="150px",r.textContent="Performance Mode";const l=document.createElement("select");l.id="tenant-perf-mode",[["auto","Use Global / Auto"],["on","Force On"],["off","Force Off"]].forEach(([b,C])=>{const v=document.createElement("option");v.value=b,v.textContent=C,l.appendChild(v)});const a=document.createElement("button");a.id="tenant-perf-revert",a.className="btn-secondary",a.style.marginLeft="auto",a.textContent="Revert",s.appendChild(r),s.appendChild(l),s.appendChild(a),t.appendChild(s);const d=document.createElement("div");d.className="policy-control",d.style.cssText="display:flex; align-items:center; gap:8px;";const g=document.createElement("label");g.style.minWidth="150px";const h=document.createElement("input");h.type="checkbox",h.id="tenant-auto-save-toggle",g.appendChild(h),g.appendChild(document.createTextNode(" Auto-save Layouts"));const c=document.createElement("button");c.id="tenant-auto-save-revert",c.className="btn-secondary",c.style.marginLeft="auto",c.textContent="Revert",d.appendChild(g),d.appendChild(c),t.appendChild(d);const u=document.createElement("div");u.className="policy-control",u.style.cssText="display:flex; align-items:center; gap:8px;";const y=document.createElement("label");y.style.minWidth="150px";const m=document.createElement("input");m.type="checkbox",m.id="tenant-save-feedback-toggle",y.appendChild(m),y.appendChild(document.createTextNode(" Save Notifications"));const f=document.createElement("button");if(f.id="tenant-save-feedback-revert",f.className="btn-secondary",f.style.marginLeft="auto",f.textContent="Revert",u.appendChild(y),u.appendChild(f),t.appendChild(u),this.#n.enableNesting){const b=document.createElement("div");b.className="policy-control",b.style.cssText="display:flex; align-items:center; gap:8px;";const C=document.createElement("label");C.style.minWidth="150px";const v=document.createElement("input");v.type="checkbox",v.id="tenant-nesting-toggle",C.appendChild(v),C.appendChild(document.createTextNode(" Enable Nesting"));const k=document.createElement("button");k.id="tenant-nesting-revert",k.className="btn-secondary",k.style.marginLeft="auto",k.textContent="Revert",b.appendChild(C),b.appendChild(k),t.appendChild(b)}const w=document.createElement("button");return w.id="reset-policies",w.className="btn-secondary",w.textContent="Reset to Defaults",t.appendChild(w),this.#R(t),this.#E(t),this.#b(t),t}#R(t){const e=t.querySelector("#perf-mode-toggle"),n=t.querySelector("#auto-save-toggle"),i=t.querySelector("#save-feedback-toggle"),o=t.querySelector("#ai-suggestions-toggle"),s=t.querySelector("#reset-policies");e.addEventListener("change",async r=>{const l=r.target.checked?!0:null;await this.#k("system.grid_performance_mode",l)}),n.addEventListener("change",async r=>{await this.#k("system.grid_auto_save_layouts",r.target.checked)}),i.addEventListener("change",async r=>{await this.#k("system.grid_save_feedback",r.target.checked)}),o.addEventListener("change",async r=>{await this.#k("system.grid_ai_suggestions",r.target.checked),r.target.checked&&!this.#s&&(this.#s=this.#t.managers.aiLayoutAssistant)}),s.addEventListener("click",()=>{this.#N()})}#E(t){const e=this.#h;if(!e)return;const n=t.querySelector("#tenant-perf-mode"),i=t.querySelector("#tenant-perf-revert"),o=t.querySelector("#tenant-auto-save-toggle"),s=t.querySelector("#tenant-auto-save-revert"),r=t.querySelector("#tenant-save-feedback-toggle"),l=t.querySelector("#tenant-save-feedback-revert"),a=t.querySelector("#tenant-nesting-toggle"),d=t.querySelector("#tenant-nesting-revert"),g=this.#e,h=u=>g?.success?.(u,1500),c=u=>g?.error?.(u,2500);n?.addEventListener("change",async u=>{const y=String(u.target.value),m=y==="on"?!0:y==="off"?!1:null;try{await e.setTenantPolicy("grid","performance_mode",m),h?.("Tenant performance updated")}catch{c?.("Failed to update")}}),i?.addEventListener("click",async()=>{try{await e.setTenantPolicy("grid","performance_mode",null),n&&(n.value="auto"),h?.("Reverted to global")}catch{c?.("Failed to revert")}}),o?.addEventListener("change",async u=>{try{await e.setTenantPolicy("grid","auto_save_layouts",!!u.target.checked),h?.("Tenant auto-save updated")}catch{c?.("Failed to update")}}),s?.addEventListener("click",async()=>{try{await e.setTenantPolicy("grid","auto_save_layouts",null),o&&(o.checked=!1),h?.("Reverted to global")}catch{c?.("Failed to revert")}}),r?.addEventListener("change",async u=>{try{await e.setTenantPolicy("grid","save_feedback",!!u.target.checked),h?.("Tenant save-feedback updated")}catch{c?.("Failed to update")}}),l?.addEventListener("click",async()=>{try{await e.setTenantPolicy("grid","save_feedback",null),r&&(r.checked=!1),h?.("Reverted to global")}catch{c?.("Failed to revert")}}),a&&d&&(a.addEventListener("change",async u=>{try{await e.setTenantPolicy("grid","nesting_enabled",!!u.target.checked),h?.("Tenant nesting updated")}catch{c?.("Failed to update")}}),d.addEventListener("click",async()=>{try{await e.setTenantPolicy("grid","nesting_enabled",null),a.checked=!1,h?.("Reverted to global")}catch{c?.("Failed to revert")}}))}#z(){const t=async e=>{const n=i=>this.#e?.error?.(i,2500);try{if(!e||e.type!=="tenant_policy_updated"&&e.type!=="policy_updated")return;const{domain:i,key:o,newValue:s}=e.data||{};if(i!=="grid"||o!=="nesting_enabled")return;if(!!(s??this.#t?.managers?.policies?.getPolicy("grid","nesting_enabled"))){if(await this.#h?.registerGridPolicies?.({includeNesting:!0}),!this.#m){const l=await D(()=>Promise.resolve().then(()=>mt),void 0,import.meta.url);this.#m=new l.NestedGridManager({stateManager:this.#t})}}else{try{this.#m?.detachAll?.()}catch{n?.("Failed to update")}this.#m=null}}catch{}};this.#r.push(this.#t.on("policyEvent",t))}async#k(t,e){try{const[n,i]=t.split(".");await this.#t.managers.policies.setPolicy(n,i,e),this.#e&&this.#e.success(`Policy updated: ${t}`,2e3)}catch(n){console.error("Failed to set policy:",n),this.#e&&this.#e.error(`Failed to update policy: ${t}`,3e3)}}#b(t){try{const e=this.#h?this.#h.getGridPolicies():{performanceMode:null,autoSave:!0,saveFeedback:!0,aiSuggestions:!1};t.querySelector("#perf-mode-toggle").checked=e.performanceMode===!0,t.querySelector("#auto-save-toggle").checked=e.autoSave,t.querySelector("#save-feedback-toggle").checked=e.saveFeedback,t.querySelector("#ai-suggestions-toggle").checked=e.aiSuggestions;const n=t.querySelector("#tenant-perf-mode");n&&(n.value=e.performanceMode===!0?"on":e.performanceMode===!1?"off":"auto");const i=t.querySelector("#tenant-auto-save-toggle");i&&(i.checked=!!e.autoSave);const o=t.querySelector("#tenant-save-feedback-toggle");o&&(o.checked=!!e.saveFeedback);const s=t.querySelector("#tenant-nesting-toggle");s&&(s.checked=!!this.#t?.managers?.policies?.getPolicy("grid","nesting_enabled"))}catch(e){console.warn("Could not load current policy states:",e)}}#T(){try{const t=this.#h?this.#h.getGridPolicies():{performanceMode:null,autoSave:!0,saveFeedback:!0,aiSuggestions:!1};if(console.log("Current Grid Policies:",t),this.#e){const e=[];t.performanceMode===!0&&e.push("🚀 Performance mode forced"),t.performanceMode===!1&&e.push("✨ Full features forced"),t.autoSave||e.push("⚠️ Auto-save disabled"),t.aiSuggestions&&e.push("🤖 AI suggestions enabled"),e.length>0&&this.#e.info(e.join(" • "),4e3)}}catch(t){console.warn("Could not show policy status:",t)}}#B(){this.#t.eventFlowEngine&&(this.#r.push(this.#t.eventFlowEngine.on("layoutChanged",t=>{this.#A(t)})),this.#r.push(this.#t.eventFlowEngine.on("gridPerformanceMode",t=>{this.#G(t)})),this.#r.push(this.#t.eventFlowEngine.on("policyChanged",t=>{t.domain==="system"&&t.key.startsWith("grid_")&&this.#U(t)})))}#H(){try{const t=document.createElement("div");t.id="grid-analytics-panel",t.style.cssText=`
				position: fixed; right: 20px; top: 20px; z-index: 10000;
				background: rgba(20,20,20,0.85); color: #fff; padding: 10px 12px; border-radius: 8px;
				font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
				display: none; min-width: 180px; box-shadow: 0 6px 18px rgba(0,0,0,0.3);
			`;const e=document.createElement("div");e.style.cssText="display:flex;justify-content:space-between;align-items:center;gap:6px;margin-bottom:6px;";const n=document.createElement("strong");n.textContent="Grid Analytics";const i=document.createElement("button");i.id="ga-close",i.style.cssText="background:#444;color:#fff;border:0;border-radius:4px;padding:2px 6px;cursor:pointer",i.textContent="×",e.appendChild(n),e.appendChild(i),t.appendChild(e);const o=document.createElement("div");o.appendChild(document.createTextNode("FPS: "));const s=document.createElement("span");s.id="ga-fps",s.textContent="—",o.appendChild(s),t.appendChild(o);const r=document.createElement("div");r.appendChild(document.createTextNode("Blocks: "));const l=document.createElement("span");l.id="ga-blocks",l.textContent="—",r.appendChild(l),t.appendChild(r);const a=document.createElement("div");a.appendChild(document.createTextNode("Visible: "));const d=document.createElement("span");d.id="ga-visible",d.textContent="—",a.appendChild(d),t.appendChild(a);const g=document.createElement("div");g.style.marginTop="6px",g.style.opacity="0.8",g.textContent="Toggle: Alt+G",t.appendChild(g),document.body.appendChild(t);const h=()=>t.style.display="none";t.querySelector("#ga-close").addEventListener("click",h);const c=f=>{f.altKey&&f.key?.toLowerCase()==="g"&&(f.preventDefault(),t.style.display=t.style.display==="none"?"block":"none")};document.addEventListener("keydown",c),this.#r.push(()=>document.removeEventListener("keydown",c));const u=(f,w)=>{const b=t.querySelector(f);b&&(b.textContent=String(w))},y=({fps:f})=>u("#ga-fps",f??"—"),m=({inView:f,total:w})=>{u("#ga-visible",f??"—"),u("#ga-blocks",w??"—")};this.#r.push(this.#t.on("gridFps",y)),this.#r.push(this.#t.on("gridBlockVisibility",m))}catch{}}#A(t){const e={category:"grid_interaction",action:t.changeType,label:t.blockId,value:1,customDimensions:{userId:t.userId,autoSaved:t.autoSaved,position:`${t.position.x},${t.position.y}`,size:`${t.position.w}x${t.position.h}`}};this.#t.eventFlowEngine&&this.#t.eventFlowEngine.emit("analyticsEvent",e)}#G(t){this.#t.eventFlowEngine&&this.#t.eventFlowEngine.emit("analyticsEvent",{category:"grid_performance",action:t.enabled?"performance_mode_on":"performance_mode_off",label:t.reason,value:t.fps||0})}#U(t){this.#t.eventFlowEngine&&this.#t.eventFlowEngine.emit("analyticsEvent",{category:"grid_policy",action:"policy_changed",label:t.key,value:t.value?1:0})}#N(){Object.entries({grid_performance_mode:null,grid_auto_save_layouts:!0,grid_save_feedback:!0,grid_ai_suggestions:!1}).forEach(async([e,n])=>{await this.#k(`system.${e}`,n)}),this.#e&&this.#e.success("Grid policies reset to defaults",3e3)}isInitialized(){return this.#o}destroy(){this.#i&&this.#i.disable(),this.#e&&this.#e.destroy(),this.#r.forEach(t=>t()),this.#r=[]}}class q{#t;#i;#e=new Map;constructor({stateManager:t}){this.#t=t,this.#i=t?.managers?.policies}async attach(t,e,n={},i=0){try{if(!t||!t.classList?.contains("grid-block")||!this.#s())return;const o=this.#n("grid","nesting_max_depth",2);if(i>=o)return;const s=document.createElement("div");s.className="grid-container nested-grid",s.dataset.nestingDepth=String(i+1),s.style.marginTop="8px",s.style.borderTop="1px dashed rgba(0,0,0,0.1)",(t.querySelector(".grid-block-content")||t).appendChild(s);const l=this.#n("grid","nesting_max_blocks_per_grid",24),a=Array.isArray(n?.blocks)?n.blocks.slice(0,l):[],d=this.#t.managers?.enhancedGridRenderer||this.#t.serviceRegistry?.createNamespacedInstance?.("enhancedGridRenderer",{stateManager:this.#t});if(!d)return;await d.initialize({container:s,appViewModel:e}),this.#e.set(s,d);const g=Number(n?.columns);Number.isInteger(g)&&g>0&&d.setGridColumns?.(g);for(const h of a){const c=document.createElement("div");c.className="grid-block",c.dataset.blockId=h.id,c.dataset.minW=String(h.constraints?.minW??1),c.dataset.minH=String(h.constraints?.minH??1),c.dataset.maxW=String((h.constraints?.maxW??g)||24),c.dataset.maxH=String(h.constraints?.maxH??1e3);const u=document.createElement("div");u.className="grid-block-content",c.appendChild(u),s.appendChild(c),h.nestedGrid&&await this.attach(c,e,h.nestedGrid,i+1)}for(const h of a)d.updateBlockPosition?.(h.id,h.x,h.y,h.w,h.h)}catch{}}detachAll(){try{for(const[t,e]of this.#e.entries()){try{e?.destroy?.()}catch{}try{t.parentElement?.removeChild(t)}catch{}}this.#e.clear()}catch{}}#s(){try{return!!this.#i?.getPolicy("grid","nesting_enabled")}catch{return!1}}#n(t,e,n){try{const i=this.#i?.getPolicy(t,e);return Number.isFinite(i)?i:n}catch{return n}}}const mt=Object.freeze(Object.defineProperty({__proto__:null,NestedGridManager:q,default:q},Symbol.toStringTag,{value:"Module"}));export{x as A,bt as C,T as D,K as E,dt as F,lt as M,ht as S,D as _,yt as a};
