import{F as _}from"./platform-BD71WT6-.js";import"./grid-B-dIn7M-.js";class u{constructor(t){if(this.opt={overscan:6,recycle:!0,keyboard:!0,stickyHeader:!1,...t},!this.opt.container)throw new Error("VirtualList: container required");if(!this.opt.count||!this.opt.render)throw new Error("VirtualList: count/render required");if(!this.opt.itemHeight&&!this.opt.itemSize)throw new Error("VirtualList: provide itemHeight or itemSize()");this._root=this.opt.container,this._root.setAttribute("role","list"),this._root.tabIndex=this._root.tabIndex||0,this._root.style.overflow=this._root.style.overflow||"auto",this._root.style.position=this._root.style.position||"relative",this._viewportH=this._root.clientHeight,this._scrollTop=0,this._pool=[],this._inUse=new Map,this._keys=new Map,this._raf=0,this._mounted=!1,this._spacer=document.createElement("div"),this._spacer.style.position="relative",this._spacer.style.width="1px",this._spacer.style.height="0px",this.opt.stickyHeader&&(this._header=document.createElement("div"),this._header.style.position="sticky",this._header.style.top="0",this._header.style.zIndex="1",this._header.style.willChange="transform",this._root.appendChild(this._header),this.opt.renderHeader&&this.opt.renderHeader(this._header)),this._root.appendChild(this._spacer),this._onScroll=this._onScroll.bind(this),this._onResize=this._onResize.bind(this),this._onKey=this._onKey.bind(this),this._resizeObs=new ResizeObserver(this._onResize),this._resizeObs.observe(this._root)}mount(){this._mounted||(this._mounted=!0,this._root.addEventListener("scroll",this._onScroll,{passive:!0}),this.opt.keyboard&&this._root.addEventListener("keydown",this._onKey),this._syncTotalHeight(),this._schedule())}unmount(){if(this._mounted){this._mounted=!1,this._root.removeEventListener("scroll",this._onScroll),this._root.removeEventListener("keydown",this._onKey),this._resizeObs.disconnect(),cancelAnimationFrame(this._raf);for(const[,t]of this._inUse)t.remove();this._inUse.clear(),this._pool.length=0,this._keys.clear(),this._spacer.remove(),this._header&&this._header.remove()}}refresh(){this._syncTotalHeight(),this._schedule()}scrollToIndex(t,e="start"){const s=this._offsetOf(t),i=this._sizeOf(t),h=this._root.clientHeight;e==="center"?this._root.scrollTop=Math.max(0,s-(h-i)/2):e==="end"?this._root.scrollTop=Math.max(0,s-(h-i)):this._root.scrollTop=s}_onScroll(){this._scrollTop=this._root.scrollTop,this._schedule()}_onResize(){const t=this._root.clientHeight;t!==this._viewportH&&(this._viewportH=t,this._schedule())}_schedule(){this._raf&&cancelAnimationFrame(this._raf),this._raf=requestAnimationFrame(()=>this._update())}_update(){_.createEnvelope({actorId:"system",action:"<auto>",target:"<unknown>",label:"unclassified"});const t=this.opt.count(),e=this._scrollTop,s=e+this._viewportH,i=this._findFirstIndexAtOrAbove(e),h=this._findLastIndexAtOrBelow(s),c=this.opt.overscan,n=Math.max(0,i-c),l=Math.min(t-1,h+c);for(const[o,a]of this._inUse)(o<n||o>l)&&(this._inUse.delete(o),this.opt.recycle?this._pool.push(a):a.remove());for(let o=n;o<=l;o++){if(this._inUse.has(o))continue;const a=this.opt.keyOf?.(o);let r=a!=null?this._keys.get(a):void 0;r&&r.parentElement!==this._spacer&&(r=void 0),r||(r=this._pool.pop()||this._makeItem()),r.style.position="absolute",r.style.left="0",r.style.right="0",r.style.transform=`translateY(${this._offsetOf(o)}px)`,r.style.height=this._sizeOf(o)+"px",r.dataset.index=String(o),this.opt.render(r,o),this._spacer.appendChild(r),this._inUse.set(o,r),a!=null&&this._keys.set(a,r)}}_makeItem(){const t=document.createElement("div");return t.setAttribute("role","listitem"),t.style.willChange="transform",t.style.contain="content",t}_syncTotalHeight(){const t=this.opt.count(),e=this._offsetOf(t);this._spacer.style.height=e+"px"}_sizeOf(t){return t<0?0:this.opt.itemHeight??this.opt.itemSize(t)}_offsetOf(t){if(t<=0)return 0;if(this.opt.itemHeight)return t*this.opt.itemHeight;let e=0;for(let s=0;s<t;s++)e+=this.opt.itemSize(s);return e}_findFirstIndexAtOrAbove(t){const e=this.opt.count();if(this.opt.itemHeight)return Math.min(e-1,Math.floor(t/this.opt.itemHeight));let s=0;for(let i=0;i<e;i++){if(s+this._sizeOf(i)>t)return i;s+=this._sizeOf(i)}return Math.max(0,e-1)}_findLastIndexAtOrBelow(t){const e=this.opt.count();if(this.opt.itemHeight)return Math.max(0,Math.min(e-1,Math.floor(t/this.opt.itemHeight)));let s=0;for(let i=0;i<e;i++){const h=s+this._sizeOf(i);if(h>=t)return i;s=h}return Math.max(0,e-1)}_onKey(t){const e=this.opt.count();if(!e)return;const s=Number(this._root.querySelector('[data-index-focus="1"]')?.dataset.index??-1),i=[...this._inUse.keys()].sort((o,a)=>o-a),h=i[0]??0,c=i[i.length-1]??0;let n=s;switch(t.key){case"ArrowDown":n=Math.min(e-1,s>=0?s+1:h);break;case"ArrowUp":n=Math.max(0,s>=0?s-1:c);break;case"PageDown":n=Math.min(e-1,c);break;case"PageUp":n=Math.max(0,h);break;case"Home":n=0;break;case"End":n=e-1;break;default:return}t.preventDefault(),this.scrollToIndex(n,"start");const l=this._inUse.get(n);l&&(this._root.querySelectorAll('[data-index-focus="1"]').forEach(o=>o.removeAttribute("data-index-focus")),l.setAttribute("data-index-focus","1"),l.focus?.())}}export{u as VirtualList,u as default};
